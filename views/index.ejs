<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J-KIT | Find Gigs & Talent in Namibia</title>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* --- J-KIT STYLES --- */

        /* 1. Foundational & Global Styles */
        :root {
            --jkit-primary: #0052cc;
            --jkit-secondary: red;
            --jkit-dark: #1e1e2f;
            --jkit-dark-alt: #08090d;
            --jkit-text-dark: #2c3e50;
            --jkit-text-light: #f0f4f8;
            --jkit-text-muted: #8a99b5;
            --jkit-bg: #f4f5f7;
            --jkit-bg-card: #ffffff;
            --jkit-bg-card-alt: #ffffff; 
            --jkit-border-color: #e0e0e0;
            --jkit-shadow: 0 4px 25px rgba(0, 0, 0, 0.07);
            --jkit-gold: #FFD700;
            --jkit-yellow: #f0c29;
            --airbnb-red: #ff385c;
            --apply-bg: #d9d7e5;
            --apply-text: #5e4a8f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; overflow-wrap: break-word; }
        img { max-width: 100%; height: auto; display: block; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--jkit-dark-alt);
            color: var(--jkit-text-dark);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }
        
        html.filter-popup-open,
        body.filter-popup-open,
        html.chat-open-mobile,
        body.chat-open-mobile,
        html.notification-open,
        body.notification-open {
            overflow: hidden;
        }

        a { text-decoration: none; color: var(--jkit-primary); transition: color 0.3s ease; }
        a:hover { color: var(--jkit-secondary); }
        h1, h2, h3, h4 { font-weight: 700; line-height: 1.2; margin-bottom: 0.75rem; }
        h1 { font-size: clamp(2.25rem, 6vw, 3rem); }
        h2 { font-size: clamp(1.75rem, 5vw, 2.25rem); color: var(--jkit-dark); text-align: center; margin-bottom: clamp(1.5rem, 5vw, 3rem); padding-bottom: 1rem; border-bottom: 2px solid var(--jkit-border-color); }
        h3 { font-size: clamp(1.1rem, 3vw, 1.25rem); }
        h4 { font-size: clamp(1rem, 2.5vw, 1.1rem); color: var(--jkit-primary); }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 0 4%; }
        
        /* 2. Multi-Page Simulation Logic */
        .page-content { display: none; padding-top: 100px; padding-bottom: clamp(3rem, 8vw, 5rem); min-height: 100vh; }
        #home-page.page-content { padding-top: 0; }
        .page-content.active-page { display: block; }
        
        /* 3. Header & Navigation */
        .navbar { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background-color: transparent; padding: clamp(0.5rem, 2vw, 1rem) 0; transition: all 0.3s ease; }
        .navbar.scrolled { background-color: rgba(10, 10, 20, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 4px 25px rgba(0, 0, 0, 0.2); padding: 0.5rem 0; }
        body.success-page-active .navbar {
            display: none !important;
        }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
        .navbar-brand-container { display: flex; align-items: center; }
        .navbar-brand { font-size: clamp(2rem, 7vw, 2.5rem); font-weight: 800; color: var(--jkit-text-light) !important; letter-spacing: -2px; text-shadow: 1px 1px 3px rgba(0,0,0,0.4); line-height: 1; }
        .logo-image { height: clamp(24px, 10vw, 50px); width: auto; vertical-align: middle; }
        .mobile-info-icon { display: none; line-height: 0; }
        .mobile-info-icon svg { width: 28px; height: 28px; fill: var(--jkit-text-light); transition: transform 0.2s ease; }
        .mobile-info-icon:hover svg { transform: scale(1.1); }
        .mobile-contact-btn { display: none; color: var(--jkit-text-light); border: 2px solid var(--jkit-text-light); background-color: transparent; padding: 4px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; white-space: nowrap; transition: all 0.3s ease; }
        .mobile-contact-btn:hover { background-color: var(--jkit-text-light); color: var(--jkit-dark); }
        .nav-links { display: flex; align-items: center; list-style: none; gap: 1.5rem; }
        .nav-links .nav-link { color: var(--jkit-text-light); font-weight: 600; font-size: 1rem; padding: 0.5rem 0; position: relative; }
        .nav-links .nav-link::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 3px; background-color: var(--jkit-primary); transition: width 0.3s ease; }
        .nav-links .nav-item.active .nav-link::after,
        .nav-links .nav-link:hover::after { width: 100%; }
        .nav-auth { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
        #guest-nav, #user-info-nav { display: flex; align-items: center; gap: clamp(0.5rem, 2vw, 1rem); }
        .nav-icon-btn { position: relative; background: none; border: none; cursor: pointer; padding: 0; line-height: 0; }
        .nav-icon-btn svg, .nav-icon-btn i { width: 28px; height: 28px; fill: var(--jkit-text-light); color: var(--jkit-text-light); font-size: 24px; transition: transform 0.2s ease; }
        .nav-icon-btn:hover svg, .nav-icon-btn:hover i { transform: scale(1.1); }
        .notification-badge { position: absolute; top: -5px; right: -8px; background-color: var(--airbnb-red); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: 700; display: none; align-items: center; justify-content: center; border: 2px solid var(--jkit-dark); }
        .navbar.scrolled .notification-badge { border-color: #1a1a2e; }
        .notification-badge.visible { display: flex; }
        .hero-buttons { opacity: 0; }

        /* Global Button Style */
        .jkit-btn { display: inline-block; background: linear-gradient(45deg, var(--jkit-primary), var(--jkit-secondary)); color: var(--jkit-text-light); padding: clamp(8px, 1.5vw, 10px) clamp(16px, 3vw, 24px); border-radius: 50px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 82, 204, 0.3); border: none; cursor: pointer; text-align: center; font-size: clamp(0.8rem, 2.5vw, 1rem); font-family: 'Poppins', sans-serif; white-space: nowrap; margin-right: 4%; }
        .jkit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 82, 204, 0.4); color: rgb(214, 214, 214); }
        .jkit-btn:disabled { background: #ccc; box-shadow: none; transform: none; cursor: not-allowed; }
        .jkit-btn-outline { background: transparent; color: var(--jkit-primary); border: 2px solid var(--jkit-primary); box-shadow: none; }
        .jkit-btn-outline:hover { background: var(--jkit-primary); color: var(--jkit-text-light); transform: translateY(-2px); }
        .jkit-btn-secondary { background: transparent; color: var(--jkit-text-light); border: 2px solid var(--jkit-text-light); box-shadow: none; }
        .jkit-btn-secondary:hover { background: var(--jkit-text-light); color: var(--jkit-dark); transform: translateY(0); box-shadow: none; }
        #signup-btn.jkit-btn { background: linear-gradient(45deg, #28a745, #218838); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        #signup-btn.jkit-btn:hover { box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4); }
        .jkit-btn-danger { background: linear-gradient(45deg, var(--airbnb-red), #d62f4e); box-shadow: 0 4px 15px rgba(255, 56, 92, 0.3); }
        .jkit-btn-danger:hover { box-shadow: 0 6px 20px rgba(255, 56, 92, 0.4); }

        #user-info-nav { display: none; }
        .user-avatar { width: clamp(30px, 8vw, 40px); height: clamp(30px, 8vw, 40px); border-radius: 50%; object-fit: cover; border: 2px solid var(--jkit-primary); cursor: pointer; flex-shrink: 0; }
        .mobile-nav-toggle { display: none; }
        
        #logout-btn .logout-icon {
            display: none;
        }

        #signup-btn .signup-icon {
            display: none;
        }

        #notification-dropdown, #chat-notification-dropdown { display: none; position: absolute; top: 100%; right: 0; background-color: var(--jkit-bg-card); border: 1px solid var(--jkit-border-color); border-radius: 12px; box-shadow: var(--jkit-shadow); width: 350px; max-width: 90vw; z-index: 1001; overflow: hidden; }
        #chat-notification-dropdown { width: 380px; }
        #notification-dropdown.visible, #chat-notification-dropdown.visible { display: block; }
        .notification-header { padding: 0.75rem 1rem; font-weight: 600; border-bottom: 1px solid var(--jkit-border-color); }
        #notification-list, #chat-notification-list { list-style: none; max-height: 400px; overflow-y: auto; }
        #notification-list li { padding: 0.75rem 1rem; font-size: 0.9rem; border-bottom: 1px solid var(--jkit-border-color); cursor: pointer; }
        #notification-list li:last-child { border-bottom: none; }
        #notification-list li:hover { background-color: var(--jkit-bg); }
        #notification-list li.unread { background-color: #eaf4ff; font-weight: 500; }
        .no-notifications { color: var(--jkit-text-muted); text-align: center; padding: 2rem 1rem; cursor: default; }

        .chat-notification-item { display: flex; align-items: center; padding: 0.75rem 1rem; gap: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--jkit-border-color); }
        .chat-notification-item:last-child { border-bottom: none; }
        .chat-notification-item:hover { background-color: var(--jkit-bg); }
        .chat-notification-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .chat-notification-info { flex-grow: 1; overflow: hidden; }
        .chat-notification-header { display: flex; justify-content: space-between; align-items: baseline; }
        .chat-notification-header strong { font-weight: 600; color: var(--jkit-text-dark); }
        .chat-notification-header span { font-size: 0.75rem; color: var(--jkit-text-muted); }
        .chat-notification-info p { font-size: 0.85rem; color: var(--jkit-text-muted); margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #toast-notification {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: top 0.4s ease-in-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #toast-notification.show {
            top: 20px;
        }
        #toast-notification.info {
            background-color: var(--jkit-primary);
        }
        #toast-notification.success {
            background-color: #28a745;
        }
        #toast-notification.error {
            background-color: var(--airbnb-red);
        }
        #toast-notification .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
        }

        /* 4. Home Page Styles */
        .hero-section { width: 100%; min-height: 90vh; display: flex; flex-direction: column; justify-content: center; background-size: cover; background-position: center; position: relative; color: var(--jkit-text-light); padding: clamp(2rem, 10vh, 5rem) 0; }
        .hero-section::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, var(--jkit-dark-alt) 10%, rgba(8,9,13,0.3) 50%); }
        .hero-content { position: relative; z-index: 2; max-width: 650px; margin-bottom: 2rem; }
        .hero-content h1 { font-size: clamp(2.5rem, 8vw, 3.5rem); font-weight: 800; text-shadow: 2px 2px 8px rgba(0,0,0,0.5); color: var(--jkit-text-light); }
        .hero-content p { font-size: clamp(1rem, 3vw, 1.2rem); margin: 1.5rem 0; color: var(--jkit-text-light); }
        .hero-buttons { display: flex; flex-wrap: wrap; gap: 1rem; }
        .hero-buttons .jkit-btn { padding: 12px 30px; font-size: clamp(0.9rem, 3vw, 1.1rem); flex-shrink: 0; }
        .hero-buttons .jkit-btn-secondary { background: rgba(255,255,255,0.1); border-color: var(--jkit-text-light); color: var(--jkit-text-light); }
        .hero-buttons .jkit-btn-secondary:hover { background: var(--jkit-text-light); color: var(--jkit-dark); }
        .hero-tabs-container { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; position: relative; z-index: 2; flex-wrap: wrap; }
        .hero-tabs-container .jkit-btn { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.3); padding: 8px 20px; }
        .hero-tabs-container .jkit-btn:hover { background: var(--jkit-text-light); color: var(--jkit-dark); border-color: var(--jkit-text-light); }

        .events-section { background: var(--jkit-dark); padding: clamp(2rem, 8vw, 4rem) 0; }
        .events-section h2 { color: var(--jkit-text-light); text-align: center; border-bottom-color: var(--jkit-primary); }
        .events-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .event-card { background-color: var(--jkit-dark-alt); color: var(--jkit-text-light); border-radius: 15px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.2); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .event-card:hover { transform: translateY(-5px); }
        .event-card .card-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            overflow: hidden;
            background-color: #e0e0e0;
        }
        .event-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .event-card-content { padding: 1.5rem; display: flex; flex-direction: column; flex-grow: 1; }
        .event-date { background: linear-gradient(45deg, var(--jkit-primary), var(--jkit-secondary)); color: var(--jkit-text-light); padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; text-align: center; margin-bottom: 1rem; align-self: flex-start; }
        .event-date .month { display: block; font-size: 0.8rem; line-height: 1; }
        .event-date .day { display: block; font-size: 1.5rem; line-height: 1.2; }
        .event-card h3 { color: var(--jkit-text-light); }
        .event-card p { color: var(--jkit-text-muted); flex-grow: 1; margin-bottom: 1.5rem; }
        .event-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding: 0; }

        /* "How It Works" Section Styling */
        .feature-block { padding: clamp(2rem, 8vw, 4rem) 0; }
        #home-page .feature-block { background-color: var(--jkit-dark); }
        #home-page .feature-block h2, #home-page .feature-block .feature-item h3 { color: var(--jkit-text-light); }
        #about-page .feature-block { background-color: var(--jkit-bg); margin-top: 4rem; }
        #about-page .feature-block h2, #about-page .feature-block .feature-item h3 { color: var(--jkit-dark); }
        .feature-block h2 { display: inline-block; margin-bottom: 3rem; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: clamp(1.5rem, 4vw, 2rem); text-align: center; }
        .feature-item i { font-size: 2.5rem; color: var(--jkit-primary); margin-bottom: 1rem; }
        .feature-item p { color: var(--jkit-text-muted); }

        .footer { background-color: var(--jkit-dark); color: var(--jkit-text-muted); padding: 4rem 0 2rem; text-align: center; font-size: 0.9rem; }
        .footer-logo { height: clamp(35px, 10vw, 60px); width: auto; margin: 0 auto 1.5rem; }
        .footer-info { margin-bottom: 0.75rem; display: flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem; }
        .footer-info span { margin: 0; display: inline-block; }
        .copyright { font-size: 0.8rem; opacity: 0.7; }
        
        .footer-nav-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            text-align: left;
            padding-bottom: 3rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .footer-nav-column h4 {
            color: var(--jkit-text-light);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .footer-nav-column ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .footer-nav-column ul li {
            margin-bottom: 0.5rem;
        }
        .footer-nav-column ul li a {
            color: var(--jkit-text-muted);
            transition: color 0.3s ease, padding-left 0.3s ease;
        }
        .footer-nav-column ul li a:hover {
            color: var(--jkit-text-light);
            padding-left: 5px;
        }
        .footer-socials {
            display: flex;
            gap: 1.5rem;
        }
        .footer-socials a {
            color: var(--jkit-text-muted);
            font-size: 1.2rem;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .footer-socials a:hover {
            color: var(--jkit-primary);
            transform: scale(1.1);
        }
        
        .page-header { background: var(--jkit-dark); color: var(--jkit-text-light); padding-top: clamp(2rem, 6vw, 3rem); padding-bottom: clamp(2rem, 6vw, 3rem); margin-bottom: clamp(2rem, 6vw, 3rem); border-radius: 0 0 25px 25px; }
        .page-header-title-container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .page-header-title-container h1 { color: var(--jkit-text-light); font-size: clamp(1.8rem, 6vw, 2.5rem); border-bottom: none; margin-bottom: 0; }
        .airbnb-filters-container { display: flex; background-color: var(--jkit-bg-card); border-radius: 50px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); border: 1px solid var(--jkit-border-color); width: 100%; max-width: 1100px; margin: 0 auto; overflow: visible; align-items: stretch; position: relative; z-index: 2; }
        .filter-item { flex: 1 1 auto; display: flex; flex-direction: column; justify-content: center; padding: 0.75rem 0; position: relative; cursor: pointer; transition: background-color 0.2s ease; min-width: 100px; }
        .filter-item.flex-grow { flex-grow: 1.5; }
        .filter-item + .filter-item, .filter-item + .filter-search-btn { border-left: 1px solid var(--jkit-border-color); }
        .filter-item:hover { background-color: #f7f7f7; }
        .airbnb-filters-container > .filter-item:first-child:hover,
        .airbnb-filters-container > .filter-item:only-child:hover,
        .airbnb-filters-container > .filter-item:last-of-type:not(:has(+ .filter-search-btn)):hover { border-radius: 50px; }
        .filter-item label { font-size: 0.8rem; font-weight: 700; color: var(--jkit-text-dark); padding: 0 1.5rem; margin-bottom: 0.1rem; white-space: nowrap; }
        .filter-item input, .filter-item select, .filter-item .filter-value-display { border: none; background: transparent; width: 100%; padding: 0 1.5rem; font-size: 0.9rem; color: var(--jkit-text-muted); outline: none; font-family: 'Poppins', sans-serif; -webkit-appearance: none; -moz-appearance: none; appearance: none; pointer-events: none; }
        .filter-item select { cursor: pointer; pointer-events: auto; }
        .filter-item .filter-value-display { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-search-btn { flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(45deg, var(--jkit-primary), var(--jkit-secondary)); color: var(--jkit-text-light); border: none; cursor: pointer; font-size: 1.1rem; transition: all 0.3s ease; padding: 0 1.5rem; border-top-right-radius: 50px; border-bottom-right-radius: 50px; }
        .filter-search-btn:hover { opacity: 0.9; }

        .filter-popup { display: none; position: fixed; background: #fff; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1010; overflow: hidden; border: 1px solid var(--jkit-border-color); transition: opacity 0.2s ease, transform 0.2s ease; opacity: 0; transform: translateY(10px); }
        .category-popup-main { min-width: 220px; border-color: var(--jkit-text-muted); }
        .category-popup-main .filter-popup-header { padding: 0.75rem 1rem; }
        .category-popup-main .filter-popup-header h4 { font-weight: bold; }
        #specific-job-popup { min-width: 350px; max-width: 500px; }
        .filter-popup.popup-open { display: flex; flex-direction: column; opacity: 1; transform: translateY(0); }
        .filter-popup-header { padding: 1rem; border-bottom: 1px solid var(--jkit-border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 1; flex-shrink: 0; }
        .filter-popup-header h4 { margin: 0; color: var(--jkit-dark); }
        .filter-popup .close-btn { position: static; font-size: 1.5rem; background: none; border: none; cursor: pointer; padding: 0; line-height: 1; color: #aaa; }
        .filter-popup-list { list-style: none; padding: 0.5rem; flex-grow: 1; overflow-y: auto; }
        .filter-popup-footer { padding: 0.5rem 1rem; border-top: 1px solid var(--jkit-border-color); text-align: center; display: none; }
        .scroll-bottom-btn { background: none; border: none; color: var(--jkit-text-muted); font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .scroll-bottom-btn:hover { color: var(--jkit-primary); }
        .filter-popup-list li, .filter-popup-list button { width: 100%; text-align: left; padding: 0.75rem 1rem; border: none; background: transparent; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95rem; border-radius: 6px; display: block; color: var(--jkit-text-dark); }
        .filter-popup-list li:hover, .filter-popup-list button:hover { background-color: #f0f4f8; color: var(--jkit-primary); }
        .filter-popup-list li.selected, 
        .filter-popup-list button.selected { color: var(--jkit-primary); font-weight: 700; }
        .filter-popup-list li.has-submenu::after { content: '\f054'; font-family: 'Font Awesome 6 Free'; font-weight: 900; float: right; color: #ccc; }
        #specific-job-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.5rem; }
        #specific-job-list button { text-align: center; background-color: #f9f9f9; border: 1px solid var(--jkit-border-color); }
        .scroll-to-top-wrapper { position: sticky; bottom: 15px; right: 15px; float: right; flex-direction: column; align-items: center; cursor: pointer; z-index: 2; display: none; }
        .scroll-to-top-wrapper.visible { display: none; }
        .scroll-to-top-btn { width: 40px; height: 40px; background-color: var(--jkit-dark); color: var(--jkit-text-light); border: none; border-radius: 50%; font-size: 1rem; z-index: 1011; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .scroll-to-top-wrapper:hover .scroll-to-top-btn { transform: translateY(-2px); }
        .scroll-to-top-text { color: var(--jkit-gold); font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
        
        #service-rate-container, #agency-service-rate-container { display: flex; flex-direction: column; gap: 0.75rem; }
        .service-rate-item { display: flex; gap: 0.5rem; align-items: center; }
        .service-rate-item .service-input { flex-grow: 1; }
        .service-rate-item .rate-input { width: 100px; flex-shrink: 0; }
        .service-rate-item .pay-rate-select {
            padding: 12px;
            border: 1px solid var(--jkit-border-color);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            width: 120px;
            flex-shrink: 0;
        }
        .remove-service-btn { background: var(--airbnb-red); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; font-size: 1.1rem; cursor: pointer; flex-shrink: 0; line-height: 1; transition: background-color 0.2s; }
        .remove-service-btn:hover { background-color: #d62f4e; }
        
        .join-requests-list { list-style: none; margin-top: 1.5rem; }
        .join-request-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        .join-request-item:last-child { border-bottom: none; }
        .request-user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .request-user-name { font-weight: 600; flex-grow: 1; }
        .request-actions { display: flex; gap: 0.5rem; }
        .accept-request-btn, .reject-request-btn { padding: 5px 12px; font-size: 0.8rem; }
        .accept-request-btn { background: linear-gradient(45deg, #28a745, #218838); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
        .reject-request-btn { background: linear-gradient(45deg, #dc3545, #c82333); box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); }
        .dashboard-nav button { position: relative; }
        .dashboard-badge { position: absolute; top: 8px; right: 12px; background-color: var(--airbnb-red); color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: 700; display: none; align-items: center; justify-content: center; }
        .dashboard-badge.visible { display: flex; }

        /* FIX: Apply display:flex only when the panel is active */
        #default-images-panel.active { 
            display: flex; 
            flex-direction: column; 
            gap: 2.5rem; 
        }
        .default-image-category-section { padding: 1.5rem; border: 1px solid var(--jkit-border-color); border-radius: 12px; }
        .default-image-category-section h4 { font-size: 1.4rem; margin-bottom: 1rem; color: var(--jkit-primary); }
        .default-image-row { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid #f0f0f0; }
        .default-image-row:last-child { border-bottom: none; }
        .default-image-row .item-name { flex-basis: 200px; font-weight: 600; }
        .default-image-row .image-preview { width: 80px; height: 60px; object-fit: cover; border-radius: 6px; background-color: #eee; }

        .admin-user-table, .admin-timeline-table { 
            width: 100%; 
            max-width: 100%;
            border-collapse: collapse; 
            margin-top: 1.5rem;
            box-sizing: border-box;
        }
        .admin-user-table th, .admin-user-table td, .admin-timeline-table th, .admin-timeline-table td { padding: 12px; text-align: left; }
        .admin-user-table th, .admin-timeline-table th { background-color: var(--jkit-bg); }
        .admin-user-table td, .admin-timeline-table td { border-bottom: 1px solid var(--jkit-border-color); }
        .admin-user-table .jkit-btn { padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
        .admin-user-table .delete-user-btn { background: var(--airbnb-red); }
        .admin-timeline-table tr.new-event { background-color: #eaf4ff; transition: background-color 0.5s ease; }
        .admin-timeline-table td.timeline-time { font-size: 0.8rem; color: var(--jkit-text-muted); white-space: nowrap; }
        
        /* Admin User Management Panel - Responsive Container */
        .admin-user-management-panel {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 0;
            margin: 0;
            position: relative;
        }
        .admin-user-management-panel h3 {
            font-size: clamp(1rem, 4vw, 1.5rem);
            margin: 0 0 1rem 0;
            padding: 0;
            word-wrap: break-word;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        /* Admin User Filters */
        .admin-user-filters {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--jkit-bg);
            border-radius: 8px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .admin-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            min-width: 200px;
        }
        .admin-filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--jkit-text-dark);
        }
        .admin-filter-select,
        .admin-search-input {
            padding: 0.75rem;
            border: 1px solid var(--jkit-border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s ease;
        }
        .admin-filter-select:focus,
        .admin-search-input:focus {
            outline: none;
            border-color: var(--jkit-primary);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
        }
        /* Admin User Pagination */
        .admin-user-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--jkit-bg);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .admin-pagination-info {
            font-size: 0.9rem;
            color: var(--jkit-text-muted);
        }
        .admin-pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .admin-pagination-btn {
            padding: 0.5rem 1rem;
            background: var(--jkit-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .admin-pagination-btn:hover:not(:disabled) {
            background: #003d99;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 82, 204, 0.3);
        }
        .admin-pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .admin-pagination-page-info {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--jkit-text-dark);
        }
        .admin-table-scroll-wrapper {
            position: relative;
            width: 100%;
            max-width: 100%;
            display: flex;
            align-items: center;
        }
        .admin-scroll-buttons-container {
            position: relative;
            width: 100%;
            height: 56px; /* Space for buttons */
            display: none; /* Hidden by default, shown only on desktop */
            margin-bottom: 10%; /* 10% gap between chevron arrows and pagination */
            margin-top: 1.5rem;
        }
        .admin-scroll-buttons-container .admin-scroll-btn {
            pointer-events: auto; /* Re-enable clicks on buttons */
            
        }
        .admin-table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            flex: 1;
        }
        .admin-table-container::-webkit-scrollbar {
            height: 6px;
        }
        .admin-table-container::-webkit-scrollbar-track {
            background: var(--jkit-border-color);
        }
        .admin-table-container::-webkit-scrollbar-thumb {
            background: var(--jkit-primary);
            border-radius: 3px;
        }
        .admin-scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--jkit-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 82, 204, 0.3);
        }
        .admin-scroll-left {
            left: 10px;
        }
        .admin-scroll-right {
            right: 10px;
        }
        .admin-scroll-btn:hover {
            background: #003d99;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 82, 204, 0.4);
        }
        .admin-scroll-btn:active {
            transform: scale(0.95);
        }
        .admin-scroll-btn i {
            font-size: 1rem;
        }
        .admin-scroll-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .admin-scroll-btn:disabled:hover {
            background: var(--jkit-primary);
            transform: none;
        }
        
        .default-image-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .default-image-category-header h4 {
            margin-bottom: 0;
        }
        .toggle-specific-jobs-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: var(--jkit-text-muted);
            cursor: pointer;
            padding: 0.5rem;
            line-height: 1;
        }
        .toggle-specific-jobs-btn i {
            transition: transform 0.3s ease;
        }
        .specific-jobs-container {
            max-height: 3000px; /* Ample height for expansion */
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out, margin-top 0.4s ease-in-out, padding-top 0.4s ease-in-out, border-top-width 0.4s ease-in-out;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--jkit-border-color);
            opacity: 1;
        }
        .specific-jobs-container.collapsed {
            max-height: 0;
            margin-top: 0;
            padding-top: 0;
            border-top-width: 0;
            opacity: 0;
        }
        .default-image-category-section.jobs-collapsed .toggle-specific-jobs-btn i {
            transform: rotate(180deg);
        }

        /* Admin Job Category Management Styles */
        .actions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .category-admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .category-admin-card { background: #f9f9f9; border: 1px solid var(--jkit-border-color); border-radius: 8px; padding: 1rem; }
        .category-admin-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 1px solid var(--jkit-border-color); }
        .category-admin-header h4 { margin: 0; font-size: 1.1rem; }
        .category-admin-actions button { background: none; border: none; cursor: pointer; font-size: 1rem; color: var(--jkit-text-muted); transition: color 0.2s; margin-left: 0.5rem; }
        .category-admin-actions .edit-btn:hover { color: var(--jkit-primary); }
        .category-admin-actions .delete-btn:hover { color: var(--airbnb-red); }
        .specific-job-list { list-style: none; max-height: 250px; overflow-y: auto; }
        .specific-job-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-radius: 4px; }
        .specific-job-item:hover { background: #f0f4f8; }
        .add-specific-job-btn { width: 100%; margin-top: 1rem; padding: 8px; font-size: 0.9rem; }

        /* NEW: Styles for About Page Editor */
        #about-content-form h4 {
            font-size: 1.2rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--jkit-border-color);
        }
        #about-content-form .deletable-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #eee;
        }
        #about-content-form .deletable-item .form-group {
            flex-grow: 1;
            margin-bottom: 0;
        }
         #about-content-form .deletable-item .form-group label {
            font-size: 0.8rem;
            color: var(--jkit-text-muted);
        }
        #about-content-form .remove-item-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-top: 24px; /* Align with input */
            flex-shrink: 0;
        }
        .about-value-card-editor, .about-audience-card-editor, .about-howitworks-item-editor {
            display: block !important;
        }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: clamp(1rem, 4vw, 2rem); }
        .job-card, .person-card, .agency-card { background: var(--jkit-bg-card-alt); border-radius: 15px; overflow: hidden; box-shadow: var(--jkit-shadow); transition: all 0.3s ease; display: flex; flex-direction: column; }
        .job-card:hover, .person-card:hover, .agency-card:hover { transform: translateY(-5px); box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .card-image-container { width: 100%; aspect-ratio: 1 / 1; overflow: hidden; background-color: #e0e0e0; position: relative; }
        .card-image-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease; }
        .job-card:hover img, .person-card:hover img, .agency-card:hover img { transform: scale(1.05); }
        
        .person-card, .job-card {
            border-radius: 20px;
            box-shadow: 0px 5px 30px 0px rgba(0, 4, 71, 0.15);
        }
        .person-card .card-image-container, .job-card .card-image-container {
            aspect-ratio: 285 / 190; /* This creates the specific rectangular shape */
        }
        .person-card .card-content, .job-card .card-content {
             padding: 30px;
        }
        
        .card-interactions { 
            position: absolute; 
            top: 1rem; 
            right: 1rem; 
            z-index: 2; 
            display: flex; 
            gap: 0.75rem; 
            background-color: rgba(0,0,0,0.4); 
            padding: 0.4rem 0.8rem; 
            border-radius: 20px;
        }
        .interaction-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
        }
        .interaction-item button {
            background: none; 
            border: none; 
            color: inherit; 
            font-size: 1.1rem; 
            cursor: pointer; 
            transition: all 0.2s ease;
            padding: 0;
            line-height: 1;
        }
        .interaction-item button:hover {
            color: white; 
            transform: scale(1.1);
        }
        .interaction-item .count {
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            margin-top: 2px;
        }
        .interaction-item button.disliked,
        .interaction-item button.favorited {
            color: var(--airbnb-red);
        }
        .interaction-item button.thumb-liked {
            color: var(--jkit-primary);
        }

        .card-content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .card-content h3 { margin-top: 0; color: var(--jkit-dark); font-size: 1.25rem; }
        .card-content p { color: var(--jkit-text-muted); font-size: 0.9rem; flex-grow: 1; }
        .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; color: var(--jkit-primary); font-weight: 600; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .card-meta span { display: flex; align-items: center; gap: 0.5rem; }
        .card-price { font-size: 1.5rem; font-weight: 700; color: var(--jkit-secondary); }
        .card-footer { 
            margin-top: auto; 
            padding: 1rem 1.5rem; 
            border-top: 1px solid var(--jkit-border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            gap: 0.75rem; 
            flex-wrap: wrap; 
        }
        .card-footer > div:first-child {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .card-footer-interactions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .card-footer-interactions .interaction-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--jkit-text-muted);
        }
        .card-footer-interactions .interaction-item button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: inherit;
            padding: 0;
            transition: all 0.2s ease;
        }
        .card-footer-interactions .interaction-item button:hover {
            transform: scale(1.1);
        }
        .card-footer-interactions .interaction-item .count {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .card-footer-interactions .interaction-item button.thumb-liked {
            color: var(--jkit-primary);
        }
        .card-footer-interactions .interaction-item button.disliked {
            color: var(--airbnb-red);
        }
        .card-footer .jkit-btn-outline { padding: 6px 14px; font-size: 0.8rem; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .card-tag { background: rgba(0, 82, 204, 0.1); color: var(--jkit-primary); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        
        .agency-membership-info { font-size: 0.85rem; color: var(--jkit-text-muted); margin-top: -0.5rem; margin-bottom: 0.75rem; }
        .agency-membership-info a { color: var(--jkit-primary); font-weight: 600; }
        .agency-membership-info a:hover { text-decoration: underline; }
        
        .card-footer .card-social-links a {
            color: var(--jkit-text-muted);
            font-size: 1.2rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .card-footer .card-social-links a:hover {
            color: var(--jkit-primary);
            transform: scale(1.1);
        }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background-color: #fefefe; margin: auto; padding: clamp(1.5rem, 5vw, 3rem); border-radius: 15px; width: 100%; max-width: 500px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        #location-modal .modal-content { max-width: 800px; }
        #map-container-modal { width: 100%; aspect-ratio: 16 / 9; background: #eee; border-radius: 8px; overflow: hidden; }
        #map-container-modal iframe { width: 100%; height: 100%; border: 0; }
        .close-btn { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        .modal h2 { text-align: center; margin-bottom: 2rem; color: var(--jkit-dark); font-size: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--jkit-border-color); border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem; }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .modal-footer { margin-top: 2rem; text-align: center; }
        .modal-footer a { font-weight: 600; }

        /* Image Viewer Modal Styles */
        #image-viewer-modal {
            background-color: rgba(0,0,0,0.85);
            padding: 20px;
            align-items: center;
            justify-content: center;
        }
        #image-viewer-modal .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            height: auto;
            padding: 0;
            background-color: transparent;
            box-shadow: none;
            border-radius: 5px;
        }
        #image-viewer-modal .close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        #image-viewer-modal .close-btn:hover,
        #image-viewer-modal .close-btn:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Dashboard Styles */
        .jkit-btn-outline {
            margin-top: 4%;
        }
        .dashboard-grid { display: grid; grid-template-columns: 300px 1fr; gap: clamp(1rem, 4vw, 2rem); align-items: flex-start; }
        .dashboard-nav { background: var(--jkit-bg-card); padding: 1.5rem; border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .dashboard-nav ul { list-style: none; }
        .dashboard-nav li button { display: block; width: 100%; padding: 1rem; margin-bottom: 0.5rem; text-align: left; background: none; border: none; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 1rem; font-weight: 600; border-radius: 8px; transition: all 0.2s ease; }
        .dashboard-nav li button.active, .dashboard-nav li button:hover { background: #eaf4ff; color: var(--jkit-primary); }
        .dashboard-nav li button.danger-zone-btn { color: var(--airbnb-red); }
        .dashboard-nav li button.danger-zone-btn:hover { background-color: #ffebee; }
        .dashboard-content { 
            background: var(--jkit-bg-card); 
            padding: 2rem; 
            border-radius: 15px; 
            box-shadow: var(--jkit-shadow);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        .dashboard-panel { 
            display: none; 
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        .dashboard-panel.active { display: block; }
        .dashboard-content h3 { margin-top: 0; padding-bottom: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        .my-jobs-list, .my-events-list, .my-news-list, .my-agency-members-list { list-style: none; margin-top: 2rem; }
        .my-jobs-list li, .my-events-list li, .my-news-list li, .my-agency-members-list li { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        .my-jobs-list li:last-child, .my-events-list li:last-child, .my-news-list li:last-child, .my-agency-members-list li:last-child { border-bottom: none; }
        .my-jobs-list li.highlight {
            background-color: rgba(0, 102, 255, 0.08);
            box-shadow: 0 0 0 2px rgba(0, 102, 255, 0.3);
            border-radius: 8px;
            transition: all 0.5s ease-out;
        }
        .job-list-image, .event-list-title, .news-list-title, .agency-member-list-image { width: clamp(45px, 12vw, 60px); height: clamp(45px, 12vw, 60px); border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .agency-member-list-image { border-radius: 50%; }
        .job-list-title, .event-list-title, .news-list-title, .agency-member-list-title { flex-grow: 1; font-weight: 600; }
        .job-status { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: capitalize; margin-left: 1rem; }
        .job-status.open { background-color: #d4edda; color: #155724; }
        .job-status.assigned { background-color: #fff3cd; color: #856404; }
        .job-status.in-progress { background-color: #cce5ff; color: #004085; }
        .job-status.closed { background-color: #f8d7da; color: #721c24; }
        .job-actions, .event-actions, .news-actions, .agency-member-actions { margin-left: auto; display: flex; gap: 0.5rem; }
        .job-actions button, .event-actions button, .news-actions button, .agency-member-actions button { background: none; border: none; cursor: pointer; font-size: 1.1rem; color: var(--jkit-text-muted); transition: color 0.2s; }
        .job-actions .edit-btn:hover, .event-actions .edit-btn:hover, .news-actions .edit-btn:hover, .agency-member-actions .edit-btn:hover { color: var(--jkit-primary); }
        .job-actions .delete-btn:hover, .event-actions .delete-btn:hover, .news-actions .delete-btn:hover, .agency-member-actions .delete-btn:hover { color: #E72E23; }
        .job-actions .close-btn:hover { color: #ffc107; }
        .image-upload-wrapper { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .image-preview { object-fit: cover; background-color: #eee; flex-shrink: 0; }
        #profile-avatar-preview { width: clamp(60px, 18vw, 80px); height: clamp(60px, 18vw, 80px); border-radius: 50%; }
        #agency-image-preview, #job-image-preview, #event-image-preview, #original-event-image-preview, #news-image-preview, #timeline-event-image-preview { width: clamp(80px, 25vw, 120px); height: auto; aspect-ratio: 4 / 3; border-radius: 8px; }
        .image-upload-label { display: inline-block; padding: 8px 16px; border-radius: 6px; cursor: pointer; background: #f0f4f8; color: #333; font-weight: 600; transition: background-color 0.2s; }
        .image-upload-label:hover { background: #e1e8f0; }
        input[type="file"] { display: none; }

        /* --- NEW: Dashboard Geolocation Map Styles --- */
        #dashboard-map-container {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--jkit-border-color);
            margin-bottom: 1rem;
        }
        #geolocation-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        #geolocation-info {
            font-size: 0.85rem;
            color: var(--jkit-text-muted);
            flex-grow: 1;
        }

        /* --- NEW: Dashboard Gallery Carousel Styles --- */
        .dashboard-gallery-carousel {
            display: flex;
            flex-direction: column;
            background-color: #eee;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--jkit-border-color);
        }
        .dashboard-gallery-carousel .dashboard-main-image {
            height: auto;
            aspect-ratio: 4 / 3;
            background-color: #f0f4f8;
            scale: 0.5;
        }
        .dashboard-gallery-carousel .dashboard-main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .dashboard-gallery-carousel .dashboard-thumbnail-strip {
            display: flex;
            background-color: rgba(0,0,0,0.05);
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
        }
        .dashboard-gallery-carousel .dashboard-thumbnail-item {
            position: relative;
            /* --- IMPLEMENTATION: Fluid width and height for thumbnails --- */
            width: clamp(50px, 18vw, 90px);
            height: clamp(40px, 14vw, 70px);
            flex-shrink: 0;
        }
        .dashboard-gallery-carousel .dashboard-thumbnail-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            border-radius: 5px;
            border: 3px solid transparent;
            transition: border-color 0.3s;
            display: block;
            background-color: #fff;
        }
        .dashboard-gallery-carousel .dashboard-thumbnail-item.active .dashboard-thumbnail-img {
            border-color: var(--jkit-primary);
        }
        .dashboard-gallery-carousel .thumbnail-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .dashboard-gallery-carousel .dashboard-thumbnail-item:hover .thumbnail-overlay {
            opacity: 1;
        }
        .dashboard-gallery-carousel .thumb-action-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        .dashboard-gallery-carousel .thumb-action-btn.remove-gallery-image-btn {
            color: var(--airbnb-red);
        }
        /* --- END: Dashboard Gallery Carousel Styles --- */
        
        /* Admin Panel Styles */
        .admin-user-table, .admin-timeline-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        .admin-user-table th, .admin-user-table td, .admin-timeline-table th, .admin-timeline-table td { padding: 12px; text-align: left; }
        .admin-user-table th, .admin-timeline-table th { background-color: var(--jkit-bg); }
        .admin-user-table td, .admin-timeline-table td { border-bottom: 1px solid var(--jkit-border-color); }
        .admin-user-table .jkit-btn { padding: 5px 10px; font-size: 0.8rem; margin-right: 5px; }
        .admin-user-table .delete-user-btn { background: var(--airbnb-red); }
        .admin-timeline-table tr.new-event { background-color: #eaf4ff; transition: background-color 0.5s ease; }
        .admin-timeline-table td.timeline-time { font-size: 0.8rem; color: var(--jkit-text-muted); white-space: nowrap; }
        
        /* Contact Page */
        .contact-container { background: var(--jkit-bg-card); padding: 2rem; border-radius: 15px; box-shadow: var(--jkit-shadow); display: grid; grid-template-columns: 1fr 1fr; gap: clamp(1.5rem, 4vw, 3rem); }
        .contact-form-wrapper { background: #f9f9f9; padding: 2rem; border-radius: 8px; }
        .contact-container h3 { font-size: 1.1rem; font-weight: 600; color: var(--jkit-text-dark); margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 1px; }
        .contact-details p { margin-bottom: 1.25rem; font-size: 1rem; line-height: 1.6; }
        .contact-details strong { display: block; color: var(--jkit-text-dark); font-weight: 600; margin-bottom: 0.25rem; }
        .map-container { margin-top: 2rem; border-radius: 8px; overflow: hidden; aspect-ratio: 4 / 3; }
        .map-container iframe { width: 100%; height: 100%; border: none; }
        .contact-submit-btn { background-color: var(--jkit-yellow); color: var(--jkit-text-dark); font-weight: 600; font-size: 1rem; padding: 12px 24px; border: none; border-radius: 8px; width: 100%; cursor: pointer; transition: opacity 0.3s ease; }
        .contact-submit-btn:hover { opacity: 0.9; }
        
        /* Apply Modal */
        #apply-modal .modal-content { background-color: var(--jkit-bg-card); color: var(--jkit-text-dark); max-width: 800px; padding: clamp(1.5rem, 4vw, 2.5rem); }
        #apply-modal h2 { text-align: left; margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        .apply-modal-body { display: grid; grid-template-columns: 250px 1fr; gap: 2rem; align-items: flex-start; }
        .apply-modal-image-container { display: flex; flex-direction: column; gap: 0.75rem; }
        .apply-modal-main-image { width: 100%; aspect-ratio: 4 / 3; object-fit: cover; border-radius: 12px; background-color: var(--jkit-bg); }
        .apply-modal-thumbnail-strip { display: flex; gap: 0.75rem; overflow-x: auto; padding-bottom: 5px; }
        .apply-modal-thumbnail-strip img { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s ease; flex-shrink: 0; }
        .apply-modal-thumbnail-strip img:hover, .apply-modal-thumbnail-strip img.active { border-color: var(--jkit-primary); }
        .apply-modal-details ul { list-style: none; padding: 0; }
        .apply-modal-details li { display: flex; flex-direction: column; margin-bottom: 1.25rem; }
        .apply-modal-details li:last-child { margin-bottom: 0; }
        .apply-modal-details strong { font-weight: 600; font-size: 0.9rem; color: var(--jkit-text-muted); margin-bottom: 0.25rem; display: block; text-transform: uppercase; }
        .apply-modal-details span { font-size: 1rem; color: var(--jkit-text-dark); line-height: 1.6; }
        .apply-modal-footer { margin-top: 2rem; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .action-btn-group { display: flex; align-items: center; gap: 0.75rem; margin-right: auto; }
        .action-btn-group .action-btn { background: #f0f4f8; width: 44px; height: 44px; border-radius: 50%; border: 1px solid var(--jkit-border-color); color: var(--jkit-text-muted); font-size: 1.2rem; cursor: pointer; transition: all 0.2s ease; }
        .action-btn-group .action-btn:hover { transform: scale(1.1); }
        .action-btn-group .action-btn.active.like { color: var(--jkit-primary); background: #eaf4ff; border-color: var(--jkit-primary); }
        .action-btn-group .action-btn.active.dislike { color: var(--airbnb-red); background: #ffebee; border-color: var(--airbnb-red); }
        .action-btn-group .action-btn.active.favorite { color: var(--airbnb-red); background: #ffebee; border-color: var(--airbnb-red); }
        
        /* Agency Detail Page */
        .back-btn { font-size: 1rem; font-weight: 600; color: var(--jkit-text-muted); transition: color 0.2s ease; margin-bottom: 1rem; background: none; border: none; cursor: pointer; padding: 0; display: inline-flex; align-items: center; gap: 0.5rem; }
        .back-btn:hover { color: var(--jkit-primary); }
        #agency-detail-page h2 { text-align: left; border: none; margin-bottom: 1.5rem; }
        .agency-layout-grid { display: grid; grid-template-columns: 350px 1fr; gap: clamp(1rem, 4vw, 2rem); align-items: flex-start; }
        .agency-sidebar, .agency-main-content { background: var(--jkit-bg-card); padding: clamp(1.5rem, 4vw, 2rem); border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .agency-sidebar { text-align: center; }
        #agency-detail-image { width: 100%; aspect-ratio: 1/1; border-radius: 12px; object-fit: cover; margin-bottom: 1.5rem; }
        #agency-detail-name { color: var(--jkit-dark); font-size: 1.75rem; margin-bottom: 0.5rem; }
        .agency-manager-info { color: var(--jkit-text-muted); margin-bottom: 0.5rem;}
        .agency-manager-info strong { color: var(--jkit-primary); }
        .agency-type-badge { display: inline-block; background: rgba(0, 82, 204, 0.1); color: var(--jkit-primary); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-bottom: 1.5rem; }
        .agency-sidebar-contact { text-align: left; margin-top: 2rem; border-top: 1px solid var(--jkit-border-color); padding-top: 1.5rem; }
        .agency-sidebar-contact h4 { color: var(--jkit-dark); font-size: 1.1rem; margin-bottom: 1rem; text-align: center; }
        .agency-sidebar-contact a { display: flex; align-items: center; gap: 0.75rem; color: var(--jkit-text-muted); margin-bottom: 0.75rem; font-size: 0.95rem; word-break: break-all; }
        .agency-sidebar-contact a i { color: var(--jkit-primary); width: 20px; text-align: center; }
        .agency-sidebar-contact a:hover { color: var(--jkit-primary); }
        .agency-sidebar-actions { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .agency-main-content h3 { color: var(--jkit-dark); font-size: 1.4rem; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        #agency-detail-description { color: var(--jkit-text-muted); margin-bottom: 2rem; }
        #agency-detail-services-list { list-style: none; padding: 0; }
        .agency-service-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--jkit-border-color); gap: 1rem; }
        .agency-service-item:last-child { border-bottom: none; }
        .hire-agency-service-btn { padding: 6px 16px; font-size: 0.85rem; flex-shrink: 0; }
        .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 1.5rem; }
        .member-card { text-align: center; }
        .member-card img { width: clamp(60px, 15vw, 80px); height: clamp(60px, 15vw, 80px); border-radius: 50%; object-fit: cover; margin: 0 auto 0.75rem auto; border: 3px solid var(--jkit-bg); }
        .member-card .member-name { font-weight: 600; font-size: 0.9rem; color: var(--jkit-text-dark); }
        .member-card .member-role { font-size: 0.8rem; color: var(--jkit-text-muted); }
        .member-card .jkit-btn.btn-small { padding: 4px 12px; font-size: 0.75rem; margin-top: 0.5rem; }
        .member-card .view-profile-btn { cursor: pointer; }
        .card-footer .jkit-btn.btn-small { padding: 6px 14px; }
        
        /* About Us Page */
        #about-page .container { max-width: 1100px; }
        #about-page h2 { text-align: center; color: var(--jkit-dark); margin-bottom: 1rem; font-size: 2.25rem; border-bottom: none; }
        .about-tagline { text-align: center; font-size: 1.25rem; color: var(--jkit-text-muted); font-weight: 500; max-width: 800px; margin: 0 auto 4rem auto; }
        .about-layout-container { display: flex; gap: 2rem; align-items: center; margin-bottom: 4rem; }
        .about-text-content { flex: 1.2; background: var(--jkit-bg-card); padding: clamp(1.5rem, 5vw, 3rem); border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .about-text-content h3 { font-size: 2rem; margin-bottom: 1.5rem; color: var(--jkit-primary); }
        .about-text-content p { line-height: 1.8; margin-bottom: 1.5rem; color: var(--jkit-text-dark); }
        .about-image-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: clamp(0.5rem, 2vw, 1rem); }
        .about-grid-image { aspect-ratio: 1/1; border-radius: 12px; background-size: cover; background-position: center; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .about-grid-image:hover { transform: scale(1.05) translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        .vision-mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(1.5rem, 4vw, 2rem); margin-bottom: 4rem; }
        .vision-card, .mission-card { background: var(--jkit-bg-card); padding: 2.5rem; border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .vision-card h3, .mission-card h3 { font-size: 1.5rem; color: var(--jkit-primary); margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--jkit-border-color); }
        .vision-card p { line-height: 1.8; color: var(--jkit-text-dark); }
        .mission-card .mission-list { list-style: none; padding-left: 0; }
        .mission-card .mission-list li { padding-left: 1.75rem; position: relative; margin-bottom: 1rem; color: var(--jkit-text-dark); line-height: 1.8; }
        .mission-card .mission-list li::before { content: '\f14a'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--jkit-primary); position: absolute; left: 0; top: 4px; }
        .about-section { margin-bottom: 4rem; }
        .about-section-title { text-align: center; font-size: 1.8rem; color: var(--jkit-dark); margin-bottom: 3rem; position: relative; padding-bottom: 1rem; border-bottom: none; }
        .about-section-title::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background-color: var(--jkit-primary); }
        .values-grid, .uvp-grid { display: grid; gap: clamp(1.5rem, 4vw, 2rem); }
        .values-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .uvp-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .value-card, .uvp-card { background: var(--jkit-bg-card); padding: 2.5rem 2rem; border-radius: 15px; box-shadow: var(--jkit-shadow); text-align: center; transition: all 0.3s ease; border-top: 4px solid var(--jkit-primary); }
        .value-card:hover, .uvp-card:hover { transform: translateY(-8px); box-shadow: 0 12px 35px rgba(0,0,0,0.12); }
        .value-card i, .uvp-card i { font-size: 2.5rem; color: var(--jkit-primary); margin-bottom: 1rem; display: block; line-height: 1; }
        .value-card h4, .uvp-card h4 { font-size: 1.25rem; color: var(--jkit-dark); margin-bottom: 0.75rem; }
        .value-card p, .uvp-card p { color: var(--jkit-text-muted); font-size: 0.95rem; }
        .problem-solution-grid { display: grid; grid-template-columns: 1fr 1fr; gap: clamp(1.5rem, 4vw, 2rem); margin-bottom: 4rem; margin-top: 4rem; }
        .problem-card, .solution-card { background: var(--jkit-bg-card); padding: 2.5rem; border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .problem-card h3, .solution-card h3 { font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--jkit-dark); border-bottom: 2px solid var(--jkit-border-color); padding-bottom: 0.75rem; display: inline-block; }
        .problem-card ul, .solution-card ul { list-style: none; padding-left: 0; }
        .problem-card li, .solution-card li { color: var(--jkit-text-dark); margin-bottom: 1rem; padding-left: 1.75rem; position: relative; }
        .problem-card li::before { content: '\f071'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--airbnb-red); position: absolute; left: 0; top: 4px; }
        .solution-card li::before { content: '\f058'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #28a745; position: absolute; left: 0; top: 4px; }
        .target-audience-section h3 { text-align: center; color: var(--jkit-dark); margin-bottom: 3rem; font-size: 1.8rem; position: relative; padding-bottom: 1rem; border-bottom: none; }
        .target-audience-section h3::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background-color: var(--jkit-primary); }
        .audience-grid-four-cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 2rem; }
        .audience-card { background: var(--jkit-bg-card); padding: 2rem; border-radius: 15px; box-shadow: var(--jkit-shadow); text-align: center; transition: all 0.3s ease; }
        .audience-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .audience-card i { font-size: 2.5rem; color: var(--jkit-primary); margin-bottom: 1rem; }
        .audience-card h4 { font-size: 1.25rem; color: var(--jkit-dark); margin-bottom: 1rem; }
        .audience-card ul { list-style: none; padding-left: 0; text-align: left; color: var(--jkit-text-muted); }
        .audience-card li { margin-bottom: 0.5rem; padding-left: 1.25rem; position: relative; }
        .audience-card li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--jkit-primary); position: absolute; left: 0; top: 5px; font-size: 0.8rem; }
        .about-cta { margin-top: 5rem; text-align: center; background: var(--jkit-dark); color: var(--jkit-text-light); padding: clamp(2rem, 6vw, 3rem) clamp(1rem, 4vw, 2rem); border-radius: 15px; }
        .about-cta h3 { color: var(--jkit-text-light); font-size: 2rem; }
        .about-cta p { color: var(--jkit-text-muted); font-size: 1.1rem; max-width: 600px; margin: 0 auto 1.5rem auto; }
        
        /* --- NEW: Team Section Styles --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            justify-content: center;
        }
        .team-card {
            background: var(--jkit-bg-card);
            border-radius: 15px;
            box-shadow: var(--jkit-shadow);
            text-align: center;
            padding: 2rem;
            transition: all 0.3s ease;
        }
        .team-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }
        .team-card img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1.5rem auto;
            border: 5px solid var(--jkit-bg);
        }
        .team-card h4 {
            font-size: 1.25rem;
            color: var(--jkit-dark);
            margin-bottom: 0.25rem;
        }
        .team-member-title {
            color: var(--jkit-primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .team-member-bio {
            color: var(--jkit-text-muted);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }
        .team-member-socials {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
        }
        .team-member-socials a {
            color: var(--jkit-text-muted);
            font-size: 1.2rem;
        }
        .team-member-socials a:hover {
            color: var(--jkit-primary);
        }
        /* --- END: Team Section Styles --- */

        /* Profile Detail Page */
        .profile-layout-grid { display: grid; grid-template-columns: 350px 1fr; gap: clamp(1rem, 4vw, 2rem); align-items: flex-start; }
        .profile-sidebar, .profile-main-content { background: var(--jkit-bg-card); padding: clamp(1.5rem, 4vw, 2rem); border-radius: 15px; box-shadow: var(--jkit-shadow); }
        .profile-sidebar { text-align: center; }
        #profile-detail-avatar { width: clamp(120px, 45vw, 180px); height: clamp(120px, 45vw, 180px); border-radius: 50%; object-fit: cover; margin: 0 auto 1.5rem auto; border: clamp(3px, 1.5vw, 5px) solid var(--jkit-bg); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        #profile-detail-name { color: var(--jkit-dark); font-size: 1.75rem; margin-bottom: 0.5rem; }
        .profile-status-badge { display: inline-block; background: rgba(0, 82, 204, 0.1); color: var(--jkit-primary); padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; margin-bottom: 1.5rem; }
        .profile-contact-info a { color: var(--jkit-text-dark); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: color 0.2s ease; }
        .profile-contact-info a:hover { color: var(--jkit-primary); }
        
        /* NEW: Social Links for Profile */
        .profile-social-links a {
            font-size: 1.5rem;
            color: var(--jkit-text-muted);
            transition: color 0.3s, transform 0.3s;
        }
        .profile-social-links a:hover {
            color: var(--jkit-primary);
            transform: scale(1.1);
        }

        .profile-main-content h3 { color: var(--jkit-dark); font-size: 1.4rem; padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--jkit-border-color); }
        #profile-detail-bio { color: var(--jkit-text-muted); margin-bottom: 2rem; }
        #profile-services-list, #profile-skills-list { list-style: none; padding: 0; }
        .profile-service-item, .profile-skill-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--jkit-border-color); gap: 1rem; }
        .profile-service-item:last-child, .profile-skill-item:last-child { border-bottom: none; }
        .service-name, .profile-skill-name { font-weight: 600; color: var(--jkit-text-dark); }
        .service-price { font-weight: 700; color: var(--jkit-secondary); }
        .hire-service-btn, .hire-skill-btn { padding: 6px 16px; font-size: 0.85rem; flex-shrink: 0; }
        .profile-skill-name { flex-grow: 1; }
        .profile-action-buttons { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; flex-wrap: wrap; }
        #people-page .airbnb-filters-container { margin-bottom: 8%; }
        .people-categories { display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; margin-top: -1rem; flex-wrap: wrap; }
        .people-cat-btn { background: rgba(255,255,255,0.1); color: var(--jkit-text-light); border: 1px solid rgba(255,255,255,0.2); }
        .people-cat-btn.active, .people-cat-btn:hover { background: var(--jkit-primary); color: var(--jkit-text-light); border-color: var(--jkit-primary); }
        .gallery-preview-wrapper { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
        .gallery-preview-item { position: relative; }
        .gallery-preview-item img { width: clamp(60px, 15vw, 80px); height: clamp(60px, 15vw, 80px); object-fit: cover; border-radius: 8px; }
        .gallery-preview-item .delete-gallery-img { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: var(--airbnb-red); color: white; border: none; cursor: pointer; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; }
        #profile-detail-gallery-container.service-detail-gallery { display: flex; flex-direction: column; background-color: #eee; border-radius: 12px; overflow: hidden; border: 1px solid var(--jkit-border-color); }
        .service-detail-gallery .main-image { height: auto; aspect-ratio: 4 / 3; background-color: #f0f4f8; }
        .service-detail-gallery .main-image img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .service-detail-gallery .thumbnail-strip { display: flex; background-color: rgba(0,0,0,0.05); padding: 10px; gap: 10px; overflow-x: auto; }
        .service-detail-gallery .thumbnail-strip img { width: clamp(60px, 18vw, 80px); height: clamp(45px, 13.5vw, 60px); object-fit: cover; cursor: pointer; border-radius: 5px; border: 3px solid transparent; transition: border-color 0.3s; flex-shrink: 0; }
        .service-detail-gallery .thumbnail-strip img:hover,
        .service-detail-gallery .thumbnail-strip img.active { border-color: var(--jkit-primary); }

        /* Stats Section */
        .stats-section { background-color: var(--jkit-bg-card); padding: clamp(2rem, 8vw, 4rem) 0; color: var(--jkit-text-dark); margin-bottom: 4rem; }
        .stats-section h2 { color: var(--jkit-text-dark); border-bottom-color: var(--jkit-primary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 2rem; text-align: center; }
        .stat-item i { font-size: 2.5rem; color: var(--jkit-primary); margin-bottom: 1rem; }
        .stat-number { font-size: clamp(2rem, 5vw, 2.5rem); font-weight: 700; line-height: 1; }
        .stat-label { color: var(--jkit-text-muted); font-weight: 500; }

        /* News Section */
        .news-section { background-color: var(--jkit-dark-alt); padding: clamp(2rem, 8vw, 4rem) 0; }
        .news-section h2 { color: var(--jkit-text-light); border-bottom-color: var(--jkit-primary); }
        .news-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2rem; }
        @media (max-width: 1400px) {
            .news-grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 1024px) {
            .news-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            .news-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .news-grid { grid-template-columns: 1fr; }
        }
        .news-card { background-color: var(--jkit-dark); border-radius: 15px; overflow: hidden; box-shadow: var(--jkit-shadow); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .news-card:hover { transform: translateY(-5px); }
        .news-card-image {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            overflow: hidden;
        }
        .news-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .news-card-content { padding: clamp(1rem, 4vw, 1.5rem); flex-grow: 1; display: flex; flex-direction: column; }
        .news-card-content h3 { font-size: clamp(1.05rem, 4vw, 1.2rem); color: var(--jkit-text-light); margin: 0 0 0.5rem 0; }
        .news-card-content p { color: var(--jkit-text-muted); font-size: clamp(0.85rem, 2.5vw, 0.9rem); margin-bottom: 1rem; flex-grow: 1; }
        .news-card-meta { font-size: 0.8rem; color: var(--jkit-primary); font-weight: 600; margin-top: auto; }
        
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background-color: var(--jkit-dark-alt); display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease, visibility 0.5s ease; opacity: 1; visibility: visible; }
        #preloader.loaded { opacity: 0; visibility: hidden; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.2); border-top-color: var(--jkit-primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Chatbox Styles */
        #chat-popup { display: none; position: fixed; bottom: 20px; right: 20px; width: 700px; max-width: 90vw; height: 520px; max-height: 80vh; background-color: #f8f9fe; border-radius: 1rem; box-shadow: 0 0 8rem 0 rgba(0,0,0, 0.1), 0rem 2rem 4rem -3rem rgba(0,0,0, 0.5); z-index: 1010; flex-direction: row; overflow: hidden; border: 1px solid #e0e0e0; }
        #chat-contacts-list { width: 270px; height: 100%; background-color: #f8f9fe; border-right: 1px solid #e0e0e0; flex-shrink: 0; display: flex; flex-direction: column; }
        .chat-contacts-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; flex-shrink: 0; }
        .chat-contacts-sort { font-weight: 600; font-size: 1rem; color: #333; cursor: pointer; }
        .chat-contacts-sort i { margin-left: 0.25rem; font-size: 0.8rem; }
        .chat-contacts-add-btn { width: 36px; height: 36px; background-color: #6c5ce7; color: white; border-radius: 50%; border: none; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease; }
        .chat-contacts-add-btn:hover { transform: scale(1.1); }
        .chat-contacts-body { overflow-y: auto; flex-grow: 1; padding: 0 1rem; }
        .chat-contact-item { display: flex; align-items: center; padding: 0.75rem; margin-bottom: 0.75rem; cursor: pointer; background-color: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .chat-contact-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .chat-contact-item.active { background-color: #e8e6ff; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.2); }
        .chat-contact-item img { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
        .chat-contact-item-info { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        .chat-contact-item .name-time { display: flex; justify-content: space-between; align-items: baseline; }
        .chat-contact-item .name { font-weight: 600; font-size: 1rem; color: #1e1e2f; }
        .chat-contact-item .time { font-size: 0.75rem; color: #b0b0c0; flex-shrink: 0; }
        .chat-contact-item .message { font-size: 0.85rem; color: #8a99b5; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; background: var(--jkit-bg); }
        #chat-header { display: flex; align-items: center; padding: 0 1rem; height: 60px; background: white; cursor: pointer; flex-shrink: 0; border-bottom: 1px solid var(--jkit-border-color); }
        #chat-contacts-toggle { display: none; }
        #chat-header .pic { width: 40px; height: 40px; background-size: cover; background-position: center; border-radius: 50%; }
        #chat-header-info { padding-left: 1rem; flex-grow: 1; }
        #chat-header-title { font-weight: 600; font-size: 1rem; margin: 0; }
        #chat-header-status { font-size: 0.8rem; color: var(--jkit-text-muted); }
        #chat-controls button { background: none; border: none; color: var(--jkit-text-muted); font-size: 1.1rem; cursor: pointer; padding: 0.5rem;}
        #chat-controls button:hover { color: var(--jkit-text-dark); }
        #chat-conversation-area { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chat-messages { flex-grow: 1; padding: 1rem; padding-bottom: 4%; overflow-y: auto; display: flex; flex-direction: column; gap: 0.25rem; }
        .chat-message { box-sizing: border-box; padding: 0.5rem 1rem; margin-bottom: 0.75rem; border-radius: 1.125rem; width: fit-content; max-width: 80%; box-shadow: 0 0 2rem rgba(0,0,0, 0.075), 0rem 1rem 1rem -1rem rgba(0,0,0, 0.1); }
        .chat-message.sent { margin-left: auto; border-bottom-right-radius: 0; background: var(--jkit-primary); color: white; }
        .chat-message.received { margin-right: auto; border-bottom-left-radius: 0; background: #FFF; color: var(--jkit-text-dark); }
        #chat-input-area { box-sizing: border-box; flex-basis: 4rem; flex-shrink: 0; display: flex; align-items: center; padding: 0 0.5rem 0 1.5rem; background: white; border-top: 1px solid var(--jkit-border-color); }
        #chat-input-area i { font-size: 1.2rem; margin-right: 1rem; color: var(--jkit-text-muted); cursor: pointer; transition: color 200ms; }
        #chat-input-area i:hover { color: var(--jkit-primary); }
        #chat-input { border: none; background-image: none; background-color: var(--jkit-bg); padding: 0.6rem 1rem; margin-right: 1rem; border-radius: 1.125rem; flex-grow: 2; font-family: 'Poppins', sans-serif; font-weight: 400; letter-spacing: 0.025em; outline: none; transition: box-shadow 0.2s; margin-bottom: 2%; }
        #chat-input:focus { box-shadow: 0 0 0 2px var(--jkit-primary); }
        #no-active-chat-placeholder { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; color: var(--jkit-text-muted); }
        #no-active-chat-placeholder i { font-size: 3rem; margin-bottom: 1rem; }
        
        /* AI Message Styles */
        .chat-message.ai-message { background-color: #eaf4ff; color: var(--jkit-text-dark); border: 1px solid var(--jkit-border-color); }
        .chat-message.ai-message.thinking { font-style: italic; color: #888; }
        .chat-message.ai-message.explanation { padding: 20px; }
        .explanation h3 { font-size: 1rem; font-weight: 700; color: var(--jkit-primary); margin-top: 10px; margin-bottom: 5px; border: none; text-align: left; }
        .explanation h3:first-child { margin-top: 0; }
        .explanation p { font-size: 0.9rem; line-height: 1.5; margin: 0; }
        .explanation i { margin-right: 8px; color: var(--jkit-secondary); }
        .section-highlight { background-color: rgba(0, 102, 255, 0.08); box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.3), 0 0 25px rgba(0, 102, 255, 0.2); border-radius: 15px; transition: all 0.7s ease-in-out; transform: scale(1.01); }

        /* Mobile Bottom Navigation */
        .mobile-bottom-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--jkit-bg-card); box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 999; }
        .mobile-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px 4px; color: var(--jkit-text-muted); transition: color 0.2s ease; }
        .mobile-nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .mobile-nav-item span { font-size: 0.7rem; font-weight: 600; }
        .mobile-nav-item.active { color: var(--jkit-primary); }

        #read-more-modal .modal-content { max-width: 700px; }
        #read-more-modal h2 { text-align: left; }
        #read-more-image { width: 100%; aspect-ratio: 16 / 9; object-fit: cover; border-radius: 12px; margin-bottom: 1.5rem; }
        #read-more-content { max-height: 60vh; overflow-y: auto; white-space: pre-wrap; }

        .job-actions .accept-job-btn, .job-actions .decline-job-btn { padding: 5px 10px; font-size: 0.8rem; color: white; border-radius: 20px; }
        .job-actions .accept-job-btn { background: #28a745; }
        .job-actions .decline-job-btn { background: var(--airbnb-red); }
        .job-status.in-progress { background-color: #cce5ff; color: #004085; }
        
        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--jkit-primary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* NEW: Verification Badge Styles */
        .verified-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            margin-left: 8px;
            font-size: 12px;
            vertical-align: text-bottom;
            flex-shrink: 0;
        }
        .card-content h3, #agency-detail-name, #profile-detail-name {
            display: flex;
            align-items: center;
        }

        /* --- NEW: TIMELINE SECTION STYLES --- */
        .timeline-section {
            background-color: var(--jkit-dark);
            padding: clamp(2rem, 8vw, 4rem) 0;
        }
        .timeline-section h2 {
            color: var(--jkit-text-light);
            border-bottom-color: var(--jkit-primary);
        }
        .timeline-container {
            position: relative;
            max-width: 900px;
            margin: 0 auto;
        }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 4px;
            background-color: var(--jkit-dark-alt);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -2px;
            z-index: 1;
        }
        .timeline-item {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-item::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            right: -10px;
            background-color: var(--jkit-text-light);
            border: 4px solid var(--jkit-primary);
            top: 25px;
            border-radius: 50%;
            z-index: 2;
        }
        .timeline-item.left {
            left: 0;
        }
        .timeline-item.right {
            left: 50%;
        }
        .timeline-item.left::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 28px;
            width: 0;
            z-index: 1;
            right: 30px;
            border: medium solid var(--jkit-dark-alt);
            border-width: 10px 0 10px 10px;
            border-color: transparent transparent transparent var(--jkit-dark-alt);
        }
        .timeline-item.right::before {
            content: " ";
            height: 0;
            position: absolute;
            top: 28px;
            width: 0;
            z-index: 1;
            left: 30px;
            border: medium solid var(--jkit-dark-alt);
            border-width: 10px 10px 10px 0;
            border-color: transparent var(--jkit-dark-alt) transparent transparent;
        }
        .timeline-item.right::after {
            left: -10px;
        }
        
        /* --- START: IMPLEMENTED TIMELINE IMAGE STYLES --- */
        .timeline-item-content {
            padding: 15px;
            background-color: var(--jkit-dark-alt);
            position: relative;
            border-radius: 10px;
            color: var(--jkit-text-light);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .timeline-text-wrapper {
            flex: 1;
        }
        .timeline-image-wrapper {
            flex-basis: 120px;
            flex-shrink: 0;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            overflow: hidden;
            background-color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            min-height: 120px;
        }
        .timeline-event-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        /* --- END: IMPLEMENTED TIMELINE IMAGE STYLES --- */

        .timeline-item-content .timeline-date {
            color: var(--jkit-primary);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        .timeline-item-content h3 {
            color: var(--jkit-text-light);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }
        .timeline-item-content p {
            color: var(--jkit-text-muted);
            font-size: 0.95rem;
            line-height: 1.6;
            margin: 0;
        }

        /* --- START OF ADDED STYLES FOR CONTACT FORM --- */

        /* These styles are specifically for the new ticketing form. */
        /* Some body styles are commented out to prevent conflicts with the main site. */

        #contact-page .form-container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            text-align: center;
        }

        #contact-page .form-logo {
            display: block;
            margin: 0 auto 25px auto;
            width: 100%;
            max-width: 220px;
            height: auto;
        }

        #contact-page .form-container h1 {
            margin-top: 0;
            color: #212529;
            font-size: 2rem;
            font-weight: 600;
        }

        #contact-page .form-container p {
            color: #555555;
            margin-bottom: 30px;
            font-size: 1rem;
            line-height: 1.5;
        }

        #contact-page .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        #contact-page .form-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555555;
            font-size: 0.9rem;
        }

        #contact-page input[type="text"],
        #contact-page input[type="email"],
        #contact-page input[type="tel"],
        #contact-page input[type="password"],
        #contact-page textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        #contact-page input:focus, 
        #contact-page textarea:focus {
            outline: none;
            border-color: #F39C12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.25);
        }

        #contact-page .form-container button {
            width: 100%;
            padding: 15px;
            background-color: #F39C12;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        #contact-page .form-container button:hover {
            background-color: #e8930f;
        }

        #contact-page .form-container button:active {
            transform: scale(0.99);
        }

        #contact-page .form-container button:disabled {
            background-color: #e8930f;
            cursor: not-allowed;
        }

        #contact-page #statusMessage {
            margin-top: 20px;
            font-weight: 500;
            padding: 15px;
            border-radius: 5px;
            display: none;
            text-align: center;
            word-wrap: break-word;
        }

        #contact-page .success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }

        #contact-page .error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }


        @media screen and (max-width: 480px) {
            #contact-page .form-container {
                padding: 1.5rem;
            }
            #contact-page .form-container h1 {
                font-size: 1.6rem;
            }
            #contact-page .form-container p {
                font-size: 0.95rem;
                margin-bottom: 20px;
            }
            #contact-page .form-container button {
                font-size: 1rem;
                padding: 12px;
            }
            #contact-page .form-container label {
                font-size: 0.85rem;
            }
        }
        /* --- END OF ADDED STYLES FOR CONTACT FORM --- */

        /* --- NEW: Verification Success Page Styles --- */
        #verification-success-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #ffffff;
            z-index: 10000;
            display: none; /* Controlled by JS */
            align-items: center;
            justify-content: center;
            text-align: center;
            padding-top: 0 !important;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #verification-success-page.visible {
            opacity: 1;
        }
        /* --- END: Verification Success Page Styles --- */

        /* --- NEW: RATING STYLES --- */
        .rating-summary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--jkit-text-muted);
            margin-bottom: 1rem;
        }
        .stars {
            color: var(--jkit-gold);
            font-size: 1.1rem;
        }
        .rating-count {
            font-size: 0.85rem;
        }
        .rate-job-btn {
            background-color: var(--jkit-gold);
            color: var(--jkit-dark);
            font-weight: 600;
        }
        #rating-modal .stars-input {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            font-size: 2rem;
            margin: 1rem 0;
        }
        #rating-modal .stars-input i {
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        #rating-modal .stars-input i:hover,
        #rating-modal .stars-input i.selected {
            color: var(--jkit-gold);
        }
        /* --- END: RATING STYLES --- */

        /* Responsive Design */
        @media (max-width: 991px) {
            .hero-tabs-container {
                display: none;
            }
            #home-page.page-content {
                padding-top: 80px; /* Add padding to push content down from the fixed navbar */
            }
            body { padding-bottom: 60px; }
            .nav-links, .mobile-nav-toggle { display: none !important; }
            .mobile-bottom-nav, .mobile-info-icon, .mobile-contact-btn { display: flex; }
            .navbar-brand-container { gap: 5%; }
            #guest-nav #signup-btn .signup-text { display: none; }
            #guest-nav #signup-btn .signup-icon { display: inline-block; font-size: 22px; color: var(--jkit-text-light); transition: transform 0.2s ease; }
            #guest-nav #signup-btn { background: transparent; border: none; box-shadow: none; padding: 0; min-width: 28px; line-height: 0; color: var(--jkit-text-light); }
            #guest-nav #signup-btn:hover { background: transparent; transform: none; box-shadow: none; }
            #guest-nav #signup-btn:hover .signup-icon { transform: scale(1.1); }
            /* --- MODIFICATION --- */
            .dashboard-grid, .profile-layout-grid, .agency-layout-grid, .about-layout-container, .problem-solution-grid, .vision-mission-grid, .contact-container { grid-template-columns: 1fr; }
            .airbnb-filters-container, .apply-modal-body { flex-direction: column; border-radius: 20px; max-width: 95%; box-shadow: var(--jkit-shadow); }
            .filter-item { width: 100%; padding: 0.75rem 0; }
            .filter-item + .filter-item, .filter-item + .filter-search-btn { border-left: none; border-top: 1px solid var(--jkit-border-color); }
            .filter-search-btn { width: 100%; border-radius: 0 0 18px 18px; padding: 1rem; }
            .about-layout-container { flex-direction: column-reverse; }
            .airbnb-filters-container > .filter-item:first-child:hover, .airbnb-filters-container > .filter-item:only-child:hover, .airbnb-filters-container > .filter-item:last-of-type:not(:has(+ .filter-search-btn)):hover, .airbnb-filters-container > .filter-item:has(+ .filter-search-btn):hover { border-radius: 20px; }
        
            /* --- NEW: Responsive Admin Tables --- */
            .admin-user-table, .admin-timeline-table {
                border: none;
            }
            .admin-user-table thead, .admin-timeline-table thead {
                display: none; /* Hide table headers on small screens */
            }
            .admin-user-table tr, .admin-timeline-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--jkit-border-color);
                border-radius: 8px;
                padding: 1rem;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .admin-user-table td, .admin-timeline-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                padding: 0.75rem 0;
                border-bottom: 1px dashed #eee;
                text-align: right;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .admin-user-table td:last-child, .admin-timeline-table td:last-child {
                border-bottom: none;
            }
            .admin-user-table td::before, .admin-timeline-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--jkit-primary);
                margin-right: 1rem;
                flex-shrink: 0;
                text-align: left;
                min-width: 80px;
            }
            /* Admin Panel Responsive */
            .admin-user-management-panel {
                padding: 1rem;
            }
            .admin-user-management-panel h3 {
                font-size: clamp(0.95rem, 5vw, 1.3rem);
            }
             /* --- END NEW --- */
        }

        /* --- IMPLEMENTATION: Desktop-specific grid layouts --- */
        @media (min-width: 992px) {
            /* General 3-column grid for main content pages */
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
            /* Specific 3-column grid for homepage sections */
            .news-grid, .events-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            /* Show admin scroll buttons only on desktop */
            .admin-scroll-buttons-container {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            html { font-size: 15px; }
            /* --- MODIFICATION: DECREASE HERO HEIGHT ON MOBILE --- */
            .hero-section { min-height: 80vh; }
            .page-content { padding-top: 80px; }
            #home-page.page-content { padding-top: 80px; } /* Ensure padding is consistent */
            .grid-container, .audience-grid-four-cols { grid-template-columns: 1fr; gap: 1.5rem; }
            .nav-auth { gap: 0.5rem; }
            #user-info-nav #dashboard-link { display: none; }
            .scroll-btn { display: none; }
            .apply-modal-body { grid-template-columns: 1fr; }
            .about-text-content, .problem-card, .solution-card { padding: 1.5rem; }
            #profile-detail-avatar { width: clamp(100px, 30vw, 150px); height: clamp(100px, 30vw, 150px); }
            .category-popup-main.popup-open, #specific-job-popup.popup-open { position: fixed; left: 0; width: 100%; margin: 0; border: none; max-height: 50vh; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(5px); }
            .category-popup-main.popup-open { top: 50vh; height: 50vh; border-top: 1px solid var(--jkit-border-color); border-radius: 15px 15px 0 0; transform: translateY(0); }
            #specific-job-popup.popup-open { top: 0; height: 50vh; border-bottom: 1px solid var(--jkit-border-color); border-radius: 0 0 15px 15px; transform: translateY(0); padding-bottom: 10%; }
            #specific-job-popup.popup-open .filter-popup-header { background: var(--jkit-dark); }
            #specific-job-popup.popup-open .filter-popup-header h4,
            #specific-job-popup.popup-open .close-btn { color: var(--jkit-text-light); }
            #specific-job-list { grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); padding: 0.5rem; }
            .filter-popup-list li, .filter-popup-list button { padding: clamp(0.7rem, 2vh, 0.85rem) 1rem; font-size: clamp(0.9rem, 2.5vw, 1rem); }
            .filter-popup-header { padding: 0.75rem 1rem; }
            
            #chat-popup { top: 0; right: 0; bottom: 0; left: 0; width: 100%; height: 100%; max-width: 100%; max-height: 100%; border-radius: 0; flex-direction: column; background-color: var(--jkit-bg); z-index: 1010; }
            #chat-contacts-list, .chat-main { border-radius: 0; }
            #chat-contacts-toggle { display: block; font-size: 1.4rem; color: var(--jkit-text-dark); }
            #chat-header-info { padding-left: 0; padding-right: 1rem; text-align: right; }
            #chat-header { flex-direction: row-reverse; }
            #chat-contacts-list { position: absolute; top: 0; left: -100%; width: clamp(250px, 85vw, 320px); height: 100%; z-index: 10; transition: left 300ms ease; box-shadow: 2px 0 10px rgba(0,0,0,0.1); border-right: 1px solid var(--jkit-border-color); }
            #chat-popup.contacts-open #chat-contacts-list { left: 0; }
            .chat-main { flex-grow: 1; width: 100%; height: 100%; }

            #notification-dropdown, #chat-notification-dropdown {
                position: fixed;
                top: 75px; 
                left: 50%;
                transform: translateX(-50%);
                width: 95vw;
                max-width: 400px;
                right: auto;
                max-height: calc(100vh - 150px);
            }
             /* --- NEW: Footer Responsive --- */
            .footer-nav-container {
                text-align: center;
            }
            .footer-socials {
                justify-content: center;
            }
            /* --- END NEW --- */

            /* --- RESPONSIVENESS IMPLEMENTATION --- */
            #profile-panel, #following-panel {
                padding: 1rem;
                width: 100%;
                box-sizing: border-box;
            }
            .dashboard-content, .profile-main-content, .agency-main-content, .dashboard-nav, .profile-sidebar, .agency-sidebar {
                padding: 1.5rem;
            }

            /* --- NEW: Responsive Admin Timeline --- */
            .admin-timeline-table {
                border: none;
            }
            .admin-timeline-table thead {
                display: none;
            }
            .admin-timeline-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid var(--jkit-border-color);
                border-radius: 8px;
                padding: 1rem;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            .admin-timeline-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: none;
                padding: 0.5rem 0;
                border-bottom: 1px dashed #eee;
                text-align: right;
            }
            .admin-timeline-table td:last-child {
                border-bottom: none;
            }
            .admin-timeline-table td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--jkit-primary);
                margin-right: 1rem;
                flex-shrink: 0;
                text-align: left;
            }
            /* --- END NEW --- */
            
            /* --- START: IMPLEMENTED TIMELINE IMAGE STYLES (Responsive) --- */
            .timeline-container::after {
                left: 20px;
            }
            .timeline-item {
                width: 100%;
                padding-left: 50px;
                padding-right: 15px;
            }
            .timeline-item.left, .timeline-item.right {
                left: 0%;
            }
            .timeline-item.left::after, .timeline-item.right::after {
                left: 10px;
            }
            .timeline-item.left::before, .timeline-item.right::before {
                left: 30px;
                border: medium solid var(--jkit-dark-alt);
                border-width: 10px 10px 10px 0;
                border-color: transparent var(--jkit-dark-alt) transparent transparent;
            }
            .timeline-image-wrapper {
                flex-basis: 100px;
                min-width: 100px;
                min-height: 100px;
            }
            .timeline-item-content {
                padding: 15px;
            }
            /* --- END: IMPLEMENTED TIMELINE IMAGE STYLES (Responsive) --- */

            /* --- FIXED: RESPONSIVENESS IMPLEMENTATION (AGENCY PANEL) --- */
            #agency-panel .service-rate-item {
                flex-wrap: wrap;
            }
            #agency-panel .service-rate-item .service-input {
                flex-basis: 100%;
                margin-bottom: 0.5rem;
            }
            #agency-panel .service-rate-item .rate-input {
                flex-grow: 1;
            }
            /* --- START IMPLEMENTATION --- */
            #profile-panel .service-rate-item {
                flex-wrap: wrap;
            }
            #profile-panel .service-rate-item .service-input {
                flex-basis: 100%;
                margin-bottom: 0.5rem;
            }
            #profile-panel .service-rate-item .rate-input {
                flex-grow: 1;
            }
            /* --- END IMPLEMENTATION --- */
        }
        
        @media (max-width: 500px) {
            .navbar .container { flex-wrap: nowrap; justify-content: space-between; gap: clamp(0.5rem, 3vw, 1rem); overflow: hidden; }
            .nav-auth { order: initial; }
            .hero-buttons { flex-direction: column; align-items: stretch; text-align: center; }
            .jkit-btn { padding: 10px 20px; }
            .dashboard-grid, .profile-layout-grid, .agency-layout-grid { gap: 1rem; }
            .dashboard-content, .profile-main-content, .agency-main-content, .dashboard-nav, .profile-sidebar, .agency-sidebar { padding: 1.5rem 1rem; }
            
            /* --- RESPONSIVENESS IMPLEMENTATION --- */
            .my-jobs-list li, .my-events-list li, .my-news-list li, .my-agency-members-list li {
                flex-wrap: wrap;
            }
            .job-actions, .event-actions, .news-actions, .agency-member-actions {
                margin-left: 0;
                flex-basis: 100%;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }
            .request-actions {
                flex-basis: 100%;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }
            .join-request-item {
                flex-wrap: wrap;
            }
            .request-user-name {
                flex-basis: calc(100% - 66px); /* Full width minus avatar and gap */
            }

            /* --- NEW: Responsive Admin User Table Actions --- */
             .admin-user-table td[data-label="Actions"] {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .admin-user-table .jkit-btn {
                width: 100%;
                max-width: 100%;
                text-align: center;
                margin-right: 0;
                padding: 8px 12px;
                font-size: clamp(0.75rem, 3vw, 0.85rem);
                box-sizing: border-box;
            }
            .admin-user-table td::before {
                font-size: clamp(0.75rem, 3vw, 0.9rem);
                min-width: 70px;
            }
            .admin-user-table td {
                font-size: clamp(0.8rem, 3.5vw, 0.9rem);
                padding: 0.6rem 0;
            }
            .admin-user-management-panel {
                padding: 0;
                margin: 0;
            }
            .admin-user-filters {
                flex-direction: column;
                gap: 1rem;
            }
            .admin-filter-group {
                min-width: 100%;
            }
            .admin-user-pagination {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .admin-pagination-controls {
                justify-content: center;
            }
            .admin-table-scroll-wrapper {
                gap: 0;
            }
            .admin-scroll-buttons-container {
                display: none !important; /* Hide on tablet */
            }
            .dashboard-content {
                padding: 1.5rem;
            }
            /* --- END NEW --- */

            /* --- NEW: Responsive Admin Timeline --- */
            .admin-timeline-table td {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            .admin-timeline-table td::before {
                margin-bottom: 0.25rem;
                font-size: 0.8em;
                text-transform: uppercase;
                color: var(--jkit-text-muted);
            }
            /* --- END NEW --- */

            /* --- FIXED: RESPONSIVENESS IMPLEMENTATION (AGENCY PANEL & PROFILE PANEL) --- */
            #agency-panel .image-upload-wrapper,
            #profile-panel .image-upload-wrapper {
                flex-direction: column;
                align-items: flex-start;
            }
            #agency-service-rate-container .service-rate-item,
            #profile-panel .service-rate-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            #agency-service-rate-container .service-rate-item .rate-input,
            #profile-panel .service-rate-item .rate-input {
                width: 100%;
            }
             #agency-service-rate-container .remove-service-btn,
             #profile-panel .remove-service-btn {
                align-self: flex-end;
            }
            #agency-panel .service-rate-item .pay-rate-select {
                width: 100%;
            }
             /* This ensures the dashboard panels use the parent container's padding and don't add their own, making their width consistent with other sections like the footer. */
            .dashboard-content, .dashboard-nav {
                padding-left: 0;
                padding-right: 0;
            }
            /* --- END IMPLEMENTATION --- */
        }
        
        @media (max-width: 420px) {
            .grid-container { grid-template-columns: 1fr; } 
            .filter-item input, .filter-item select { padding: 0 1rem; font-size: 0.8rem; }
            .modal-content { padding: 1.5rem; }
            .vision-mission-grid, .problem-solution-grid { grid-template-columns: 1fr; }
            .news-grid, .events-grid { grid-template-columns: 1fr; }
            
            /* Hide text-based buttons on very small screens to save space */
            #user-info-nav #dashboard-link { 
                display: none; 
            }

            /* Logout button as icon on mobile */
            #user-info-nav #logout-btn {
                background: transparent;
                border: none;
                box-shadow: none;
                padding: 0;
                min-width: 28px;
                line-height: 0;
                color: var(--jkit-text-light);
                margin-right: 0;
            }
            #user-info-nav #logout-btn .logout-text {
                display: none;
            }
            #user-info-nav #logout-btn .logout-icon {
                display: inline-block;
                font-size: 22px;
                transition: transform 0.2s ease;
            }
            #user-info-nav #logout-btn:hover .logout-icon {
                transform: scale(1.1);
            }

            /* Adjust nav auth icon/button sizing and spacing for better fit */
            .nav-auth {
                gap: 0.5rem; /* Reduce space between items */
            }
            #guest-nav, #user-info-nav {
                gap: 0.75rem; /* Tighter spacing for icons */
            }
            .nav-icon-btn svg, .nav-icon-btn i {
                width: 24px;  /* Slightly smaller icons */
                height: 24px;
                font-size: 22px;
            }
            .user-avatar {
                width: 32px; /* Slightly smaller avatar */
                height: 32px;
            }
            #guest-nav .jkit-btn {
                padding: 6px 14px; /* Smaller login button */
                font-size: 0.8rem;
                margin-right: 0;
            }
            .navbar-brand-container {
                gap: 0.75rem; /* Space between logo and info icon */
            }
            
            #chat-header { height: 50px; padding: 0 0.5rem; }
            #chat-header .pic { width: 32px; height: 32px; }
            #chat-header-title { font-size: clamp(0.8rem, 4vw, 0.9rem); }
            #chat-input-area { flex-basis: 3.5rem; padding: 0 0.5rem 0 0.75rem; }
            #chat-input-area i.fa-paperclip { margin-right: 0.5rem; }
            #chat-input { padding: 0.5rem 0.75rem; font-size: 0.9rem; margin-right: 0.5rem; }
            div#chat-input-area button#chat-send-btn { padding: 0 0.75rem; }
            .chat-contact-item img { width: 35px; height: 35px; }
            .chat-contact-item .message { display: none; } 

             /* --- START: IMPLEMENTED TIMELINE IMAGE STYLES (Responsive) --- */
            .timeline-image-wrapper {
                flex-basis: 80px;
                min-width: 80px;
                min-height: 80px;
            }
            .timeline-item-content h3 {
                font-size: 1.1rem;
            }
             .timeline-item-content p {
                font-size: 0.9rem;
            }
            /* --- END: IMPLEMENTED TIMELINE IMAGE STYLES (Responsive) --- */
        }
        
        @media (max-width: 188px) {
            html { font-size: 11px; }
            .container { padding: 0 5px; }
            .navbar .container { column-gap: 0.25rem; }
            .navbar-brand { font-size: 1.5rem !important; letter-spacing: -1px; }
            .user-avatar { width: 28px; height: 28px; }
            .nav-icon-btn svg, .nav-icon-btn i { width: 22px; height: 22px; font-size: 20px;}
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.2rem; margin-bottom: 1rem; }
            h3 { font-size: 1rem; }
            .card-image-container { aspect-ratio: 4 / 3; }
            .modal-content { padding: 0.75rem; max-width: 100%; margin: 5px; }
            .form-group { margin-bottom: 0.5rem; }
            .form-group input, .form-group select, .form-group textarea { padding: 6px; font-size: 0.9rem; }
            .dashboard-grid, .profile-layout-grid, .agency-layout-grid { gap: 0.5rem; }
            .jkit-btn { padding: 6px 10px; font-size: 0.8em; }

            .explanation { padding: 0.75rem !important; }
            .explanation h3 { font-size: 0.9rem; }
            .explanation p { font-size: 0.8rem; }
            .explanation i { margin-right: 4px; }

            #chat-input-area { padding: 0 4px; gap: 4px; }
            #chat-input-area i.fa-paperclip { margin-right: 0; }
            #chat-input { padding: 4px 8px; font-size: 0.8rem; margin-right: 0; }
            div#chat-input-area button#chat-send-btn { padding: 0; width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
            div#chat-input-area button#chat-send-btn i { font-size: 0.9rem; }

            /* --- RESPONSIVENESS IMPLEMENTATION --- */
            .chat-message {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
                min-height: 0;
            }
            .dashboard-content, .dashboard-nav {
                padding: 0.75rem;
            }
            .dashboard-nav li button {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            .my-jobs-list li {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .job-list-image, .event-list-image, .news-list-image, .agency-member-list-image {
                width: 32px;
                height: 32px;
            }
            .job-list-title {
                flex-basis: 100%; /* Allow title to take full width */
                order: -1; /* Move title to the top */
                font-size: 0.9em;
            }

            /* --- NEW: Responsive Admin Table (Extreme - 181px+) --- */
            .admin-user-management-panel {
                padding: 0;
                margin: 0;
            }
            .dashboard-content {
                padding: 0.75rem;
            }
            .admin-user-management-panel h3 {
                font-size: clamp(0.85rem, 6vw, 1rem);
                margin-bottom: 0.75rem;
                line-height: 1.3;
            }
            .admin-user-filters {
                padding: 0.75rem;
                gap: 0.75rem;
            }
            .admin-filter-group {
                min-width: 100%;
            }
            .admin-filter-select,
            .admin-search-input {
                padding: 0.6rem;
                font-size: 0.85rem;
            }
            .admin-user-pagination {
                padding: 0.75rem;
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .admin-pagination-info {
                font-size: 0.8rem;
                text-align: center;
            }
            .admin-pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }
            .admin-pagination-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .admin-pagination-page-info {
                font-size: 0.8rem;
            }
            .admin-table-scroll-wrapper {
                gap: 0;
            }
            .admin-scroll-buttons-container {
                display: none !important; /* Hide on mobile */
            }
            .admin-table-container {
                margin: 0;
                padding: 0;
            }
            .admin-user-table tr, .admin-timeline-table tr {
                padding: 0.5rem;
                margin-bottom: 0.75rem;
                border-radius: 6px;
            }
            .admin-user-table td, .admin-timeline-table td {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
                padding: 0.35rem 0;
                font-size: clamp(0.75rem, 4vw, 0.85rem);
                line-height: 1.4;
                word-break: break-word;
                overflow-wrap: break-word;
            }
            .admin-user-table td::before, .admin-timeline-table td::before {
                margin-bottom: 0.2rem;
                font-size: clamp(0.7rem, 3.5vw, 0.75rem);
                text-transform: uppercase;
                color: var(--jkit-text-muted);
                font-weight: 700;
                min-width: 60px;
                flex-shrink: 0;
            }
            .admin-user-table td[data-label="Actions"] {
                align-items: stretch;
                gap: 0.4rem;
                padding-top: 0.5rem;
            }
            .admin-user-table .jkit-btn {
                display: block;
                width: 100%;
                margin: 0;
                box-sizing: border-box;
                padding: clamp(5px, 1.5vw, 8px) clamp(8px, 2vw, 12px);
                font-size: clamp(0.7rem, 3.5vw, 0.75rem);
                max-width: none;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-height: 32px;
            }
            .admin-user-table td[data-label="Full Name"],
            .admin-user-table td[data-label="Username"],
            .admin-user-table td[data-label="Email"],
            .admin-user-table td[data-label="JIN"] {
                word-break: break-all;
            }
            .admin-user-table td[data-label="Verification"] {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                gap: 0.5rem;
            }
            .admin-user-table .toggle-switch {
                min-width: 44px;
                height: 24px;
                flex-shrink: 0;
            }
            .admin-user-table .toggle-switch .slider {
                min-width: 44px;
                height: 24px;
            }
            .admin-user-table .toggle-switch .slider:before {
                height: 18px;
                width: 18px;
            }
            .admin-user-table .toggle-switch input:checked + .slider:before {
                transform: translateX(20px);
            }
            /* Ensure no horizontal overflow */
            .admin-user-management-panel * {
                max-width: 100%;
                box-sizing: border-box;
            }
            /* --- END NEW --- */

            /* --- NEW: Responsive Admin Timeline --- */
            .admin-timeline-table td {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            .admin-timeline-table td::before {
                margin-bottom: 0.25rem;
                font-size: 0.8em;
                text-transform: uppercase;
                color: var(--jkit-text-muted);
            }
            /* --- END NEW --- */

            /* --- FIXED: RESPONSIVENESS IMPLEMENTATION (AGENCY PANEL & PROFILE PANEL) --- */
            #agency-panel h3,
            #profile-panel h3, 
            #profile-panel h4 {
                font-size: 1.1rem;
            }
            #agency-panel .form-group input,
            #agency-panel .form-group textarea,
            #agency-panel .form-group select,
            #profile-panel .form-group input,
            #profile-panel .form-group textarea,
            #profile-panel .form-group select {
                padding: 6px;
                font-size: 0.9em;
            }
            #agency-panel .jkit-btn,
            #profile-panel .jkit-btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }
            #agency-panel #agency-image-preview,
            #profile-panel #profile-avatar-preview {
                width: 100%;
                max-width: 100px;
                height: auto;
            }
            #agency-panel .join-request-item,
            #agency-panel .my-agency-members-list li {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            #agency-panel .request-user-avatar,
            #agency-panel .agency-member-list-image {
                width: 32px;
                height: 32px;
            }
            #agency-panel .request-user-name,
            #agency-panel .agency-member-list-title {
                font-size: 0.9em;
                flex-basis: calc(100% - 37px); /* full width minus image and gap */
            }
            #agency-panel .request-actions {
                 flex-direction: column;
                 align-items: stretch;
            }
            #agency-panel .request-actions .jkit-btn {
                width: 100%;
                margin: 2px 0;
            }
             /* --- START IMPLEMENTATION: Gallery Responsiveness --- */
            #profile-panel .dashboard-gallery-carousel .dashboard-thumbnail-item {
                width: 45px;
                height: 35px;
            }
            #profile-panel .dashboard-gallery-carousel .dashboard-thumbnail-strip {
                gap: 5px;
                padding: 5px;
            }
            #profile-panel .dashboard-gallery-carousel .thumbnail-overlay {
                gap: 5px;
            }
            #profile-panel .dashboard-gallery-carousel .thumb-action-btn {
                font-size: 0.8rem;
                padding: 2px;
            }
            /* --- END IMPLEMENTATION --- */
            /* --- END IMPLEMENTATION --- */
        }
    </style>
</head>
<body>

    <div id="preloader"><div class="spinner"></div></div>

    <div id="toast-notification">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <nav class="navbar">
        <div class="container">
            <div class="navbar-brand-container">
                <a href="#" class="navbar-brand nav-action-item" data-page="home-page">
                    <img src="/jkitlogo.png" alt="J-KIT Logo" class="logo-image">
                </a>
                <a href="#" class="mobile-info-icon nav-action-item" data-page="about-page" aria-label="About J-KIT">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                        <path d="M50,2.5 C23.8,2.5 2.5,23.8 2.5,50s21.3,47.5,47.5,47.5s47.5-21.3,47.5-47.5S76.2,2.5,50,2.5z M50,90 C27.9,90,10,72.1,10,50S27.9,10,50,10s40,17.9,40,40S72.1,90,50,90z"/>
                        <circle cx="50" cy="32" r="8"/>
                        <path d="M56,75H44c-1.1,0-2-0.9-2-2V47c0-1.1,0.9-2,2-2h12c1.1,0,2,0.9,2,2v26C58,74.1,57.1,75,56,75z"/>
                    </svg>
                </a>
                <a href="#" class="mobile-contact-btn nav-action-item" data-page="contact-page" aria-label="Contact"><i class="fas fa-phone"></i></a>
            </div>
            
            <ul class="nav-links" id="main-nav-links">
                <li class="nav-item active"><a href="#" class="nav-link nav-action-item" data-page="home-page">Home</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="about-page">About</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="jobs-page">Jobs</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="people-page">People</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="employers-page">Employers</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="zone-page">Agency</a></li>
                <li class="nav-item"><a href="#" class="nav-link nav-action-item" data-page="contact-page">Contact</a></li>
            </ul>

            <div class="nav-auth">
                <div id="guest-nav">
                    <button id="ai-chat-toggle-guest" class="nav-icon-btn" title="Ask AI Assistant">
                        <i class="fas fa-robot"></i>
                    </button>
                    <a href="#" class="jkit-btn" id="login-btn">Login</a>
                    <a href="#" class="jkit-btn" id="signup-btn">Sign Up</a>
                </div>
                <div id="user-info-nav">
                     <button id="ai-chat-toggle-user" class="nav-icon-btn" title="Ask AI Assistant">
                        <i class="fas fa-robot"></i>
                    </button>
                    <div style="position: relative;">
                        <button id="nav-message-btn" class="nav-icon-btn" title="Open Chat">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 85">
                                <path d="M 5,30 A 10,10 0 0 1 15,20 H 65 A 10,10 0 0 1 75,30 V 50 A 10,10 0 0 1 65,60 H 25 L 10,75 V 60 H 15 A 10,10 0 0 1 5,50 Z" fill="#6FD651"/>
                                <path d="M 25,10 A 10,10 0 0 1 35,0 H 85 A 10,10 0 0 1 95,10 V 30 A 10,10 0 0 1 85,40 H 75 L 60,55 V 40 H 35 A 10,10 0 0 1 25,30 Z" fill="rgba(144, 238, 144, 0.6)" stroke="rgba(255, 255, 255, 0.7)" stroke-width="2"/>
                            </svg>
                            <span id="nav-message-badge" class="notification-badge"></span>
                        </button>
                        <div id="chat-notification-dropdown">
                            <div class="notification-header">Recent Messages</div>
                            <ul id="chat-notification-list"></ul>
                        </div>
                    </div>
                    <div style="position: relative;">
                        <button id="nav-notification-btn" class="nav-icon-btn" title="Notifications">
                            <i class="fas fa-bell"></i>
                            <span id="nav-notification-badge" class="notification-badge"></span>
                        </button>
                        <div id="notification-dropdown">
                            <div class="notification-header">Notifications</div>
                            <ul id="notification-list"></ul>
                        </div>
                    </div>
                    <img src="/jkitlogo.png" alt="User Avatar" class="user-avatar nav-action-item" data-page="dashboard-page" id="nav-user-avatar" title="Go to Dashboard">
                    <button class="jkit-btn nav-action-item" data-page="dashboard-page" id="dashboard-link">Dashboard</button>
                    <button class="jkit-btn jkit-btn-secondary" id="logout-btn" title="Logout"><span class="logout-text">Logout</span><i class="fas fa-key logout-icon"></i></button>
                </div>
            </div>

            <button class="mobile-nav-toggle" id="mobile-nav-toggle-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <main>
        <!-- HOME PAGE -->
        <section id="home-page" class="page-content">
            <div class="hero-section" style="background-image: url('https://images.pexels.com/photos/3184418/pexels-photo-3184418.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');">
                <div class="container">
                    <div class="hero-content">
                        <h1>Find Jobs, Workers and Talents in Namibia.</h1>
                        <p>Your one stop platform for connecting unskilled, skilled and talented individuals to temporary and permanent income earning opportunities across Namibia's formal and informal sectors.</p>
                         <div class="hero-buttons">
                            <button class="jkit-btn nav-action-item" data-page="people-page" data-filter="worker">Find a Worker</button>
                            <button class="jkit-btn jkit-btn-secondary nav-action-item" data-page="people-page" data-filter="talent">Find Talent</button>
                        </div>
                    </div>
                     <div class="airbnb-filters-container">
                        <div class="filter-item flex-grow">
                            <label for="search-home-input">What are you looking for?</label>
                            <input type="text" id="search-home-input" placeholder="Search by name, skill, or J-KIT ID..." style="pointer-events: auto;">
                        </div>
                        <button class="filter-search-btn" id="home-search-btn" aria-label="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="hero-tabs-container">
                        <button class="jkit-btn jkit-btn-secondary nav-action-item" data-page="jobs-page">Find a Job</button>
                        <button class="jkit-btn jkit-btn-secondary nav-action-item" data-page="people-page">Find a Worker/Talent</button>
                        <button class="jkit-btn jkit-btn-secondary nav-action-item" data-page="zone-page">Find an Agent</button>
                    </div>
                </div>
            </div>

            <section class="timeline-section" id="original-timeline-section">
                <div class="container">
                    <h2>J-KIT Timeline</h2>
                    <div class="timeline-container" id="timeline-container">
                        <!-- Timeline events will be rendered here by JS -->
                    </div>
                </div>
            </section>

            <!-- News Section -->
            <section class="news-section">
                <div class="container">
                    <center><h2>Latest News & Trending Stories</h2></center>
                    <div class="news-grid" id="news-grid">
                    </div>
                </div>
            </section>
            
        </section>

        <!-- ABOUT US PAGE -->
        <section id="about-page" class="page-content">
            <div class="container">
                <h2 id="about-page-main-title">About J-KIT</h2>
                <p class="about-tagline" id="about-page-tagline"><%- aboutContent.tagline %></p>
                <div class="about-layout-container" id="about-layout-container">
                    <div class="about-text-content">
                        <h3 id="about-our-story-title"><%- aboutContent.ourStory.title %></h3>
                        <div id="about-our-story-paragraphs">
                            <% aboutContent.ourStory.paragraphs.forEach(p => { %>
                                <p><%- p %></p>
                            <% }) %>
                        </div>
                    </div>
                    <div class="about-image-grid" id="about-our-story-images">
                         <% aboutContent.ourStory.images.forEach(img => { %>
                            <div class="about-grid-image" style="background-image: url('<%- img %>');"></div>
                        <% }) %>
                    </div>
                </div>

                <!-- MODIFICATION: Stats section is now here -->
                <section class="stats-section">
                    <div class="container">
                        <h2>Our Impact in Numbers</h2>
                        <div class="stats-grid" id="stats-grid">
                            <div class="stat-item"><i class="fas fa-users"></i><div class="stat-number" id="total-users">0</div><div class="stat-label">Platform Users</div></div>
                            <div class="stat-item"><i class="fas fa-briefcase"></i><div class="stat-number" id="jobs-available">0</div><div class="stat-label">Jobs Available</div></div>
                            <div class="stat-item"><i class="fas fa-check-circle"></i><div class="stat-number" id="jobs-completed">0</div><div class="stat-label">Jobs Completed</div></div>
                            <div class="stat-item"><i class="fas fa-user-tie"></i><div class="stat-number" id="total-agents">0</div><div class="stat-label">Agents</div></div>
                            <div class="stat-item"><i class="fas fa-handshake"></i><div class="stat-number" id="total-partners">5</div><div class="stat-label">Partners</div></div>
                        </div>
                    </div>
                </section>
                
                <div class="vision-mission-grid" id="vision-mission-grid">
                    <div class="vision-card">
                        <h3 id="about-vision-title"><%- aboutContent.vision.title %></h3>
                        <p id="about-vision-content"><%- aboutContent.vision.content %></p>
                    </div>
                    <div class="mission-card">
                        <h3 id="about-mission-title"><%- aboutContent.mission.title %></h3>
                        <ul class="mission-list" id="about-mission-items">
                             <% aboutContent.mission.items.forEach(item => { %>
                                <li><%- item %></li>
                            <% }) %>
                        </ul>
                    </div>
                </div>
                <div class="about-section" id="values-section">
                    <h3 class="about-section-title" id="about-values-title"><%- aboutContent.values.title %></h3>
                    <div class="values-grid" id="about-values-cards">
                        <% aboutContent.values.cards.forEach(card => { %>
                            <div class="value-card"><i class="<%- card.icon %>"></i><h4><%- card.title %></h4><p><%- card.description %></p></div>
                        <% }) %>
                    </div>
                </div>
                <div class="feature-block" id="feature-block">
                    <div class="container">
                        <center><h2 id="about-how-it-works-title"><%- aboutContent.howItWorks.title %></h2></center>
                        <div class="feature-grid" id="about-how-it-works-items">
                            <% aboutContent.howItWorks.items.forEach(item => { %>
                                <div class="feature-item"><i class="<%- item.icon %>"></i><h3><%- item.title %></h3><p><%- item.description %></p></div>
                            <% }) %>
                        </div>
                    </div>
                </div>
                <div class="problem-solution-grid">
                    <div class="problem-card">
                        <h3 id="about-problem-title"><%- aboutContent.problemSolution.problem.title %></h3>
                        <ul id="about-problem-items">
                            <% aboutContent.problemSolution.problem.items.forEach(item => { %>
                                <li><%- item %></li>
                            <% }) %>
                        </ul>
                    </div>
                    <div class="solution-card">
                        <h3 id="about-solution-title"><%- aboutContent.problemSolution.solution.title %></h3>
                        <ul id="about-solution-items">
                             <% aboutContent.problemSolution.solution.items.forEach(item => { %>
                                <li><%- item %></li>
                            <% }) %>
                        </ul>
                    </div>
                </div>
                <div class="target-audience-section" id="target-audience-section">
                    <h3 id="about-who-we-serve-title"><%- aboutContent.whoWeServe.title %></h3>
                    <div class="audience-grid-four-cols" id="about-who-we-serve-audiences">
                         <% aboutContent.whoWeServe.audiences.forEach(aud => { %>
                            <div class="audience-card">
                                <i class="<%- aud.icon %>"></i>
                                <h4><%- aud.title %></h4>
                                <ul>
                                    <% aud.items.forEach(item => { %>
                                        <li><%- item %></li>
                                    <% }) %>
                                </ul>
                            </div>
                        <% }) %>
                    </div>
                </div>
                <div class="about-cta">
                    <h3 id="about-cta-title"><%- aboutContent.cta.title %></h3>
                    <p id="about-cta-paragraph"><%- aboutContent.cta.paragraph %></p>
                    <button class="jkit-btn nav-action-item" data-page="jobs-page" style="margin-top: 1rem;" id="about-cta-button"><%- aboutContent.cta.buttonText %></button>
                </div>
            </div>
        </section>


        <!-- JOBS PAGE -->
        <section id="jobs-page" class="page-content">
            <div class="page-header">
                <div class="container">
                    <div class="page-header-title-container">
                        <h1>Find Your Next Gig</h1>
                        <button class="jkit-btn" id="post-new-job-from-jobs-page-btn" style="display: none;">
                            <i class="fas fa-plus"></i> Post a New Job
                        </button>
                    </div>
                    <div class="airbnb-filters-container" id="jobs-filter-container">
                        <div class="filter-item flex-grow">
                            <label for="search-jobs-input">Keyword or J-KIT ID</label>
                            <input type="text" id="search-jobs-input" placeholder="e.g., painter, cleaner, JK-NA-..." style="pointer-events: auto;">
                        </div>
                        <div class="filter-item">
                            <label for="job-type-filter">Job Type</label>
                            <select id="job-type-filter">
                                <option value="">All Types</option>
                                <option value="Formal Job">Formal Job</option>
                                <option value="Informal Job">Informal Job</option>
                                <option value="Talent Gig">Talent Gig</option>
                            </select>
                        </div>
                        <div class="filter-item" id="category-filter-item-wrapper">
                            <label>Category</label>
                            <div class="filter-value-display" id="category-filter-display">All Categories</div>
                            <input type="hidden" id="category-jobs-filter" value="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="container"><h2 style="text-align: left; border-bottom: none; margin-bottom: 2rem;">Job Listings</h2><div class="grid-container" id="jobs-grid"></div></div>
        </section>

        <!-- PEOPLE PAGE -->
        <section id="people-page" class="page-content">
            <div class="page-header">
                <div class="container">
                    <h1>Browse Workers and Talents</h1>
                     <div class="people-categories" id="people-type-filter-buttons">
                        <button class="jkit-btn people-cat-btn active" data-filter="all">All People</button>
                        <button class="jkit-btn people-cat-btn" data-filter="worker">Workers</button>
                        <button class="jkit-btn people-cat-btn" data-filter="talent">Talents</button>
                    </div>
                    <div class="airbnb-filters-container">
                        <div class="filter-item flex-grow">
                            <label for="search-people-input">Search by name, skill, or J-KIT ID</label>
                            <input type="text" id="search-people-input" placeholder="e.g., John Doe, cleaning, JK-NA-..." style="pointer-events: auto;">
                        </div>
                        <div class="filter-item" id="worker-category-filter-wrapper">
                            <label>Worker Category</label>
                            <div class="filter-value-display" id="worker-category-filter-display">All Workers</div>
                            <input type="hidden" id="worker-category-filter-input" value="">
                        </div>
                        <div class="filter-item" id="talent-category-filter-wrapper">
                            <label>Talent Category</label>
                            <div class="filter-value-display" id="talent-category-filter-display">All Talents</div>
                            <input type="hidden" id="talent-category-filter-input" value="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="container"><h2>Verified Workers & Creatives</h2><div class="grid-container" id="people-grid"></div></div>
        </section>

        <!-- EMPLOYERS PAGE -->
        <section id="employers-page" class="page-content">
            <div class="page-header">
                <div class="container">
                    <h1>Browse Employers</h1>
                    <!-- No category buttons needed here, strictly search and business type -->
                    <div class="airbnb-filters-container">
                        <div class="filter-item flex-grow">
                            <label for="search-employers-input">Search by Name or J-KIT ID</label>
                            <input type="text" id="search-employers-input" placeholder="e.g., Melrile Guest House, B-JIN-..." style="pointer-events: auto;">
                        </div>
                        <div class="filter-item">
                            <label for="employer-type-filter">Business Type</label>
                            <select id="employer-type-filter">
                                <option value="">All Types</option>
                                <option value="formal">Formal Business</option>
                                <option value="informal">Informal Business</option>
                            </select>
                        </div>
                        <button class="filter-search-btn" id="employers-search-btn" aria-label="Search">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="container">
                <h2 style="text-align: left; border-bottom: none; margin-bottom: 2rem;">Registered Employers</h2>
                <div class="grid-container" id="employers-grid"></div>
            </div>
        </section>

        <!-- AGENCY ZONE PAGE -->
        <section id="zone-page" class="page-content">
             <div class="page-header">
                <h1>Agents</h1>
                <div class="container">
                    <div class="airbnb-filters-container">
                        <div class="filter-item flex-grow">
                            <label for="search-agencies-input">Search by Agency, Agent Name, or J-KIT ID</label>
                            <input type="text" id="search-agencies-input" placeholder="e.g., Frans Man Agency, John Doe, JK-NA-..." style="pointer-events: auto;">
                        </div>
                        <div class="filter-item">
                            <label for="type-agencies-filter">Type of Agency</label>
                            <select id="type-agencies-filter">
                                <option value="">All Types</option>
                                <option value="Corporate Agency">Corporate Agency</option>
                                <option value="Individual Agency">Individual Agency</option>
                                <option value="Group Agency">Group Agency</option>
                                <option value="Talent Agency">Talent Agency</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container"><h2>Recruitment & Management Agencies</h2><div class="grid-container" id="agencies-grid"></div></div>
        </section>
        
        <!-- DASHBOARD PAGE -->
        <section id="dashboard-page" class="page-content"><div class="container"><div id="dashboard-container"></div></div></section>
        
        <!-- CONTACT PAGE -->
        <section id="contact-page" class="page-content">
            <div class="container">
                <h2>Get In Touch</h2>
                 <!-- ================== START: NEW TICKETING FORM ================== -->
                <div class="form-container">
                    <h1>Support Center</h1>
                    <p>Please fill out the form below and our team will respond to you immediately.</p>
                    
                    <form id="ticketForm">
                        <div class="form-group">
                            <label for="fullName">Full Name:</label>
                            <input type="text" id="fullName" name="fullName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email Address:</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number (Optional):</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                        
                        <div class="form-group">
                            <label for="message">How can we help you?</label>
                            <textarea id="message" name="message" rows="6" required></textarea>
                        </div>
                        
                        <button type="submit" id="submitBtn">Submit</button>
                    </form>
                    
                    <div id="statusMessage"></div>
                </div>
                <!-- =================== END: NEW TICKETING FORM =================== -->
            </div>
        </section>
        
        <!-- AGENCY DETAIL PAGE -->
        <section id="agency-detail-page" class="page-content">
             <div class="container">
                <button class="back-btn" id="back-from-agency-btn" data-fallback="zone-page"><i class="fas fa-arrow-left"></i> Back</button>
                <div id="agency-detail-content">
                    <h2 id="agency-detail-page-title">Agency Details</h2>
                    <div class="agency-layout-grid">
                        <aside class="agency-sidebar">
                            <img id="agency-detail-image" alt="Agency Image">
                            <h3 id="agency-detail-name"></h3>
                            <p id="agency-detail-type" class="agency-type-badge"></p>
                            <p class="agency-manager-info">Managed by <strong id="agency-detail-owner-name"></strong></p>
                            
                            <div class="agency-sidebar-actions">
                                <!-- Action buttons here will be rendered by JS -->
                            </div>

                            <div class="agency-sidebar-contact">
                                <h4>Contact Agent</h4>
                                <div id="agency-detail-contact-info"></div>
                            </div>
                        </aside>
                        <div class="agency-main-content">
                            <h3>About this Agency</h3>
                            <p id="agency-detail-description"></p>
                            <h3 id="agency-services-title">Agency Services</h3>
                            <ul id="agency-detail-services-list"></ul>
                            <h3>Agency Members (Workers & Talents)</h3>
                            <div class="members-grid" id="agency-detail-members-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- PROFILE DETAIL PAGE -->
        <section id="profile-detail-page" class="page-content">
            <div class="container">
                <button class="back-btn" id="back-from-profile-btn" data-fallback="people-page"><i class="fas fa-arrow-left"></i> Back</button>
                <h2>Profile detail</h2>
                <div class="profile-layout-grid">
                    <aside class="profile-sidebar">
                        <img src="" alt="Profile Avatar" id="profile-detail-avatar" class="enlargeable-image" style="cursor: pointer;">
                        <h3 id="profile-detail-name"></h3>
                        <div id="profile-detail-rating-summary" class="rating-summary" style="justify-content: center;"></div>
                        <p id="profile-status-badge" class="profile-status-badge">Type of worker talent</p>
                        <div class="profile-contact-info">
                            <a href="#" id="profile-detail-phone"></a>
                        </div>
                        <div class="profile-social-links" id="profile-detail-socials" style="margin-top: 1rem; display: flex; justify-content: center; gap: 1rem;">
                            <!-- Social media icons will be dynamically inserted here -->
                        </div>
                    </aside>
                    <div class="profile-main-content">
                        <h3>About me</h3>
                        <p id="profile-detail-bio">User bio</p>
                        
                        <h3 id="services-title">Services and Prices</h3>
                        <ul id="profile-services-list">
                            <!-- Service items will be dynamically inserted here -->
                        </ul>

                        <h3>Skills</h3>
                        <ul id="profile-skills-list">
                            <!-- Skills will be inserted here -->
                        </ul>

                        <h3>Gallery</h3>
                        <div id="profile-detail-gallery-container">
                            <!-- Content will be injected by JS -->
                        </div>

                        <h3>Previous jobs (history)</h3>
                        <div id="profile-job-history"></div>

                        <div class="profile-action-buttons">
                            <!-- Action buttons here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VERIFICATION SUCCESS PAGE -->
        <section id="verification-success-page" class="page-content">
            <div class="container">
                <div style="max-width: 500px; margin: auto;">
                    <img src="/jkitlogo.png" alt="J-KIT Logo" id="verification-logo" style="max-width: 250px; margin: 0 auto 2rem;">
                    <h1 style="color: #28a745; font-size: 2.5rem; margin-bottom: 1rem;">Success!</h1>
                    <p style="font-size: 1.2rem; color: #333;">Your account has been successfully verified.</p>
                    <p style="font-size: 1rem; color: #666; margin-top: 0.5rem;">You will be automatically logged in and redirected to your dashboard shortly.</p>
                    <div class="spinner" style="margin: 2rem auto; border-top-color: var(--jkit-primary);"></div>
                </div>
            </div>
        </section>

    </main>
    
    <footer class="footer">
        <div class="footer-nav-container container">
            <div class="footer-nav-column">
                <h4>Navigation</h4>
                <ul>
                    <li><a href="#" class="nav-action-item" data-page="home-page">Home</a></li>
                    <li><a href="#" class="nav-action-item" data-page="about-page">About Us</a></li>
                    <li><a href="#" class="nav-action-item" data-page="jobs-page">Jobs</a></li>
                    <li><a href="#" class="nav-action-item" data-page="people-page">People</a></li>
                    <li><a href="#" class="nav-action-item" data-page="employers-page">Employers</a></li>
                    <li><a href="#" class="nav-action-item" data-page="zone-page">Agency Zone</a></li>
                    <li><a href="#" class="nav-action-item" data-page="contact-page">Contact</a></li>
                </ul>
            </div>
            <div class="footer-nav-column">
                <h4>Connect</h4>
                <div class="footer-socials">
                    <a href="#" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" target="_blank" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="#" target="_blank" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    <a href="#" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
        <div class="container">
            <img src="/jkitlogo.png" alt="J-KIT Logo" class="footer-logo">
            <div class="footer-info">
                <span>Erf 4188, 03 Mayo Street, Windhoek West</span> | <span>+264 81 312 2823</span>
            </div>
            <p class="copyright">&copy; 2025 J-KIT cc. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Login to J-KIT</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-username">Username or Email</label>
                    <input type="text" id="login-username" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="login-password" required style="padding-right: 40px;">
                        <i class="fas fa-eye" data-toggle-password style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--jkit-text-muted);"></i>
                    </div>
                </div>
                <button type="submit" class="jkit-btn" style="width: 100%;">Login</button>
            </form>
            
            <div id="resend-verification-container" style="text-align: center; margin-top: 1rem; display: none;">
                <a href="#" id="resend-verification-link" style="font-size: 0.9rem;">Resend verification email</a>
            </div>

            <div class="modal-footer">
                <p>Don't have an account? <a href="#" id="show-signup-link">Sign Up</a></p>
            </div>
        </div>
    </div>
    <div id="signup-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Create Your J-KIT Account</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label for="signup-username">Username</label>
                    <input type="text" id="signup-username" required>
                </div>
                 <div class="form-group">
                    <label for="signup-namibia-id">Namibia ID Number</label>
                    <input type="text" id="signup-namibia-id" required>
                </div>
                <div class="form-group">
                    <label for="signup-email">Email Address</label>
                    <input type="email" id="signup-email" required>
                </div>
                <div class="form-group">
                    <label for="signup-cellphone">Cellphone Number</label>
                    <input type="tel" id="signup-cellphone" required>
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <div style="position: relative;">
                        <input type="password" id="signup-password" required style="padding-right: 40px;">
                        <i class="fas fa-eye" data-toggle-password style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--jkit-text-muted);"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signup-fullname">Full Name</label>
                    <input type="text" id="signup-fullname" required>
                </div>
                <div class="form-group">
                    <label for="signup-type">I am a...</label>
                    <select id="signup-type" required>
                        <option value="Worker">Worker / Job Seeker</option>
                        <option value="Talent">Talent</option>
                        <option value="Employer">Employer / Client</option>
                        <option value="Agent">Agent / Agency Manager</option>
                    </select>
                </div>
                <div class="form-group" id="signup-business-type-group" style="display: none;">
                    <label for="signup-business-type">Business Type</label>
                    <select id="signup-business-type">
                        <option value="formal">Formal Business</option>
                        <option value="informal">Informal Business</option>
                    </select>
                </div>
                <button type="submit" class="jkit-btn" style="width: 100%;">Sign Up</button>
            </form>
            <div class="modal-footer">
                <p>Already have an account? <a href="#" id="show-login-link">Login</a></p>
            </div>
        </div>
    </div>
    <div id="job-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="job-modal-title">Post a New Job</h2><form id="job-form"><input type="hidden" id="job-id"><input type="hidden" id="job-image-path-hidden"><input type="hidden" id="job-assignedTo"><div class="form-group"><label for="job-title">Job Title *</label><input type="text" id="job-title" placeholder="e.g., Professional Painter, Weekend Babysitter" required></div><div class="form-group"><label for="job-type">Job Type *</label><select id="job-type" required><option value="" disabled selected>Select a job type</option><option value="Formal Job">Formal Job</option><option value="Informal Job">Informal Job</option><option value="Talent Gig">Talent Gig</option></select></div><div class="form-group"><label for="job-description">Description & Job Requirements *</label><textarea id="job-description" required></textarea></div><div class="form-group"><label for="job-location">Location (e.g., Windhoek, Mayo Street) *</label><input type="text" id="job-location" required></div><div class="form-group" id="job-price-group"><label for="job-price">Pay Amount (N$) *</label><input type="number" id="job-price" placeholder="e.g., 250" required></div><div class="form-group"><label for="job-payRate">Pay Rate *</label><select id="job-payRate" required><option value="once-off">Once-Off (Total)</option><option value="per hour">Per Hour</option><option value="per day">Per Day</option><option value="per week">Per Week</option><option value="per month">Per Month</option></select></div><div class="form-group"><label for="job-maxPeople">Maximum People Needed *</label><input type="number" id="job-maxPeople" placeholder="e.g., 1" value="1" min="1" required></div><div class="form-group"><label for="job-duration">Job Duration *</label><select id="job-duration" required><option value="Temporal">Temporal</option><option value="Day">Day</option><option value="Hour">Hour</option><option value="Permanent">Permanent</option></select></div><div class="form-group"><label for="job-dueDate">Due Date *</label><input type="date" id="job-dueDate" required></div><div class="form-group"><label>Job Image</label><div class="image-upload-wrapper"><img src="/jkitlogo.png" alt="Job image preview" id="job-image-preview" class="image-preview"><label for="job-image-input" class="image-upload-label">Upload Image</label><input type="file" id="job-image-input" accept="image/*"></div></div><button type="submit" class="jkit-btn" style="width: 100%;">Save Job</button></form></div></div>
    <!-- NEW: Timeline Event Modal -->
    <div id="timeline-event-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="timeline-event-modal-title">Create New Timeline Event</h2><form id="timeline-event-form"><input type="hidden" id="timeline-event-id"><input type="hidden" id="timeline-event-image-path-hidden"><div class="form-group"><label for="timeline-event-title">Event Title</label><input type="text" id="timeline-event-title" required></div><div class="form-group"><label for="timeline-event-description">Description</label><textarea id="timeline-event-description" required></textarea></div><div class="form-group"><label for="timeline-event-date">Date</label><input type="date" id="timeline-event-date" required></div><div class="form-group"><label>Event Image</label><div class="image-upload-wrapper"><img src="/jkitlogo.png" alt="Timeline event image preview" id="timeline-event-image-preview" class="image-preview"><label for="timeline-event-image-input" class="image-upload-label">Upload Image</label><input type="file" id="timeline-event-image-input" accept="image/*"></div></div><button type="submit" class="jkit-btn" style="width: 100%;">Save Timeline Event</button></form></div></div>
    <div id="news-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="news-modal-title">Create News Article</h2><form id="news-form"><input type="hidden" id="news-id"><input type="hidden" id="news-image-path-hidden"><div class="form-group"><label for="news-title">Title</label><input type="text" id="news-title" required></div><div class="form-group"><label for="news-content">Content</label><textarea id="news-content" required style="min-height: 200px;"></textarea></div><div class="form-group"><label>Article Image</label><div class="image-upload-wrapper"><img src="/jkitlogo.png" alt="News image preview" id="news-image-preview" class="image-preview"><label for="news-image-input" class="image-upload-label">Upload Image</label><input type="file" id="news-image-input" accept="image/*"></div></div><button type="submit" class="jkit-btn" style="width: 100%;">Save Article</button></form></div></div>
    <div id="read-more-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="read-more-title"></h2><img src="/jkitlogo.png" alt="News article image" id="read-more-image"><p id="read-more-content"></p></div></div>
    
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="location-modal-title">Agency Location</h2>
            <div id="map-container-modal"></div>
        </div>
    </div>

    <div id="apply-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="apply-modal-job-title">Job Listing</h2>
            <div class="apply-modal-body">
                <div class="apply-modal-image-container">
                    <img src="" alt="Job image" id="apply-modal-main-image" class="apply-modal-main-image">
                    <div id="apply-modal-thumbnail-strip" class="apply-modal-thumbnail-strip"></div>
                </div>
                <div class="apply-modal-details">
                    <ul>
                        <li><strong>Name of job creator</strong><span id="apply-modal-employer"></span></li>
                        <li><strong>Pay Amount</strong><span id="apply-modal-price"></span></li>
                        <li><strong>People Needed</strong><span id="apply-modal-maxPeople"></span></li>
                        <li><strong>Job Duration</strong><span id="apply-modal-duration"></span></li>
                        <li><strong>Location</strong><span id="apply-modal-location"></span></li>
                        <li><strong>Category</strong><span id="apply-modal-category"></span></li>
                        <li><strong>Specific Job Type</strong><span id="apply-modal-specific-job"></span></li>
                        <li><strong>Due Date</strong><span id="apply-modal-date"></span></li>
                        <li><strong>Job Description & Job Requirements</strong><span id="apply-modal-req"></span></li>
                    </ul>
                </div>
            </div>
            <div class="apply-modal-footer">
                 <div class="action-btn-group" id="apply-modal-actions">
                    <button class="action-btn favorite" data-action="favorite" title="Favorite this job"><i class="far fa-heart"></i></button>
                    <button class="action-btn like" data-action="like" title="Like this job"><i class="fas fa-thumbs-up"></i></button>
                    <button class="action-btn dislike" data-action="dislike" title="Dislike this job"><i class="fas fa-thumbs-down"></i></button>
                 </div>
                 <button class="jkit-btn jkit-btn-outline cancel-modal-btn">Cancel</button>
                 <button class="jkit-btn" id="final-apply-btn">Apply for job</button>
            </div>
        </div>
    </div>

    <div id="delete-account-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 style="color: var(--airbnb-red);">Delete Your Account</h2>
            <p>This action is <strong>permanent and cannot be undone</strong>. All of your data, including your profile, jobs, messages, and agency information will be permanently deleted.</p>
            <p style="margin-top: 1rem;">To confirm, please enter your password.</p>
            <form id="delete-account-form">
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label for="delete-confirm-password">Your Password</label>
                    <input type="password" id="delete-confirm-password" required>
                </div>
                <button type="submit" class="jkit-btn jkit-btn-danger" style="width: 100%;">Delete My Account Permanently</button>
            </form>
        </div>
    </div>
    
    <div id="specific-job-popup" class="filter-popup">
        <div class="filter-popup-header">
            <h4 id="specific-job-popup-title">Specific Jobs</h4>
            <button class="close-btn" id="specific-job-popup-close">&times;</button>
        </div>
        <div class="filter-popup-list">
            <ul id="specific-job-list" ></ul>
        </div>
        <div class="filter-popup-footer">
            <button class="scroll-bottom-btn">Scroll to Bottom <i class="fas fa-chevron-down"></i></button>
        </div>
        <div class="scroll-to-top-wrapper">
            <button class="scroll-to-top-btn" aria-label="Scroll to top"><i class="fas fa-arrow-up"></i></button>
            <div class="scroll-to-top-text">Scroll to Top</div>
        </div>
    </div>

    <div id="cv-modal" class="modal">
        <div class="modal-content" style="max-width: 900px; height: 90vh;">
            <span class="close-btn">&times;</span>
            <h2 id="cv-modal-title">CV / Resume</h2>
            <div id="cv-viewer-container" style="width: 100%; height: calc(100% - 60px); border: 1px solid var(--jkit-border-color);">
                <iframe src="" style="width: 100%; height: 100%; border: none;" title="CV Viewer"></iframe>
            </div>
        </div>
    </div>

    <!-- NEW: Event View More Modal -->
    <div id="event-view-more-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <img src="" alt="Event Image" id="event-modal-image-view" style="width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 12px; margin-bottom: 1.5rem;">
            <h2 id="event-modal-title-view" style="text-align: left; margin-bottom: 1rem;"></h2>
            <div style="display: flex; gap: 1.5rem; color: var(--jkit-text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
                <span><i class="fas fa-calendar-alt"></i> <span id="event-modal-date-view"></span></span>
                <span><i class="fas fa-map-marker-alt"></i> <span id="event-modal-location-view"></span></span>
            </div>
            <p id="event-modal-description-view" style="max-height: 50vh; overflow-y: auto;"></p>
            <div id="event-modal-link-container-view" style="margin-top: 2rem; text-align: right;"></div>
        </div>
    </div>

    <!-- NEW: Modals for Admin Job Category Management -->
    <div id="job-category-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="job-category-modal-title">Create New Job Category</h2>
            <form id="job-category-form">
                <input type="hidden" id="job-category-original-name">
                <div class="form-group">
                    <label for="job-category-name">Category Name</label>
                    <input type="text" id="job-category-name" required>
                </div>
                <button type="submit" class="jkit-btn" style="width: 100%;">Save Category</button>
            </form>
        </div>
    </div>
    <div id="specific-job-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="specific-job-modal-title">Add New Job Type</h2>
            <form id="specific-job-form">
                <input type="hidden" id="specific-job-category-name">
                <input type="hidden" id="specific-job-original-name">
                <div class="form-group">
                    <label for="specific-job-name">Job Type Name</label>
                    <input type="text" id="specific-job-name" required>
                </div>
                <button type="submit" class="jkit-btn" style="width: 100%;">Save Job Type</button>
            </form>
        </div>
    </div>
    
    <!-- NEW: RATING MODAL -->
    <div id="rating-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Rate Worker/Talent</h2>
            <p>Please provide a rating for the work done by <strong id="rating-modal-worker-name"></strong> for the job: <strong id="rating-modal-job-title"></strong>.</p>
            <form id="rating-form">
                <input type="hidden" id="rating-job-id">
                <input type="hidden" id="rating-worker-username">
                <div class="form-group">
                    <label>Your Rating</label>
                    <div class="stars-input">
                        <i class="far fa-star" data-value="1"></i>
                        <i class="far fa-star" data-value="2"></i>
                        <i class="far fa-star" data-value="3"></i>
                        <i class="far fa-star" data-value="4"></i>
                        <i class="far fa-star" data-value="5"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="rating-comment">Comment (Optional)</label>
                    <textarea id="rating-comment" placeholder="Provide details about your experience..."></textarea>
                </div>
                <button type="submit" class="jkit-btn" style="width: 100%;">Submit Rating</button>
            </form>
        </div>
    </div>


    <nav class="mobile-bottom-nav">
        <a href="#" class="mobile-nav-item nav-action-item active" data-page="home-page">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="#" class="mobile-nav-item nav-action-item" data-page="jobs-page">
            <i class="fas fa-search"></i>
            <span>Jobs</span>
        </a>
        <a href="#" class="mobile-nav-item nav-action-item" data-page="people-page">
            <i class="fas fa-user"></i>
            <span>People</span>
        </a>
        <a href="#" class="mobile-nav-item nav-action-item" data-page="employers-page">
            <i class="fas fa-briefcase"></i>
            <span>Employers</span>
        </a>
        <a href="#" class="mobile-nav-item nav-action-item" data-page="zone-page">
            <i class="fas fa-user-tie"></i>
            <span>Agents</span>
        </a>
    </nav>

    <!-- Chat Popup -->
    <div id="chat-popup">
        <div id="chat-contacts-list">
            <div class="chat-contacts-header">
                <div class="chat-contacts-sort">Latest First <i class="fas fa-chevron-down"></i></div>
                <button id="chat-contacts-ai-btn" class="chat-contacts-add-btn" title="Ask AI Assistant"><i class="fas fa-robot"></i></button>
            </div>
            <div class="chat-contacts-body">
                <!-- Matched users will be populated here -->
            </div>
        </div>
        <div class="chat-main">
            <div id="chat-header">
                <button id="chat-contacts-toggle"><i class="fas fa-chevron-right"></i></button>
                <img id="chat-header-pic" src="/jkitlogo.png" alt="Avatar" class="pic">
                <div id="chat-header-info">
                    <div id="chat-header-title">Chat</div>
                    <div id="chat-header-status"></div>
                </div>
                <div id="chat-controls">
                    <button id="chat-close-btn"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div id="chat-conversation-area" style="display: none;">
                <div id="chat-messages"></div>
                <form id="chat-form">
                    <div id="chat-input-area">
                        <i class="fas fa-paperclip"></i>
                        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" required>
                        <button type="submit" class="jkit-btn" id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </form>
            </div>
            <div id="no-active-chat-placeholder">
                <i class="fas fa-comments"></i>
                <p>Select a contact to start chatting.</p>
            </div>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div id="image-viewer-modal" class="modal">
        <span class="close-btn" id="image-viewer-close">&times;</span>
        <img class="modal-content" id="image-viewer-content" alt="Enlarged View">
    </div>

    <script src="/socket.io/socket.io.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =========================================================================
            //  1. GLOBAL STATE & DATA INITIALIZATION
            // =========================================================================
            
            let initialContent = <%- JSON.stringify(content || {}) %>;
            let currentUser = <%- JSON.stringify(currentUser || null) %>;
            
            let settings = <%- JSON.stringify(settings || {}) %>;
            let aboutContent = <%- JSON.stringify(aboutContent || {}) %>; 

            let allJobs = initialContent.jobs || [];
            let allProfiles = initialContent.profiles || [];
            let allAgencies = initialContent.agencies || [];
            let allJobCategories = initialContent.jobCategories || [];
            let allUsers = initialContent.users || [];
            let allLikes = initialContent.likes || [];
            let allAgencyRequests = initialContent.agencyRequests || [];
            let allEventLogs = initialContent.eventLogs || [];
            let allNotifications = initialContent.notifications || [];
            let allFollowers = initialContent.followers || [];
            let allNewsArticles = initialContent.newsArticles || [];
            let allConversations = initialContent.conversations || [];
            let allTimelineEvents = initialContent.timelineEvents || [];
            let allRatings = initialContent.ratings || []; // <-- NEW

            let currentDetailView = { type: null, id: null };
            const onlineUsers = new Set();
            
            // --- UPDATED FALLBACK IMAGES TO LOGO ---
            const FALLBACK_PERSON_IMG = '/jkitlogo.png';
            const FALLBACK_JOB_IMG = '/jkitlogo.png';
            const FALLBACK_AGENCY_IMG = '/jkitlogo.png';
            const FALLBACK_EVENT_IMG = '/jkitlogo.png';
            const AI_ASSISTANT_ID = 'ai_assistant';

            const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCLsFTJJo5O9JU6C78gmH7Kv-wg74EW4i4okErEZQO429gCHNsYsMjYeaHKBMCBlpX/exec"; 

            let DEFAULT_PERSON_AVATAR = settings.defaultPersonAvatar || FALLBACK_PERSON_IMG;
            let DEFAULT_AGENCY_AVATAR = settings.defaultAgencyAvatar || FALLBACK_AGENCY_IMG;
            let GLOBAL_FALLBACK_IMAGE = settings.globalFallbackImage || '/jkitlogo.png';
            
            let isInitialLoad = true;
            
            // =========================================================================
            //  2. UI, SPA NAVIGATION & MODALS
            // =========================================================================
            
            const locationModal = document.getElementById('location-modal');
            const cvModal = document.getElementById('cv-modal');
            const newsModal = document.getElementById('news-modal');
            const readMoreModal = document.getElementById('read-more-modal');
            const deleteAccountModal = document.getElementById('delete-account-modal');
            const jobCategoryModal = document.getElementById('job-category-modal');
            const specificJobModal = document.getElementById('specific-job-modal');
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const loginModal = document.getElementById('login-modal'); 
            const signupModal = document.getElementById('signup-modal'); 
            const jobModal = document.getElementById('job-modal'); 
            const applyModal = document.getElementById('apply-modal'); 
            const timelineEventModal = document.getElementById('timeline-event-modal');
            const ratingModal = document.getElementById('rating-modal'); // <-- NEW
            const modals = [loginModal, signupModal, jobModal, applyModal, locationModal, cvModal, newsModal, readMoreModal, deleteAccountModal, jobCategoryModal, specificJobModal, imageViewerModal, timelineEventModal, ratingModal]; // <-- NEW
            
            function showModal(modal) { 
                modals.forEach(m => m.style.display = 'none'); 
                modal.style.display = 'flex'; 
                document.documentElement.classList.add('filter-popup-open');
                document.body.classList.add('filter-popup-open');
            } 
            function closeModal() { 
                modals.forEach(m => m.style.display = 'none'); 
                document.documentElement.classList.remove('filter-popup-open');
                document.body.classList.remove('filter-popup-open');
            }
            
            function closeModalWithHistory() {
                if (history.state && history.state.modal) {
                    history.back(); 
                } else {
                    closeModal(); 
                }
            }

            document.getElementById('login-btn').addEventListener('click', (e) => { e.preventDefault(); showModal(loginModal); }); 
            document.getElementById('signup-btn').addEventListener('click', (e) => { e.preventDefault(); showModal(signupModal); }); 
            document.getElementById('show-signup-link').addEventListener('click', (e) => { e.preventDefault(); showModal(signupModal); }); 
            document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); showModal(loginModal); }); 
            
            modals.forEach(m => {
                if(m) {
                    const isHistoryModal = (m.id === 'apply-modal' || m.id === 'image-viewer-modal');
                    const closeFunction = isHistoryModal ? closeModalWithHistory : closeModal;

                    const closeBtn = m.querySelector('.close-btn');
                    if (closeBtn) { closeBtn.addEventListener('click', closeFunction); }

                    const cancelBtn = m.querySelector('.cancel-modal-btn');
                    if (cancelBtn) { cancelBtn.addEventListener('click', closeFunction); }

                    m.addEventListener('click', (e) => {
                        if (e.target === m) closeFunction();
                    });
                }
            });

            function showToast(message, type = 'info', duration = 4000) {
                const toast = document.getElementById('toast-notification');
                const iconSpan = document.getElementById('toast-icon');
                const messageSpan = document.getElementById('toast-message');

                toast.className = ''; // Reset classes
                iconSpan.innerHTML = '';

                let iconHTML = '';
                if (type === 'success') {
                    iconHTML = '<i class="fas fa-check-circle"></i>';
                } else if (type === 'error') {
                    iconHTML = '<i class="fas fa-exclamation-circle"></i>';
                } else if (type === 'info') {
                    iconHTML = '<i class="fas fa-info-circle"></i>';
                } else if (type === 'loading') {
                    iconHTML = '<div class="spinner"></div>';
                }

                iconSpan.innerHTML = iconHTML;
                messageSpan.textContent = message;
                toast.classList.add(type);
                toast.classList.add('show');

                if (duration > 0) {
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, duration);
                }
                return toast;
            }

            const pages = document.querySelectorAll('.page-content'); const navbar = document.querySelector('.navbar'); 
            
            window.showPage = function(pageId, options = {}, fromPopState = false) {
                const { sectionId, stateParams, replaceHistory, filter } = options;

                const currentPage = document.querySelector('.page-content.active-page');
                const listPages = ['home-page', 'jobs-page', 'people-page', 'zone-page', 'employers-page'];
                if (currentPage && listPages.includes(currentPage.id) && currentPage.id !== pageId) {
                    sessionStorage.setItem('jkit_previousListPage', currentPage.id);
                }
                
                if (pageId === 'verification-success-page') {
                    document.body.classList.add('success-page-active');
                } else {
                    document.body.classList.remove('success-page-active');
                }

                if (currentPage && currentPage.id === pageId) {
                    if (sectionId) {
                            const sectionToScroll = document.getElementById(sectionId);
                            if (sectionToScroll) sectionToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    return;
                }
                
                if (!pageId.includes('-detail-')) {
                    currentDetailView = { type: null, id: null };
                }

                const currentlyHighlighted = document.querySelector('.section-highlight');
                if (currentlyHighlighted) {
                    currentlyHighlighted.classList.remove('section-highlight');
                }
                
                pages.forEach(page => page.classList.remove('active-page')); 
                const targetPage = document.getElementById(pageId); 
                if (targetPage) { 
                    targetPage.classList.add('active-page'); 
                } 
                document.querySelectorAll('.nav-item').forEach(item => { 
                    item.classList.toggle('active', item.querySelector(`[data-page="${pageId}"]`) != null); 
                }); 
                
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.page === pageId);
                });

                if (pageId === 'people-page' && filter) {
                    setTimeout(() => { // Use timeout to ensure page is visible before manipulating filters
                        const filterButtons = document.querySelectorAll('#people-type-filter-buttons .people-cat-btn');
                        filterButtons.forEach(btn => {
                            btn.classList.toggle('active', btn.dataset.filter === filter);
                        });
                        // This will trigger the filtering logic in setupFilters
                        document.querySelector(`#people-type-filter-buttons [data-filter="${filter}"]`).click();
                    }, 50);
                }

                if (sectionId) {
                    const sectionToHighlight = document.getElementById(sectionId);
                    if (sectionToHighlight) {
                        setTimeout(() => {
                            sectionToHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            sectionToHighlight.classList.add('section-highlight');
                            
                            setTimeout(() => {
                                const removeHighlightOnScroll = () => {
                                    sectionToHighlight.classList.remove('section-highlight');
                                };
                                window.addEventListener('scroll', removeHighlightOnScroll, { once: true });
                            }, 800);
                        }, 150);
                    } else {
                        window.scrollTo(0, 0); 
                    }
                } else {
                    window.scrollTo(0, 0); 
                }

                const bodyBgPages = ['home-page']; 
                if (bodyBgPages.includes(pageId)) { 
                    document.body.style.backgroundColor = 'var(--jkit-dark-alt)'; 
                    if (window.scrollY <= 50) { 
                        navbar.classList.remove('scrolled'); 
                    } 
                } else { 
                    document.body.style.backgroundColor = 'var(--jkit-bg)'; 
                    navbar.classList.add('scrolled'); 
                }

                if (!fromPopState) {
                    const urlParams = new URLSearchParams(stateParams || {}).toString();
                    const url = `#${pageId}${urlParams ? '?' + urlParams : ''}`;
                    const state = { page: pageId, params: stateParams || {} };
                    
                    if (isInitialLoad || replaceHistory) {
                        history.replaceState(state, '', url);
                        isInitialLoad = false;
                    } else {
                        history.pushState(state, '', url);
                    }
                    localStorage.setItem('jkit_lastActiveState', JSON.stringify(state));
                }
            }
            
            window.addEventListener('popstate', (event) => {
                const imageViewerModal = document.getElementById('image-viewer-modal');
                const applyModal = document.getElementById('apply-modal');
                const chatPopup = document.getElementById('chat-popup');

                if (!(event.state && event.state.modal) && (
                    (imageViewerModal && imageViewerModal.style.display === 'flex') ||
                    (applyModal && applyModal.style.display === 'flex') ||
                    (chatPopup && chatPopup.style.display === 'flex')
                )) {
                    // Close any history-driven popups/modals
                    closeModal(); 
                    if (chatPopup && chatPopup.style.display === 'flex') closeChat();
                }

                if (event.state && event.state.page) {
                    const { page, params } = event.state;
                    if (page === 'profile-detail-page' && params.username) {
                        openProfileDetailPage(params.username, true);
                    } else if (page === 'agency-detail-page' && params.id) {
                        renderAgencyDetailPage(params.id, true);
                    } else {
                        window.showPage(page, {}, true);
                    }
                } else {
                    window.showPage('home-page', {}, true);
                }
            });

            document.querySelectorAll('.nav-action-item').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = e.currentTarget.dataset.page; const filter = e.currentTarget.dataset.filter; if (pageId) { window.showPage(pageId, { filter }); } document.getElementById('main-nav-links').classList.remove('active'); const toggleIcon = document.querySelector('.mobile-nav-toggle i'); if(toggleIcon) toggleIcon.classList.replace('fa-times', 'fa-bars'); }); }); document.getElementById('mobile-nav-toggle-btn').addEventListener('click', (e) => { document.getElementById('main-nav-links').classList.toggle('active'); const icon = e.currentTarget.querySelector('i'); icon.classList.toggle('fa-bars'); icon.classList.toggle('fa-times'); }); window.addEventListener('scroll', () => { const activePage = document.querySelector('.page-content.active-page'); if (activePage && activePage.id === 'home-page') { if (window.scrollY > 50) { navbar.classList.add('scrolled'); } else { navbar.classList.remove('scrolled'); } } }); 
        
            function displayImage(imgElement, imagePath, fallbackSrc) {
                // 1. Define the absolute fallback (The Logo)
                const defaultLogo = '/jkitlogo.png';
                
                // 2. Define the secondary fallback passed to the function
                const secondaryFallback = fallbackSrc || defaultLogo;

                console.log('displayImage called with:', { imagePath, fallbackSrc, defaultLogo, secondaryFallback });

                // 3. Logic to determine initial source
                if (imagePath && (imagePath.startsWith('/uploads/') || imagePath.startsWith('http'))) {
                    console.log('Setting image to uploaded/http path:', imagePath);
                    imgElement.src = imagePath;
                } else {
                    console.log('Setting image to fallback:', secondaryFallback);
                    imgElement.src = secondaryFallback;
                }

                console.log('Image element src after setting:', imgElement.src);

                // 4. Error Handler: If the image fails (404), load the logo
                imgElement.onerror = function() {
                    console.log('Image failed to load, attempting fallback. Current src:', this.src);
                    // Prevent infinite loop: if the current src is ALREADY the logo, stop.
                    if (this.src.includes('jkitlogo.png')) {
                        console.log('Already using logo fallback, stopping');
                        return; 
                    }
                    console.log('Falling back to logo:', defaultLogo);
                    this.src = defaultLogo;
                    // Remove onerror to prevent infinite loops if the logo is also missing
                    this.onerror = null; 
                };
            }

            function openLocationModal(locationString, agencyName) {
                const modal = document.getElementById('location-modal');
                const title = document.getElementById('location-modal-title');
                const mapContainer = document.getElementById('map-container-modal');
                
                title.textContent = `Location for ${agencyName}`;
                showModal(modal);

                // Delay map initialization to ensure modal is visible
                setTimeout(() => {
                    mapContainer.innerHTML = ''; // Clear previous map
                    try {
                        const map = L.map(mapContainer);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        // Use Nominatim to geocode the address
                        fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationString)}&format=json&limit=1`)
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.length > 0) {
                                    const lat = parseFloat(data[0].lat);
                                    const lon = parseFloat(data[0].lon);
                                    map.setView([lat, lon], 14);
                                    L.marker([lat, lon]).addTo(map)
                                        .bindPopup(`<b>${agencyName}</b><br>${locationString}`)
                                        .openPopup();
                                } else {
                                    mapContainer.innerHTML = `<p style="padding: 2rem; text-align: center; color: var(--jkit-text-muted);">Could not find location: ${locationString}</p>`;
                                }
                            })
                            .catch(error => {
                                console.error('Geocoding error:', error);
                                mapContainer.innerHTML = `<p style="padding: 2rem; text-align: center; color: var(--jkit-text-muted);">Error loading map. Please try again later.</p>`;
                            });
                    } catch (e) {
                         mapContainer.innerHTML = `<p style="padding: 2rem; text-align: center; color: var(--jkit-text-muted);">Error initializing map. It may have already been initialized.</p>`;
                    }
                }, 100);
            }


            function openImageViewer(src) {
                const modalImg = document.getElementById('image-viewer-content');
                if (src) {
                    const state = { modal: 'image-viewer' };
                    const title = 'Image View';
                    const url = '#image-viewer';
                    if (!(history.state && history.state.modal === 'image-viewer')) {
                        history.pushState(state, title, url);
                    }
                    
                    modalImg.src = src;
                    showModal(imageViewerModal);
                }
            }
            
            // =========================================================================
            //  3. AUTHENTICATION (Client-side)
            // =========================================================================
            
            function updateNavUI() {
                const guestNav = document.getElementById('guest-nav');
                const userNav = document.getElementById('user-info-nav');
                const avatarElement = document.getElementById('nav-user-avatar');
                const postJobBtnJobsPage = document.getElementById('post-new-job-from-jobs-page-btn');

                if (currentUser) {
                    guestNav.style.display = 'none';
                    userNav.style.display = 'flex';
                    const profile = allProfiles.find(p => p.username === currentUser.username);
                    if (profile) {
                        displayImage(avatarElement, profile.avatarPath, DEFAULT_PERSON_AVATAR);
                    }
                    if (postJobBtnJobsPage) {
                        postJobBtnJobsPage.style.display = 'inline-flex';
                    }
                } else {
                    guestNav.style.display = 'flex';
                    userNav.style.display = 'none';
                    if (postJobBtnJobsPage) postJobBtnJobsPage.style.display = 'none';
                }
            }

            async function sendVerificationEmail(emailData) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'newUserSignup', ...emailData })
                    });
                } catch (error) {
                    console.error("Failed to send verification email via Apps Script:", error);
                    // This error won't be shown to the user, but it's important for debugging.
                }
            }

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging in...';

                const resendContainer = document.getElementById('resend-verification-container');
                resendContainer.style.display = 'none';

                const payload = { loginIdentifier: document.getElementById('login-username').value, password: document.getElementById('login-password').value };
                try {
                    const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await response.json();
                    
                    if (!response.ok) { 
                        if (result.notVerified) {
                            resendContainer.style.display = 'block';
                            resendContainer.querySelector('#resend-verification-link').dataset.email = result.email;
                        }
                        throw new Error(result.message); 
                    }
                    showToast('Login successful!', 'success');
                    
                    currentUser = result.user;
                    initializeSocketIO();
                    updateNavUI();
                    renderDashboardPage();
                    closeModal();
                    showPage('dashboard-page', {});

                } catch (error) { 
                    showToast(`Login failed: ${error.message}`, 'error'); 
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Login';
                }
            });

            // Show/hide business type field based on account type
            document.getElementById('signup-type').addEventListener('change', function() {
                const businessTypeGroup = document.getElementById('signup-business-type-group');
                if (this.value === 'Employer') {
                    businessTypeGroup.style.display = 'block';
                    document.getElementById('signup-business-type').required = true;
                } else {
                    businessTypeGroup.style.display = 'none';
                    document.getElementById('signup-business-type').required = false;
                }
            });

            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating Account...';

                const accountType = document.getElementById('signup-type').value;
                const payload = { 
                    username: document.getElementById('signup-username').value.trim(), 
                    email: document.getElementById('signup-email').value.trim(), 
                    cellphone: document.getElementById('signup-cellphone').value.trim(), 
                    password: document.getElementById('signup-password').value, 
                    fullName: document.getElementById('signup-fullname').value, 
                    type: accountType,
                    namibiaId: document.getElementById('signup-namibia-id').value.trim()
                };

                // Include businessType if account type is Employer
                if (accountType === 'Employer') {
                    payload.businessType = document.getElementById('signup-business-type').value;
                }

                try {
                    const response = await fetch('/api/signup', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) { 
                        throw new Error(result.message); 
                    }

                    if (result.emailData) {
                        sendVerificationEmail(result.emailData);
                    }

                    showToast(result.message, 'success', 6000); 
                    showModal(loginModal);
                
                } catch (error) { 
                    showToast(`Signup failed: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Sign Up';
                }
            });
            
            document.getElementById('logout-btn').addEventListener('click', async (e) => {
                e.preventDefault();
                try { 
                    await fetch('/api/logout', { method: 'POST' }); 
                    localStorage.removeItem('jkit_lastActiveState');
                    sessionStorage.removeItem('jkit_previousListPage');
                    window.location.href = '/';
                } catch (error) { showToast('Logout failed. Please try again.', 'error'); }
            });
            
            document.getElementById('resend-verification-link')?.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = e.target.dataset.email;
                if (!email) {
                    showToast('Could not find the email address. Please type it in the field above.', 'error');
                    return;
                }
                const toast = showToast('Sending new verification email...', 'loading', 0);
                try {
                    const response = await fetch('/api/users/resend-verification', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const result = await response.json();
                    if (!response.ok || !result.success) throw new Error(result.message);
                    
                    if (result.emailData) {
                        await sendVerificationEmail(result.emailData);
                    }
                    toast.remove();
                    showToast(result.message, 'success');
                } catch (error) {
                    toast.remove();
                    showToast('An error occurred. Please try again.', 'error');
                }
            });

            async function verifyAccount(token) {
                // Preloader is already running, so we don't need to show it again.
                // We will hide it inside the success/error blocks.
                try {
                    const response = await fetch('/api/users/verify-account', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    currentUser = result.user;
                    initializeSocketIO();
                    updateNavUI();
                    renderDashboardPage();
                    closeModal();

                    const successPage = document.getElementById('verification-success-page');
                    const logo = document.getElementById('verification-logo');

                    const showSuccessAndRedirect = () => {
                        document.getElementById('preloader').classList.add('loaded');
                        showPage('verification-success-page', { replaceHistory: true });
                        successPage.classList.add('visible'); // Fade in the page
                        setTimeout(() => { // Redirect after a delay
                            showPage('dashboard-page', { replaceHistory: true });
                            history.replaceState({ page: 'dashboard-page' }, '', '#dashboard-page');
                        }, 500); // 0.5-second delay
                    };
                    
                    if (logo.complete) {
                        showSuccessAndRedirect();
                    } else {
                        logo.onload = showSuccessAndRedirect;
                        logo.onerror = showSuccessAndRedirect;
                    }

                } catch (error) {
                    document.getElementById('preloader').classList.add('loaded');
                    showToast(`Verification failed: ${error.message}`, 'error', 6000);
                    setTimeout(() => { // Redirect to home page on failure
                        showPage('home-page', { replaceHistory: true });
                        history.replaceState({ page: 'home-page' }, '', '#home-page');
                    }, 500);
                }
            }
            
            // =========================================================================
            //  4. CONTENT RENDERING (Reads from global state)
            // =========================================================================

            function getInteractionButtonsHTML(itemId, itemType) {
                // --- MODIFICATION: Top interactions have been moved to the footer for all card types ---
                if (itemType === 'person' || itemType === 'agency' || itemType === 'employer' || itemType === 'job' || itemType === 'news') {
                    return '';
                }
                return ''; // Return empty for any other case as well
            }
            
            function getFooterInteractionsHTML(itemId) {
                const likeCount = allLikes.flatMap(l => l.likedItems || []).filter(id => id === itemId).length;
                const dislikeCount = allLikes.flatMap(l => l.dislikedItems || []).filter(id => id === itemId).length;

                let isLiked = false;
                let isDisliked = false;

                if (currentUser) {
                    const userRatings = allLikes.find(l => l.username === currentUser.username);
                    isLiked = userRatings?.likedItems?.includes(itemId);
                    isDisliked = userRatings?.dislikedItems?.includes(itemId);
                }

                return `
                    <div class="card-footer-interactions">
                        <div class="interaction-item" title="Likes">
                            <button class="rating-btn ${isLiked ? 'thumb-liked' : ''}" data-item-id="${itemId}" data-rating="like"><i class="fas fa-thumbs-up"></i></button>
                            ${likeCount > 0 ? `<span class="count">${likeCount}</span>` : ''}
                        </div>
                        <div class="interaction-item" title="Dislikes">
                            <button class="rating-btn ${isDisliked ? 'disliked' : ''}" data-item-id="${itemId}" data-rating="dislike"><i class="fas fa-thumbs-down"></i></button>
                            ${dislikeCount > 0 ? `<span class="count">${dislikeCount}</span>` : ''}
                        </div>
                    </div>
                `;
            }

            function getFollowButtonHTML(username, sizeClass = 'btn-small') {
                if (!currentUser || currentUser.username === username) {
                    return ''; 
                }
                const isFollowing = allFollowers.some(f => f.user === username && f.follower === currentUser.username);
                const buttonText = isFollowing ? 'Following' : 'Follow';
                const buttonClass = isFollowing ? 'jkit-btn-outline' : 'jkit-btn';

                return `<button class="jkit-btn ${buttonClass} ${sizeClass} follow-btn" data-username="${username}">${buttonText}</button>`;
            }
            
            // --- NEW: RATING DISPLAY FUNCTION ---
            function getRatingStarsHTML(profile) {
                if (!profile || !profile.ratingCount || profile.ratingCount === 0) {
                    return '<div class="rating-summary"><span class="rating-count">Not Rated</span></div>';
                }

                const rating = profile.averageRating || 0;
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.5 ? 1 : 0;
                const emptyStars = 5 - fullStars - halfStar;

                let starsHTML = '';
                for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star"></i>';
                if (halfStar) starsHTML += '<i class="fas fa-star-half-alt"></i>';
                for (let i = 0; i < emptyStars; i++) starsHTML += '<i class="far fa-star"></i>';
                
                const plural = profile.ratingCount === 1 ? 'rating' : 'ratings';

                return `
                    <div class="rating-summary">
                        <div class="stars">${starsHTML}</div>
                        <span class="rating-count">(${profile.ratingCount} ${plural})</span>
                    </div>
                `;
            }

            function renderHomePage() {
                renderNewsSection();
                renderTimelineSection();
            }

            function renderTimelineSection() {
                const container = document.getElementById('timeline-container');
                if (!container) return;

                if (!allTimelineEvents || allTimelineEvents.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--jkit-text-muted);">The timeline of our journey will be shared here soon.</p>';
                    return;
                }

                container.innerHTML = allTimelineEvents
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) // Ensure sorted by date descending
                    .map((event, index) => {
                        const positionClass = index % 2 === 0 ? 'left' : 'right';
                        const eventDate = new Date(event.date);
                        const formattedDate = eventDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        
                        const imagePath = event.imagePath || GLOBAL_FALLBACK_IMAGE;
                        const imageHTML = `<div class="timeline-image-wrapper">
                                <img src="${imagePath}" alt="${event.title}" class="timeline-event-image">
                            </div>`;
                        
                        return `
                            <div class="timeline-item ${positionClass}">
                                <div class="timeline-item-content">
                                    <div class="timeline-text-wrapper">
                                        <span class="timeline-date">${formattedDate}</span>
                                        <h3>${event.title}</h3>
                                        <p>${event.description}</p>
                                    </div>
                                    ${imageHTML}
                                </div>
                            </div>
                        `;
                    }).join('');
            }
            
            function renderJobsPage(filterText = '', filterJobType = '', filterCategory = '', filterSpecificJob = '') {
                const grid = document.getElementById('jobs-grid'); grid.innerHTML = '';
                const today = new Date(); today.setHours(0, 0, 0, 0);

                const filteredJobs = allJobs.filter(job => { 
                    const isValid = new Date(job.dueDate) >= today && (job.status === 'open' || job.status === 'in-progress');
                    if (!isValid) return false;
                    
                    const postedByUser = allUsers.find(u => u.username === job.postedBy);
                    const lowerFilterText = filterText.toLowerCase(); 

                    if (/^\d{8}$/.test(filterText)) {
                        return postedByUser && postedByUser.jkitId && postedByUser.jkitId === filterText;
                    }

                    const matchesText = !filterText || (job.title && job.title.toLowerCase().includes(lowerFilterText)) || (job.description && job.description.toLowerCase().includes(lowerFilterText)) || (job.location && job.location.toLowerCase().includes(lowerFilterText));
                    
                    const matchesJobType = !filterJobType || job.jobType === filterJobType;
                    const matchesCategory = !filterCategory || job.category === filterCategory; 
                    const matchesSpecificJob = !filterSpecificJob || (job.title && job.title.toLowerCase() === filterSpecificJob.toLowerCase()); 
                    return matchesText && matchesJobType && matchesCategory && matchesSpecificJob; 
                }).sort((a,b) => (b.jobId || '').localeCompare(a.jobId || ''));
            
                if (filteredJobs.length === 0) { grid.innerHTML = '<p>No jobs found matching your criteria.</p>'; return; }
                
                for (const job of filteredJobs) {
                    const interactionButtons = getInteractionButtonsHTML(job.jobId, 'job');
                    const card = document.createElement('div'); card.className = 'job-card';
                    const payRateText = job.payRate === 'once-off' ? 'total' : job.payRate;
                    const perPersonText = (job.maxPeople || 1) > 1 ? ' per person' : '';
                    
                    let imageToDisplay = job.imagePath; 

                    if (!imageToDisplay || imageToDisplay.includes('pexels.com')) {
                        const categoryData = allJobCategories.find(c => c.name === job.category);
                        if (categoryData) {
                            const specificJobData = categoryData.jobs.find(j => j.name.toLowerCase() === job.title.toLowerCase());
                            
                            if (specificJobData && specificJobData.imagePath) {
                                imageToDisplay = specificJobData.imagePath;
                            } else if (categoryData.useCategoryDefaultImage && categoryData.imagePath) {
                                imageToDisplay = categoryData.imagePath;
                            }
                        }
                    }

                    card.innerHTML = `<div class="card-image-container">${interactionButtons}<img class="card-main-image" src="" alt="${job.title}"></div><div class="card-content"><div class="card-meta"><span><i class="fas fa-map-marker-alt"></i> ${job.location}</span><span><i class="fas fa-users"></i> Max ${job.maxPeople || 1}</span></div><h3>${job.title}</h3><p>${(job.description || '').substring(0, 80)}...</p><div class="card-meta" style="margin-top: auto; margin-bottom: 0; justify-content: flex-start;">${job.price > 0 ? `<span class="card-price">N$${job.price} ${payRateText}${perPersonText}</span>` : ''}</div></div><div class="card-footer" style="justify-content:flex-end;"><button class="jkit-btn apply-btn" data-job-id="${job.jobId}">Apply for job</button></div>`;
                    grid.appendChild(card);
                    displayImage(card.querySelector('.card-main-image'), imageToDisplay, GLOBAL_FALLBACK_IMAGE);
                }
            }
            
            function renderPeoplePage(filterText = '', filterType = 'all', filterWorkerCategory = '', filterTalentCategory = '', filterSpecificSkill = '') {
                const grid = document.getElementById('people-grid');
                grid.innerHTML = '';

                // Get sets of usernames based on their Type
                const workerUsernames = new Set(allUsers.filter(u => u.type === 'Worker').map(u => u.username));
                const talentUsernames = new Set(allUsers.filter(u => u.type === 'Talent').map(u => u.username));

                let filteredPeople = allProfiles.filter(profile => {
                    const user = allUsers.find(u => u.username === profile.username);
                    
                    // CRITICAL: Explicitly exclude Employers and Agents from this page
                    if (!user || user.type === 'Employer' || user.type === 'Agent') {
                        return false;
                    }

                    const isWorker = workerUsernames.has(profile.username);
                    const isTalent = talentUsernames.has(profile.username);

                    if (filterType === 'worker' && !isWorker) return false;
                    if (filterType === 'talent' && !isTalent) return false;
                    // If filterType is 'all', both are allowed (but Employers/Agents already excluded above)

                    const lowerFilterText = filterText.toLowerCase();
                    if (/^\d{8}$/.test(filterText)) {
                        return user && user.jkitId && user.jkitId === filterText;
                    }

                    const textMatch = !filterText ||
                        profile.fullName.toLowerCase().includes(lowerFilterText) ||
                        (profile.skills || []).join(' ').toLowerCase().includes(lowerFilterText);
                    if (!textMatch) return false;

                    let categoryMatch = true;
                    let skillMatch = true;
                    const profileSkillsLower = new Set((profile.skills || []).map(s => s.toLowerCase()));

                    if (filterWorkerCategory) {
                        const categoryData = allJobCategories.find(cat => cat.name === filterWorkerCategory);
                        const categorySkills = new Set((categoryData?.jobs || []).map(j => j.name.toLowerCase()));
                        categoryMatch = [...profileSkillsLower].some(skill => categorySkills.has(skill));
                    } else if (filterTalentCategory) {
                        const categoryData = allJobCategories.find(cat => cat.name === filterTalentCategory);
                        const categorySkills = new Set((categoryData?.jobs || []).map(j => j.name.toLowerCase()));
                        categoryMatch = [...profileSkillsLower].some(skill => categorySkills.has(skill));
                    }
                    if (!categoryMatch) return false;

                    if (filterSpecificSkill) {
                        skillMatch = profileSkillsLower.has(filterSpecificSkill.toLowerCase());
                    }

                    return skillMatch;
                });

                if (filteredPeople.length === 0) {
                    grid.innerHTML = '<p>No workers or talents found matching your criteria.</p>';
                    return;
                }

                for (const profile of filteredPeople) {
                    const agencyMembership = allAgencies.find(agency => agency.members && agency.members.includes(profile.username));
                    let agencyInfoHTML = '';
                    if (agencyMembership) {
                        agencyInfoHTML = `<p class="agency-membership-info">Member of: <a href="#" class="view-agency-btn" data-agency-id="${agencyMembership.agencyId}">${agencyMembership.name}</a></p>`;
                    }
                    
                    let locationIconHTML = '';
                    // --- MODIFICATION: Show location button for any profile with a location, not just verified agency members
                    if (profile.location) {
                        locationIconHTML = `<button class="jkit-btn btn-small view-location-btn" data-location="${profile.location}" data-agency-name="${profile.fullName}" title="View Location"><i class="fas fa-map-marker-alt"></i></button>`;
                    }
                    
                    const interactionButtons = getInteractionButtonsHTML(profile.username, 'person');
                    const footerInteractions = getFooterInteractionsHTML(profile.username);
                    const followButton = getFollowButtonHTML(profile.username);
                    
                    // --- NEW HIRE BUTTON LOGIC ---
                    let hireButtonHTML = '';
                    if (!profile.services || Object.keys(profile.services).length === 0) {
                         if (currentUser) {
                            hireButtonHTML = `<button class="jkit-btn hire-btn" data-username="${profile.username}">Hire</button>`;
                        }
                    }
                    
                    const card = document.createElement('div');
                    card.className = 'person-card';

                    let imageToDisplay = profile.avatarPath || DEFAULT_PERSON_AVATAR;
                    
                    const verifiedBadge = profile.isVerified ? '<span class="verified-badge" title="Verified"><i class="fas fa-check"></i></span>' : '';
                    
                    // --- NEW RATING DISPLAY ---
                    const ratingHTML = getRatingStarsHTML(profile);

                    let socialLinksHTML = '<div class="card-social-links" style="display: flex; gap: 0.75rem;">';
                    if (profile.linkedin) { socialLinksHTML += `<a href="${profile.linkedin}" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>`; }
                    if (profile.facebook) { socialLinksHTML += `<a href="${profile.facebook}" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>`; }
                    if (profile.instagram) { socialLinksHTML += `<a href="${profile.instagram}" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>`; }
                    if (profile.x_twitter) { socialLinksHTML += `<a href="${profile.x_twitter}" target="_blank" title="X (Twitter)"><i class="fab fa-twitter"></i></a>`; }
                    if (profile.tiktok) { socialLinksHTML += `<a href="${profile.tiktok}" target="_blank" title="TikTok"><i class="fab fa-tiktok"></i></a>`; }
                    if (profile.whatsapp) { socialLinksHTML += `<a href="https://wa.me/${profile.whatsapp.replace(/\D/g, '')}" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>`; }
                    socialLinksHTML += '</div>';

                    card.innerHTML = `<div class="card-image-container view-profile-btn" data-username="${profile.username}" style="cursor: pointer;">${interactionButtons}<img class="card-main-image" src="" alt="${profile.fullName}"></div>
                    <div class="card-content">
                        <h3>${profile.fullName}${verifiedBadge}</h3>
                        ${ratingHTML}
                        ${agencyInfoHTML}
                        <div class="card-tags">${(profile.skills || []).slice(0, 3).map(skill => `<span class="card-tag">${skill}</span>`).join('')}</div>
                        <p>${(profile.bio || '').substring(0, 90)}...</p>
                    </div>
                    <div class="card-footer">
                        <div>
                            <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${profile.username}">Profile</button>
                            ${followButton}
                            ${hireButtonHTML}
                            ${socialLinksHTML}
                            <button class="jkit-btn btn-small send-message-btn" data-username="${profile.username}"><i class="fas fa-paper-plane"></i></button>
                            ${locationIconHTML}
                        </div>
                        ${footerInteractions}
                    </div>`;
                    grid.appendChild(card);
                    displayImage(card.querySelector('.card-main-image'), imageToDisplay, DEFAULT_PERSON_AVATAR);
                }
            }

            function renderEmployersPage(filterText = '', filterBusinessType = '') {
                const grid = document.getElementById('employers-grid');
                grid.innerHTML = '';

                const employerUsers = allUsers.filter(u => u.type === 'Employer');
                
                let filteredEmployers = allProfiles.filter(profile => {
                    const user = employerUsers.find(u => u.username === profile.username);
                    if (!user) return false; 

                    const lowerFilterText = filterText.toLowerCase();
                    
                    if (/^\d{8}$/.test(filterText) || filterText.toUpperCase().includes('JIN')) {
                        return user.jkitId && user.jkitId.toLowerCase().includes(lowerFilterText);
                    }

                    const textMatch = !filterText || profile.fullName.toLowerCase().includes(lowerFilterText);
                    const typeMatch = !filterBusinessType || (user.businessType && user.businessType === filterBusinessType);

                    return textMatch && typeMatch;
                });

                if (filteredEmployers.length === 0) {
                    grid.innerHTML = '<p>No employers found matching your criteria.</p>';
                    return;
                }

                for (const profile of filteredEmployers) {
                    const user = allUsers.find(u => u.username === profile.username);
                    const interactionButtons = getInteractionButtonsHTML(profile.username, 'employer');
                    const footerInteractions = getFooterInteractionsHTML(profile.username);
                    const followButton = getFollowButtonHTML(profile.username);
                    
                    const card = document.createElement('div');
                    card.className = 'person-card';

                    let imageToDisplay = profile.avatarPath || DEFAULT_PERSON_AVATAR;
                    const verifiedBadge = profile.isVerified ? '<span class="verified-badge" title="Verified"><i class="fas fa-check"></i></span>' : '';
                    const businessTypeLabel = user.businessType ? (user.businessType.charAt(0).toUpperCase() + user.businessType.slice(1)) : 'Employer';

                    let socialLinksHTML = '<div class="card-social-links" style="display: flex; gap: 0.75rem;">';
                    if (profile.linkedin) { socialLinksHTML += `<a href="${profile.linkedin}" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>`; }
                    if (profile.facebook) { socialLinksHTML += `<a href="${profile.facebook}" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>`; }
                    if (profile.instagram) { socialLinksHTML += `<a href="${profile.instagram}" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>`; }
                    if (profile.x_twitter) { socialLinksHTML += `<a href="${profile.x_twitter}" target="_blank" title="X (Twitter)"><i class="fab fa-twitter"></i></a>`; }
                    if (profile.whatsapp) { socialLinksHTML += `<a href="https://wa.me/${profile.whatsapp.replace(/\D/g, '')}" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>`; }
                    socialLinksHTML += '</div>';

                    card.innerHTML = `
                    <div class="card-image-container view-profile-btn" data-username="${profile.username}" style="cursor: pointer;">
                        ${interactionButtons}
                        <img class="card-main-image" src="" alt="${profile.fullName}">
                    </div>
                    <div class="card-content">
                        <h3>${profile.fullName}${verifiedBadge}</h3>
                        <div class="card-tags">
                            <span class="card-tag" style="background: rgba(40, 167, 69, 0.1); color: #28a745;">${businessTypeLabel}</span>
                        </div>
                        <p>${(profile.bio || '').substring(0, 90)}...</p>
                    </div>
                    <div class="card-footer">
                        <div>
                            <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${profile.username}">Profile</button>
                            ${followButton}
                            ${socialLinksHTML}
                            <button class="jkit-btn btn-small send-message-btn" data-username="${profile.username}"><i class="fas fa-paper-plane"></i></button>
                        </div>
                         ${footerInteractions}
                    </div>`;
                    
                    grid.appendChild(card);
                    displayImage(card.querySelector('.card-main-image'), imageToDisplay, DEFAULT_PERSON_AVATAR);
                }
            }


            function renderAgenciesPage(filterText = '', filterType = '') {
                const grid = document.getElementById('agencies-grid'); grid.innerHTML = '';
                const profilesMap = new Map(allProfiles.map(p => [p.username, p]));
                const lowerFilterText = filterText.toLowerCase();
                
                const filteredAgencies = allAgencies.filter(agency => {
                    const ownerProfile = profilesMap.get(agency.owner);
                    if (!ownerProfile) return false;
                    const ownerUser = allUsers.find(u => u.username === agency.owner);

                    if (/^\d{8}$/.test(filterText)) {
                        return ownerUser && ownerUser.jkitId && ownerUser.jkitId === filterText;
                    }

                    const matchesText = !filterText || agency.name.toLowerCase().includes(lowerFilterText) || ownerProfile.fullName.toLowerCase().includes(lowerFilterText);
                    const matchesType = !filterType || agency.type === filterType;
                    return matchesText && matchesType;
                });

                if (filteredAgencies.length === 0) { grid.innerHTML = '<p>No agencies found matching your criteria.</p>'; return; }
                
                for (const agency of filteredAgencies) {
                    const ownerProfile = profilesMap.get(agency.owner);
                    let messageBtnHTML = '';
                    if (currentUser && currentUser.username !== agency.owner) {
                        messageBtnHTML = `<button class="jkit-btn btn-small send-message-btn" data-username="${agency.owner}"><i class="fas fa-paper-plane"></i> Message Agent</button>`;
                    }
                    const interactionButtons = getInteractionButtonsHTML(agency.agencyId, 'agency');
                    const footerInteractions = getFooterInteractionsHTML(agency.agencyId);
                    
                    let actionButtonsHTML = `<button class="jkit-btn jkit-btn-outline view-agency-btn" data-agency-id="${agency.agencyId}">View Details</button>`;

                    if (currentUser && (currentUser.type === 'Worker' || currentUser.type === 'Talent')) {
                        const isMember = agency.members.includes(currentUser.username);
                        const hasPendingRequest = allAgencyRequests.some(req => req.agencyId === agency.agencyId && req.username === currentUser.username && req.status === 'pending');
                        
                        if(isMember) {
                            actionButtonsHTML += `<button class="jkit-btn" disabled>Member</button>`;
                        } else if (hasPendingRequest) {
                            actionButtonsHTML += `<button class="jkit-btn" disabled>Pending</button>`;
                        } else {
                            actionButtonsHTML += `<button class="jkit-btn request-join-btn" data-agency-id="${agency.agencyId}">Request to Join</button>`;
                        }
                    }

                     // --- NEW HIRE BUTTON LOGIC ---
                    if (!agency.services || Object.keys(agency.services).length === 0) {
                         if (currentUser) {
                            actionButtonsHTML += `<button class="jkit-btn hire-btn" data-username="${agency.owner}">Hire Agent</button>`;
                        }
                    }

                    let imageToDisplay = agency.imagePath;
                    if (!imageToDisplay || imageToDisplay.includes('pexels.com')) {
                        imageToDisplay = DEFAULT_AGENCY_AVATAR;
                    }

                    const verifiedBadge = agency.isVerified ? '<span class="verified-badge" title="Verified"><i class="fas fa-check"></i></span>' : '';
                    
                    let socialLinksHTML = '<div class="card-social-links" style="display: flex; gap: 0.75rem;">';
                    if (ownerProfile.linkedin) { socialLinksHTML += `<a href="${ownerProfile.linkedin}" target="_blank" title="LinkedIn"><i class="fab fa-linkedin"></i></a>`; }
                    if (ownerProfile.facebook) { socialLinksHTML += `<a href="${ownerProfile.facebook}" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>`; }
                    if (ownerProfile.instagram) { socialLinksHTML += `<a href="${ownerProfile.instagram}" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>`; }
                    if (ownerProfile.x_twitter) { socialLinksHTML += `<a href="${ownerProfile.x_twitter}" target="_blank" title="X (Twitter)"><i class="fab fa-twitter"></i></a>`; }
                    if (ownerProfile.tiktok) { socialLinksHTML += `<a href="${ownerProfile.tiktok}" target="_blank" title="TikTok"><i class="fab fa-tiktok"></i></a>`; }
                    if (ownerProfile.whatsapp) { socialLinksHTML += `<a href="https://wa.me/${ownerProfile.whatsapp.replace(/\D/g, '')}" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>`; }
                    socialLinksHTML += '</div>';

                    const card = document.createElement('div'); card.className = 'agency-card';
                    card.innerHTML = `<div class="card-image-container">${interactionButtons}<img class="card-main-image" src="" alt="${agency.name}"></div>
                    <div class="card-content"><h3>${agency.name}${verifiedBadge}</h3><div class="card-tags"><span class="card-tag">${agency.type || 'Agency'}</span></div><p>Managed by: <strong>${ownerProfile.fullName}</strong></p><p>${agency.description.substring(0, 100)}...</p></div>
                    <div class="card-footer">
                        <div>
                           ${actionButtonsHTML} ${messageBtnHTML} ${socialLinksHTML}
                        </div>
                         ${footerInteractions}
                    </div>`;
                    grid.appendChild(card);
                    displayImage(card.querySelector('.card-main-image'), imageToDisplay, DEFAULT_AGENCY_AVATAR);
                }
            }

            function renderStatsSection() {
                const statsGrid = document.getElementById('stats-grid');
                if(!statsGrid) return;
                const today = new Date(); today.setHours(0, 0, 0, 0);
                statsGrid.querySelector('#total-users').textContent = allUsers.length;
                statsGrid.querySelector('#jobs-available').textContent = allJobs.filter(j => j.status === 'open' && new Date(j.dueDate) >= today).length;
                statsGrid.querySelector('#jobs-completed').textContent = allJobs.filter(j => j.status === 'closed').length;
                statsGrid.querySelector('#total-agents').textContent = allUsers.filter(u => u.type === 'Agent').length;
            }

            function renderNewsSection() {
                const grid = document.getElementById('news-grid');
                if(!grid) return;
                if(allNewsArticles.length === 0) {
                    grid.innerHTML = '<p style="color: var(--jkit-text-muted); text-align: center;">No news yet. Check back soon!</p>';
                    return;
                }
                grid.innerHTML = allNewsArticles.map(article => {
                    const snippet = article.content.length > 100 ? article.content.substring(0, 100) + '...' : article.content;
                    const publishedDate = new Date(article.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    const interactionButtons = getInteractionButtonsHTML(article.articleId, 'news');
                    const footerInteractions = getFooterInteractionsHTML(article.articleId);
                    return `
                        <div class="news-card">
                            <div class="news-card-image">
                                ${interactionButtons}
                                <img src="${article.imagePath}" alt="${article.title}" class="enlargeable-image" style="cursor: pointer;">
                            </div>
                            <div class="news-card-content">
                                <h3>${article.title}</h3>
                                <p>${snippet}</p>
                                <div class="card-footer" style="padding:0; border:0; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <span class="news-card-meta">${publishedDate}</span>
                                        <button class="jkit-btn jkit-btn-outline read-more-btn" data-article-id="${article.articleId}">Read More</button>
                                    </div>
                                    ${footerInteractions}
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }
            
            function renderAgencyDetailPage(agencyId, fromHistory = false) {
                const agency = allAgencies.find(a => a.agencyId === agencyId);
                if (!agency) { document.getElementById('agency-detail-content').innerHTML = '<p>Agency not found.</p>'; window.showPage('agency-detail-page', {}, fromHistory); return; }              
                const ownerProfile = allProfiles.find(p => p.username === agency.owner);
                const memberProfiles = (agency.members || []).map(username => allProfiles.find(p => p.username === username)).filter(Boolean);
                
                currentDetailView = { type: 'agency', id: agencyId };
                const verifiedBadge = agency.isVerified ? '<span class="verified-badge" title="Verified"><i class="fas fa-check"></i></span>' : '';

                document.getElementById('agency-detail-page-title').textContent = agency.name;
                displayImage(document.getElementById('agency-detail-image'), agency.imagePath, DEFAULT_AGENCY_AVATAR);
                document.getElementById('agency-detail-name').innerHTML = `${agency.name}${verifiedBadge}`; 
                document.getElementById('agency-detail-type').textContent = agency.type || 'Not specified';
                document.getElementById('agency-detail-owner-name').textContent = ownerProfile.fullName; 
                document.getElementById('agency-detail-description').textContent = agency.description;
                
                let actionsHTML = '';
                if (currentUser && currentUser.username !== agency.owner) {
                    actionsHTML += `<button class="jkit-btn send-message-btn" data-username="${agency.owner}"><i class="fas fa-paper-plane"></i> Message Agent</button>`;
                }

                if (agency.location) {
                    actionsHTML += `<button class="jkit-btn jkit-btn-outline view-location-btn" data-location="${agency.location}" data-agency-name="${agency.name}"><i class="fas fa-map-marker-alt"></i> View Location</button>`;
                }

                if(currentUser && (currentUser.type === 'Worker' || currentUser.type === 'Talent')) {
                    const isMember = agency.members.includes(currentUser.username);
                    const hasPendingRequest = allAgencyRequests.some(req => req.agencyId === agency.agencyId && req.username === currentUser.username && req.status === 'pending');
                    if(isMember) {
                        actionsHTML += `<button class="jkit-btn" disabled>You are a Member</button>`;
                    } else if (hasPendingRequest) {
                        actionsHTML += `<button class="jkit-btn" disabled>Request Pending</button>`;
                    } else {
                        actionsHTML += `<button class="jkit-btn request-join-btn" data-agency-id="${agency.agencyId}">Request to Join</button>`;
                    }
                }
                 // --- NEW HIRE BUTTON LOGIC ---
                if (!agency.services || Object.keys(agency.services).length === 0) {
                     if (currentUser) {
                        actionsHTML += `<button class="jkit-btn hire-btn" data-username="${agency.owner}">Hire Agent</button>`;
                    }
                }
                document.querySelector('.agency-sidebar-actions').innerHTML = actionsHTML;

                const contactInfoContainer = document.getElementById('agency-detail-contact-info');
                contactInfoContainer.innerHTML = '';
                if (ownerProfile.phone) contactInfoContainer.innerHTML += `<a href="tel:${ownerProfile.phone}"><i class="fas fa-phone"></i> ${ownerProfile.phone}</a>`;
                if (ownerProfile.email) contactInfoContainer.innerHTML += `<a href="mailto:${ownerProfile.email}"><i class="fas fa-envelope"></i> ${ownerProfile.email}</a>`;
                if (ownerProfile.linkedin) contactInfoContainer.innerHTML += `<a href="${ownerProfile.linkedin}" target="_blank"><i class="fab fa-linkedin"></i> LinkedIn Profile</a>`;
                if (ownerProfile.facebook) contactInfoContainer.innerHTML += `<a href="${ownerProfile.facebook}" target="_blank"><i class="fab fa-facebook"></i> Facebook Profile</a>`;
                if (ownerProfile.instagram) contactInfoContainer.innerHTML += `<a href="${ownerProfile.instagram}" target="_blank"><i class="fab fa-instagram"></i> Instagram Profile</a>`;
                if (ownerProfile.x_twitter) { contactInfoContainer.innerHTML += `<a href="${ownerProfile.x_twitter}" target="_blank" title="X (Twitter) Profile"><i class="fab fa-twitter"></i></a>`; }
                if (ownerProfile.tiktok) { contactInfoContainer.innerHTML += `<a href="${ownerProfile.tiktok}" target="_blank" title="TikTok Profile"><i class="fab fa-tiktok"></i></a>`; }
                if (ownerProfile.whatsapp) { contactInfoContainer.innerHTML += `<a href="https://wa.me/${ownerProfile.whatsapp.replace(/\D/g, '')}" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>`; }
                if(contactInfoContainer.innerHTML === '') contactInfoContainer.innerHTML = '<p>No contact information provided.</p>';
                
                const servicesList = document.getElementById('agency-detail-services-list');
                servicesList.innerHTML = '';
                if (agency.services && Object.keys(agency.services).length > 0) {
                    for (const [service, price] of Object.entries(agency.services)) {
                        const li = document.createElement('li');
                        li.className = 'agency-service-item';
                        let hireButtonHTML = '';
                        if (currentUser) {
                            hireButtonHTML = `<button class="jkit-btn hire-agency-service-btn" data-username="${agency.owner}" data-service="${service}">Hire Now</button>`;
                        }
                        li.innerHTML = `
                            <div>
                                <span class="service-name">${service}</span>
                                <span class="service-price" style="display: block; font-size: 0.9em;">N$ ${price}</span>
                            </div>
                            ${hireButtonHTML}
                        `;
                        servicesList.appendChild(li);
                    }
                } else {
                    servicesList.innerHTML = '<li>This agency has not listed any services yet.</li>';
                }

                const membersGrid = document.getElementById('agency-detail-members-grid'); membersGrid.innerHTML = '';
                if(memberProfiles.length > 0) {
                    for(const member of memberProfiles) {
                        const followButton = getFollowButtonHTML(member.username);
                        const memberCard = document.createElement('div'); 
                        memberCard.className = 'member-card';
                        memberCard.innerHTML = `
                            <img src="" alt="${member.fullName}" class="enlargeable-image" style="cursor: pointer;">
                            <div class="member-name view-profile-btn" data-username="${member.username}">${member.fullName}</div>
                            <div class="member-role">${(member.skills || ['Member'])[0]}</div>
                            ${followButton}`;
                        membersGrid.appendChild(memberCard);
                        displayImage(memberCard.querySelector('img'), member.avatarPath, DEFAULT_PERSON_AVATAR);
                    }
                } else {
                    membersGrid.innerHTML = '<p>This agency has no members yet.</p>';
                }

                window.showPage('agency-detail-page', { stateParams: { id: agencyId }, replaceHistory: fromHistory }, fromHistory);
            }
        
            function openProfileDetailPage(username, fromHistory = false) {
                const profile = allProfiles.find(p => p.username === username);
                const user = allUsers.find(u => u.username === username);
                if (!profile || !user) {
                    console.error("Profile or user not found for username:", username);
                    if(isInitialLoad) window.showPage('home-page', { replaceHistory: true });
                    return;
                }
                
                currentDetailView = { type: 'profile', id: username };
                const verifiedBadge = profile.isVerified ? '<span class="verified-badge" title="Verified"><i class="fas fa-check"></i></span>' : '';

                displayImage(document.getElementById('profile-detail-avatar'), profile.avatarPath, DEFAULT_PERSON_AVATAR);
                document.getElementById('profile-detail-name').innerHTML = `${profile.fullName || "Unnamed User"}${verifiedBadge}`;
                
                // --- NEW RATING DISPLAY ---
                document.getElementById('profile-detail-rating-summary').innerHTML = getRatingStarsHTML(profile);
                
                document.getElementById('profile-status-badge').textContent = user.type || "N/A";

                const phoneLink = document.getElementById('profile-detail-phone');
                if (profile.phone) {
                    phoneLink.innerHTML = `<i class="fas fa-phone"></i> ${profile.phone}`;
                    phoneLink.href = `tel:${profile.phone.replace(/-/g, '')}`;
                    phoneLink.style.pointerEvents = 'auto';
                    phoneLink.style.color = 'var(--jkit-text-dark)';
                } else {
                    phoneLink.innerHTML = `<i class="fas fa-phone"></i> Not provided`;
                    phoneLink.href = '#';
                    phoneLink.style.pointerEvents = 'none';
                    phoneLink.style.color = 'var(--jkit-text-muted)';
                }
                const socialContainer = document.getElementById('profile-detail-socials');
                socialContainer.innerHTML = ''; 
                if (profile.linkedin) { socialContainer.innerHTML += `<a href="${profile.linkedin}" target="_blank" title="LinkedIn Profile"><i class="fab fa-linkedin"></i></a>`; }
                if (profile.facebook) { socialContainer.innerHTML += `<a href="${profile.facebook}" target="_blank" title="Facebook Profile"><i class="fab fa-facebook-f"></i></a>`; }
                if (profile.instagram) { socialContainer.innerHTML += `<a href="${profile.instagram}" target="_blank" title="Instagram Profile"><i class="fab fa-instagram"></i></a>`; }
                if (profile.x_twitter) { socialContainer.innerHTML += `<a href="${profile.x_twitter}" target="_blank" title="X (Twitter) Profile"><i class="fab fa-twitter"></i></a>`; }
                if (profile.tiktok) { socialContainer.innerHTML += `<a href="${profile.tiktok}" target="_blank" title="TikTok Profile"><i class="fab fa-tiktok"></i></a>`; }
                if (profile.whatsapp) { socialContainer.innerHTML += `<a href="https://wa.me/${profile.whatsapp.replace(/\D/g, '')}" target="_blank" title="Chat on WhatsApp"><i class="fab fa-whatsapp"></i></a>`; }

                document.getElementById('profile-detail-bio').textContent = profile.bio || "No bio has been provided yet.";

                const agencyMembership = allAgencies.find(a => a.members && a.members.includes(username));
                const servicesToDisplay = agencyMembership ? agencyMembership.services : profile.services;
                const servicesTitle = agencyMembership ? `Services via ${agencyMembership.name}` : "Services and Prices";
                document.getElementById('services-title').textContent = servicesTitle;
                const servicesList = document.getElementById('profile-services-list');
                servicesList.innerHTML = '';
                if (servicesToDisplay && typeof servicesToDisplay === 'object' && Object.keys(servicesToDisplay).length > 0) {
                    for (const [service, price] of Object.entries(servicesToDisplay)) {
                        const li = document.createElement('li');
                        li.className = 'profile-service-item';
                        let hireButtonHTML = '';
                        if (currentUser) {
                        hireButtonHTML = `<button class="jkit-btn hire-service-btn" data-username="${username}" data-service="${service}">Hire Now</button>`;
                        }
                        li.innerHTML = `
                            <div>
                                <span class="service-name">${service}</span>
                                <span class="service-price" style="display: block; font-size: 0.9em;">N$ ${price}</span>
                            </div>
                            ${hireButtonHTML}
                        `;
                        servicesList.appendChild(li);
                    }
                } else {
                    servicesList.innerHTML = '<li><p style="color: var(--jkit-text-muted);">No specific services and prices have been listed.</p></li>';
                }

                const skillsList = document.getElementById('profile-skills-list');
                skillsList.innerHTML = '';
                if (profile.skills && profile.skills.length > 0) {
                    profile.skills.forEach(skill => {
                        const li = document.createElement('li');
                        li.className = 'profile-skill-item';
                        li.innerHTML = `<span class="profile-skill-name">${skill}</span>`;
                        skillsList.appendChild(li);
                    });
                } else {
                    skillsList.innerHTML = '<li><p style="color: var(--jkit-text-muted);">No skills have been listed.</p></li>';
                }

                const galleryContainer = document.getElementById('profile-detail-gallery-container');
                galleryContainer.innerHTML = '';
                if (profile.galleryImagePaths && profile.galleryImagePaths.length > 0) {
                    galleryContainer.className = 'service-detail-gallery';
                    galleryContainer.innerHTML = `<div class="main-image"><img src="" alt="Gallery main view"></div><div class="thumbnail-strip"></div>`;
                    const mainImageEl = galleryContainer.querySelector('.main-image img');
                    const thumbnailStrip = galleryContainer.querySelector('.thumbnail-strip');
                    profile.galleryImagePaths.forEach((path, i) => {
                        const thumbImg = document.createElement('img');
                        displayImage(thumbImg, path, GLOBAL_FALLBACK_IMAGE);
                        thumbnailStrip.appendChild(thumbImg);
                        if (i === 0) {
                            displayImage(mainImageEl, path, GLOBAL_FALLBACK_IMAGE);
                            thumbImg.classList.add('active');
                        }
                    });
                    thumbnailStrip.addEventListener('click', (e) => {
                        if (e.target.tagName === 'IMG') {
                            mainImageEl.src = e.target.src;
                            thumbnailStrip.querySelectorAll('img').forEach(img => img.classList.remove('active'));
                            e.target.classList.add('active');
                        }
                    });
                } else {
                    galleryContainer.className = '';
                    galleryContainer.innerHTML = '<p style="color: var(--jkit-text-muted);">No images have been added to the gallery.</p>';
                }

                document.getElementById('profile-job-history').innerHTML = '<p style="color: var(--jkit-text-muted);">Previous jobs history feature is coming soon.</p>';

                const actionButtons = document.querySelector('.profile-action-buttons');
                actionButtons.innerHTML = '';
                 // --- NEW HIRE BUTTON LOGIC ---
                const hasServices = servicesToDisplay && typeof servicesToDisplay === 'object' && Object.keys(servicesToDisplay).length > 0;
                if (!hasServices && currentUser) {
                    actionButtons.innerHTML += `<button class="jkit-btn hire-btn" data-username="${username}">Hire Now</button>`;
                }

                if (profile.isVerified && agencyMembership && agencyMembership.location) {
                    actionButtons.innerHTML += `<button class="jkit-btn view-location-btn" data-location="${agencyMembership.location}" data-agency-name="${agencyMembership.name}"><i class="fas fa-map-marker-alt"></i> View Location</button>`;
                }
                
                if (profile.cvPath) {
                    actionButtons.innerHTML += `<button class="jkit-btn jkit-btn-outline view-cv-btn" data-cv-path="${profile.cvPath}"><i class="fas fa-file-pdf"></i> View CV</button>`;
                }

                const followButton = getFollowButtonHTML(username, '');
                actionButtons.innerHTML += followButton;

                if (currentUser && currentUser.username !== username) {
                    actionButtons.innerHTML += `<button class="jkit-btn send-message-btn" data-username="${username}"><i class="fas fa-paper-plane"></i> Send Message</button>`;
                }

                window.showPage('profile-detail-page', { stateParams: { username: username }, replaceHistory: fromHistory }, fromHistory);
            }
            
            // =========================================================================
            //  5. DASHBOARD & DATA SAVING
            // =========================================================================

            async function createData(type, data, isAdminRoute = false, endpoint = '') {
                const url = isAdminRoute ? `/api/admin/${endpoint || type}` : `/api/content/${type}`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });
                    if (!response.ok) { 
                        const err = await response.json();
                        throw new Error(err.message || `Server responded with status ${response.status}`); 
                    }
                    showToast(`${type.slice(0, -1)} created successfully! The page will now reload.`, 'success');
                    closeModal(); 
                    setTimeout(() => window.location.reload(), 1500);
                } catch (error) {
                    showToast(`Error creating ${type.slice(0, -1)}: ${error.message}`, 'error');
                }
            }
            
            async function saveData(type, id, data, isAdminRoute = false, endpoint = '') {
                const url = isAdminRoute ? `/api/admin/${endpoint || type}/${id}` : `/api/content/${type}/${id}`;
                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data),
                        credentials: 'include'
                    });
                    if (!response.ok) { const err = await response.json(); throw new Error(err.message); } 
                    const updatedDoc = await response.json();
                    showToast(`${type.slice(0, -1)} saved successfully! The page will now reload.`, 'success');
                    closeModal();
                    setTimeout(() => window.location.reload(), 1500); 
                    return updatedDoc;
                } catch (error) { 
                    showToast(`Error saving: ${error.message}`, 'error'); 
                    return null;
                }
            }

            async function deleteData(isAdminRoute, endpoint, confirmMessage) {
                    if (confirm(confirmMessage)) {
                    try {
                        const response = await fetch(`/api/admin/${endpoint}`, { 
                            method: 'DELETE', 
                            credentials: 'include' 
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.message);
                        }
                        showToast('Deleted successfully.', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    }
                }
            }
            
            async function handleFileUpload(file) {
                if (!file) return null;
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const response = await fetch('/api/upload', { 
                        method: 'POST', 
                        body: formData,
                        credentials: 'include'
                    });
                    if (!response.ok) throw new Error('Upload failed');
                    const result = await response.json();
                    return result.filePath;
                } catch (error) {
                    showToast(`Image upload error: ${error.message}`, 'error');
                    return null;
                }
            }
            
            async function handleCvUpload(file) {
                if (!file) return null;
                const formData = new FormData();
                formData.append('cv', file);
                try {
                    const response = await fetch('/api/upload/cv', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'CV upload failed');
                    }
                    const result = await response.json();
                    return result.filePath;
                } catch (error) {
                    showToast(`CV upload error: ${error.message}`, 'error');
                    return null;
                }
            }
            
            async function handleJoinRequest(requestId, action) {
                const request = allAgencyRequests.find(r => r.requestId === requestId);
                if (!request) { showToast('Error: Request not found.', 'error'); return; }

                const updatedRequest = { ...request, status: action === 'accept' ? 'accepted' : 'rejected' };

                if (action === 'accept') {
                    const agency = allAgencies.find(a => a.agencyId === request.agencyId);
                    if (!agency) { showToast('Error: Agency not found.', 'error'); return; }
                    
                    const updatedMembers = [...new Set([...agency.members, request.username])];
                    const updatedAgency = { ...agency, members: updatedMembers };
                    
                    await saveData('agencies', agency.agencyId, updatedAgency);
                    await saveData('agencyRequests', requestId, updatedRequest);
                } else { // action is 'reject'
                    await saveData('agencyRequests', requestId, updatedRequest);
                }
            }

            function renderJobCategoriesAdminPanel() {
                const panel = document.getElementById('job-categories-panel');
                if (!panel) return;

                panel.innerHTML = `
                    <div class="actions-header">
                        <h3>Manage Job Categories</h3>
                        <button class="jkit-btn" id="create-category-btn">+ New Category</button>
                    </div>
                    <div class="category-admin-grid">
                        ${allJobCategories.sort((a,b) => a.name.localeCompare(b.name)).map(cat => `
                            <div class="category-admin-card">
                                <div class="category-admin-header">
                                    <h4>${cat.name}</h4>
                                    <div class="category-admin-actions">
                                        <button class="edit-btn" data-name="${cat.name}" title="Edit Category Name"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" data-name="${cat.name}" title="Delete Category"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                                <ul class="specific-job-list">
                                    ${cat.jobs.sort((a,b) => a.name.localeCompare(b.name)).map(job => `
                                        <li class="specific-job-item">
                                            <span>${job.name}</span>
                                            <div class="category-admin-actions">
                                                <button class="edit-job-btn" data-cat-name="${cat.name}" data-job-name="${job.name}" title="Edit Job Type"><i class="fas fa-edit"></i></button>
                                                <button class="delete-job-btn" data-cat-name="${cat.name}" data-job-name="${job.name}" title="Delete Job Type"><i class="fas fa-trash"></i></button>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                                <button class="jkit-btn jkit-btn-outline add-specific-job-btn" data-cat-name="${cat.name}">+ Add Job Type</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // --- NEW: Map variables in a higher scope ---
            let dashboardMap;
            let dashboardMarker;

            function renderDashboardPage() {
                const container = document.getElementById('dashboard-container');
                if (!currentUser) { container.innerHTML = `<h2>Dashboard</h2><p>Please <a href="#" id="dashboard-login-link">log in</a> to manage your content.</p>`; document.getElementById('dashboard-login-link').addEventListener('click', (e) => { e.preventDefault(); showModal(loginModal); }); return; }
                
                const profile = allProfiles.find(p => p.username === currentUser.username);
                
                if (!profile) {
                    console.error(`CRITICAL: User '${currentUser.username}' is logged in but has no profile.`);
                    container.innerHTML = `<h2>Error</h2><p>Your profile could not be loaded. Please contact support.</p>`;
                    return;
                }
                
                let galleryCarouselHTML = `
                    <div id="dashboard-gallery-container" class="dashboard-gallery-carousel">
                        <div class="dashboard-main-image">
                            <img src="${(profile.galleryImagePaths && profile.galleryImagePaths[0]) || GLOBAL_FALLBACK_IMAGE}" alt="Main gallery view">
                        </div>
                        <div class="dashboard-thumbnail-strip">`;
                
                for (let i = 0; i < 5; i++) {
                    const imagePath = profile.galleryImagePaths ? profile.galleryImagePaths[i] : null;
                    galleryCarouselHTML += `
                        <div class="dashboard-thumbnail-item ${i === 0 ? 'active' : ''}" data-slot-index="${i}">
                            <img src="${imagePath || GLOBAL_FALLBACK_IMAGE}" alt="Thumbnail ${i+1}" class="dashboard-thumbnail-img">
                            <div class="thumbnail-overlay">
                                <label for="gallery-upload-${i}" class="thumb-action-btn" title="Upload Image"><i class="fas fa-upload"></i></label>
                                <button type="button" class="thumb-action-btn remove-gallery-image-btn" title="Remove Image"><i class="fas fa-trash"></i></button>
                            </div>
                            <input type="file" id="gallery-upload-${i}" class="gallery-image-input" style="display:none;" accept="image/*">
                            <input type="hidden" class="gallery-image-path" value="${imagePath || ''}">
                        </div>`;
                }
                
                galleryCarouselHTML += `</div></div>`;

                let navHTML = `<li><button class="active" data-panel="profile-panel"><i class="fas fa-user-edit"></i> My Profile</button></li>`;
                let panelsHTML = `<div id="profile-panel" class="dashboard-panel active">
                    <h3>Edit My Profile</h3>
                        <div style="padding: 10px 15px; background-color: #f0f4f8; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <strong>Your J-KIT ID:</strong> <span style="font-family: monospace; font-weight: bold; color: var(--jkit-primary);">${currentUser.jkitId || 'Not Assigned'}</span>
                    </div>
                    <form id="profile-edit-form">
                        <input type="hidden" id="profile-avatar-path-hidden" value="${profile.avatarPath || ''}">
                        <input type="hidden" id="profile-cv-path-hidden" value="${profile.cvPath || ''}">
                        <div class="form-group"><label for="profile-fullName">Full Name</label><input type="text" id="profile-fullName" value="${profile.fullName || ''}"></div>
                        <div class="form-group"><label>Avatar Image</label><div class="image-upload-wrapper"><img src="${profile.avatarPath || DEFAULT_PERSON_AVATAR}" alt="Avatar Preview" id="profile-avatar-preview" class="image-preview"><label for="profile-avatar-input" class="image-upload-label">Change Image</label><input type="file" id="profile-avatar-input" accept="image/*"></div></div>
                        <div class="form-group"><label for="profile-bio">Bio</label><textarea id="profile-bio">${profile.bio || ''}</textarea></div>
                        <div class="form-group"><label for="profile-skills">Skills (comma-separated)</label><input type="text" id="profile-skills" value="${(profile.skills || []).join(', ')}"></div>
                        <h4>My Services & Rates</h4>
                        <div id="service-rate-container"></div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-service-btn" style="margin-top: 1rem;">+ Add Service</button>
                        <hr style="margin: 1.5rem 0;">
                        <h4>Contact & Social Media</h4>
                        <div class="form-group"><label for="profile-phone">Phone Number</label><input type="tel" id="profile-phone" value="${profile.phone || ''}"></div>
                        <div class="form-group"><label for="profile-email">Email Address</label><input type="email" id="profile-email" value="${profile.email || ''}"></div>
                        <div class="form-group"><label for="profile-whatsapp">WhatsApp Number (e.g., 26481...)</label><input type="tel" id="profile-whatsapp" value="${profile.whatsapp || ''}" placeholder="Include country code, no +"></div>
                        <div class="form-group"><label for="profile-linkedin">LinkedIn URL</label><input type="url" id="profile-linkedin" value="${profile.linkedin || ''}" placeholder="https://linkedin.com/in/yourprofile"></div>
                        <div class="form-group"><label for="profile-facebook">Facebook URL</label><input type="url" id="profile-facebook" value="${profile.facebook || ''}" placeholder="https://facebook.com/yourprofile"></div>
                        <div class="form-group"><label for="profile-instagram">Instagram URL</label><input type="url" id="profile-instagram" value="${profile.instagram || ''}" placeholder="https://instagram.com/yourprofile"></div>
                        <div class="form-group"><label for="profile-x_twitter">X (Twitter) URL</label><input type="url" id="profile-x_twitter" value="${profile.x_twitter || ''}" placeholder="https://x.com/yourprofile"></div>
                        <div class="form-group"><label for="profile-tiktok">TikTok URL</label><input type="url" id="profile-tiktok" value="${profile.tiktok || ''}" placeholder="https://tiktok.com/@yourprofile"></div>
                        
                        <hr style="margin: 1.5rem 0;">
                        <h4>My Location</h4>
                        <p style="font-size: 0.9rem; color: var(--jkit-text-muted); margin-bottom: 1rem;">Set your primary work location. This helps clients find you.</p>
                        <div class="form-group">
                            <label for="profile-location">Location Address</label>
                            <input type="text" id="profile-location" value="${profile.location || ''}" placeholder="e.g., 123 Independence Ave, Windhoek">
                        </div>
                        <div id="dashboard-map-container"></div>
                        <div id="geolocation-controls">
                            <button type="button" class="jkit-btn jkit-btn-outline" id="find-my-location-btn" style="padding: 6px 14px; font-size: 0.8rem;">
                                <i class="fas fa-crosshairs"></i> Find My Location
                            </button>
                            <span id="geolocation-info"></span>
                        </div>
                        
                        <h4 style="margin-top: 1.5rem;">My Gallery (up to 5 images)</h4>
                        ${galleryCarouselHTML}
                        <hr style="margin: 1.5rem 0;">
                        <h4>My CV / Resume (PDF)</h4>
                        <div class="form-group"><label for="profile-cv-input" class="image-upload-label">Upload CV</label><input type="file" id="profile-cv-input" accept="application/pdf"><div id="cv-status-display" style="margin-top: 10px; font-style: italic; color: var(--jkit-text-muted);"></div></div>
                        <button type="submit" class="jkit-btn">Save Profile</button>
                    </form>
                </div>`;
                
                navHTML += `<li><button data-panel="following-panel"><i class="fas fa-heart"></i> Following</button></li>`;
                
                if (currentUser) {
                    navHTML += `<li><button data-panel="jobs-panel"><i class="fas fa-briefcase"></i> My Jobs</button></li>`;
                    const myJobs = allJobs.filter(job => job.postedBy === currentUser.username);
                    let myJobsListHTML = myJobs.length > 0 ? myJobs.map(job => {
                        let applicantsHTML = '';
                        if (job.applicants && job.applicants.length > 0) {
                            applicantsHTML = `<div class="job-applicants-section" style="width:100%;background-color:#f9f9f9;padding:1rem;margin-top:1rem;border-top:1px dashed var(--jkit-border-color);"><h4 style="margin:0 0 1rem 0;font-size:0.9rem;color:var(--jkit-text-muted);">Applicants:</h4><div class="applicant-list" style="display:flex;flex-wrap:wrap;gap:1.5rem;">`;
                            job.applicants.forEach(username => {
                                const applicantProfile = allProfiles.find(p => p.username === username);
                                if (applicantProfile) {
                                    const actionButtons = job.status === 'open' ? `
                                        <button class="jkit-btn accept-applicant-btn" style="padding:4px 10px;font-size:0.75rem;background: #28a745;" data-job-id="${job.jobId}" data-username="${username}">Accept</button>
                                        <button class="jkit-btn reject-applicant-btn" style="padding:4px 10px;font-size:0.75rem;background: var(--airbnb-red);" data-job-id="${job.jobId}" data-username="${username}">Reject</button>
                                    ` : '';

                                    applicantsHTML += `
                                        <div class="applicant-item" style="display:flex;align-items:center;gap:0.75rem;">
                                            <img src="${applicantProfile.avatarPath || DEFAULT_PERSON_AVATAR}" alt="${applicantProfile.fullName}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">
                                            <span style="font-weight:600;">${applicantProfile.fullName}</span>
                                            <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${username}" style="padding:4px 10px;font-size:0.75rem;">View Profile</button>
                                            ${actionButtons}
                                        </div>
                                    `;
                                }
                            });
                            applicantsHTML += '</div></div>';
                        }
                        
                        // --- NEW: RATING BUTTON LOGIC ---
                        let rateButtonHTML = '';
                        if (job.status === 'closed' && job.assignedTo && currentUser.username === job.postedBy) {
                            const hasRated = allRatings.some(r => r.jobId === job.jobId && r.raterUsername === currentUser.username);
                            if (!hasRated) {
                                rateButtonHTML = `<button class="jkit-btn rate-job-btn" data-job-id="${job.jobId}" data-worker-username="${job.assignedTo}" style="padding: 5px 10px; font-size: 0.8rem; margin-left: 10px;">Rate Worker</button>`;
                            }
                        }

                        return `<li>
                        <img src="${job.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="${job.title}" class="job-list-image">
                        <span class="job-list-title">${job.title}</span>
                        <span class="job-status ${job.status || 'open'}">${job.status || 'open'}</span>
                        <div class="job-actions">
                            ${job.status === 'open' || job.status === 'assigned' || job.status === 'in-progress' ? `<button class="close-btn" data-job-id="${job.jobId}" title="Close Job"><i class="fas fa-check-circle"></i></button>` : ''}
                            <button class="edit-btn" data-job-id="${job.jobId}" title="Edit Job"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-job-id="${job.jobId}" title="Delete Job"><i class="fas fa-trash"></i></button>
                            ${rateButtonHTML}
                        </div>
                        ${applicantsHTML}
                        </li>`;
                    }).join('') : '<li><p>You have not posted any jobs yet.</p></li>';

                    panelsHTML += `<div id="jobs-panel" class="dashboard-panel"><h3>Manage My Jobs</h3><button class="jkit-btn" id="dashboard-post-job-btn">+ Post New Job</button><ul class="my-jobs-list">${myJobsListHTML}</ul></div>`;
                }

                if (currentUser.type === 'Worker' || currentUser.type === 'Talent') {
                    navHTML += `<li><button data-panel="assignments-panel"><i class="fas fa-tasks"></i> My Assignments</button></li>`;
                    const myAssignments = allJobs.filter(job => job.assignedTo === currentUser.username);
                    let myAssignmentsListHTML = myAssignments.length > 0 ? myAssignments.map(job => {
                        let actions = `<button class="jkit-btn jkit-btn-outline apply-btn" data-job-id="${job.jobId}" style="padding: 5px 10px; font-size: 0.8rem;">View Details</button>`;
                        if (job.status === 'assigned') {
                            actions = `
                                <button class="jkit-btn accept-job-btn" data-job-id="${job.jobId}">Accept</button>
                                <button class="jkit-btn decline-job-btn" data-job-id="${job.jobId}">Decline</button>
                            `;
                        }
                        return `<li>
                            <img src="${job.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="${job.title}" class="job-list-image">
                            <span class="job-list-title">${job.title}</span>
                            <span class="job-status ${job.status || 'open'}">${job.status || 'open'}</span>
                            <div class="job-actions">${actions}</div>
                        </li>`;
                    }).join('') : '<li><p>You have not been assigned to any jobs yet.</p></li>';
                    panelsHTML += `<div id="assignments-panel" class="dashboard-panel"><h3>My Assignments</h3><p>These are jobs you have been directly hired for.</p><ul class="my-jobs-list">${myAssignmentsListHTML}</ul></div>`;
                }

                if (currentUser.type === 'Agent'){
                    navHTML += `<li><button data-panel="agency-panel"><i class="fas fa-building"></i> My Agency</button></li><li><button data-panel="requests-panel"><i class="fas fa-user-plus"></i> Join Requests</button></li>`;
                    let myAgency = allAgencies.find(a => a.owner === currentUser.username);
                    
                    if (!myAgency) {
                        panelsHTML += `<div id="agency-panel" class="dashboard-panel"><h3>Create Your Agency</h3><p>You don't have an agency yet. Create one to start managing your members.</p><button class="jkit-btn" id="create-new-agency-btn">Create a New Agency</button></div>`;
                        panelsHTML += `<div id="requests-panel" class="dashboard-panel"><h3>Join Requests</h3><p>Create an agency to see join requests.</p></div>`;
                    } else {
                        const agencyTypes = ['Corporate Agency', 'Individual Agency', 'Group Agency', 'Talent Agency'];
                        const typeOptions = agencyTypes.map(type => `<option value="${type}" ${myAgency.type === type ? 'selected' : ''}>${type}</option>`).join('');
                        panelsHTML += `<div id="agency-panel" class="dashboard-panel"><h3>Edit My Agency</h3>
                            <form id="agency-edit-form" data-agency-id="${myAgency.agencyId}">
                                <input type="hidden" id="agency-image-path-hidden" value="${myAgency.imagePath || ''}">
                                <div class="form-group"><label for="agency-name">Agency Name</label><input type="text" id="agency-name" value="${myAgency.name}"></div>
                                <div class="form-group"><label for="agency-type">Type of Agency</label><select id="agency-type">${typeOptions}</select></div>
                                <div class="form-group"><label>Agency Image</label><div class="image-upload-wrapper"><img src="${myAgency.imagePath || DEFAULT_AGENCY_AVATAR}" alt="Agency Preview" id="agency-image-preview" class="image-preview"><label for="agency-image-input" class="image-upload-label">Change Image</label><input type="file" id="agency-image-input" accept="image/*"></div></div>
                                <div class="form-group"><label for="agency-description">About Agency</label><textarea id="agency-description">${myAgency.description}</textarea></div>
                                <div class="form-group"><label for="agency-location">Location (Address or City)</label><input type="text" id="agency-location" value="${myAgency.location || ''}"></div>
                                <h4>Agency Services & Rates</h4>
                                <div id="agency-service-rate-container"></div>
                                <button type="button" class="jkit-btn jkit-btn-outline" id="add-agency-service-btn" style="margin-top: 1rem;">+ Add Agency Service</button>
                                <hr style="margin: 1.5rem 0;">
                                <button type="submit" class="jkit-btn">Save Agency Details</button>
                            </form>
                        </div>`;
                    
                        const requests = allAgencyRequests.filter(req => req.agencyId === myAgency.agencyId && req.status === 'pending');
                        unreadRequestCount = requests.length;
                        let requestsListHTML = '';
                        if(requests.length > 0) {
                            requestsListHTML = requests.map(req => {
                                const requesterProfile = allProfiles.find(p => p.username === req.username);
                                return `<li class="join-request-item">
                                    <img src="${requesterProfile.avatarPath || DEFAULT_PERSON_AVATAR}" alt="${requesterProfile.fullName}" class="request-user-avatar">
                                    <span class="request-user-name">${requesterProfile.fullName}</span>
                                    <div class="request-actions">
                                        <button class="jkit-btn accept-request-btn" data-request-id="${req.requestId}"><i class="fas fa-check"></i> Accept</button>
                                        <button class="jkit-btn reject-request-btn" data-request-id="${req.requestId}"><i class="fas fa-times"></i> Reject</button>
                                    </div>
                                </li>`;
                            }).join('');
                        } else {
                            requestsListHTML = '<li><p>You have no pending join requests.</p></li>';
                        }
                        panelsHTML += `<div id="requests-panel" class="dashboard-panel"><h3>Join Requests</h3><ul class="join-requests-list">${requestsListHTML}</ul></div>`;
                    }
                }
                
                const followedUsernames = new Set(allFollowers.filter(f => f.follower === currentUser.username).map(f => f.user));
                const followedPeople = allProfiles.filter(p => followedUsernames.has(p.username));
                const followedAgencies = allAgencies.filter(a => followedUsernames.has(a.owner));

                let followedPeopleHTML = followedPeople.length > 0 ? followedPeople.map(p => `
                    <li class="my-jobs-list">
                        <img src="${p.avatarPath || DEFAULT_PERSON_AVATAR}" alt="${p.fullName}" class="job-list-image" style="border-radius: 50%;">
                        <span class="job-list-title">${p.fullName}</span>
                        <div class="job-actions">
                            <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${p.username}" style="padding: 5px 10px; font-size: 0.8rem;">Profile</button>
                            <button class="jkit-btn jkit-btn-outline follow-btn" data-username="${p.username}" style="padding: 5px 10px; font-size: 0.8rem;">Following</button>
                        </div>
                    </li>`).join('') : '<li><p>You are not following any people yet.</p></li>';

                let followedAgenciesHTML = followedAgencies.length > 0 ? followedAgencies.map(a => `
                    <li class="my-jobs-list">
                        <img src="${a.imagePath || DEFAULT_AGENCY_AVATAR}" alt="${a.name}" class="job-list-image">
                        <span class="job-list-title">${a.name}</span>
                        <div class="job-actions">
                            <button class="jkit-btn jkit-btn-outline view-agency-btn" data-agency-id="${a.agencyId}" style="padding: 5px 10px; font-size: 0.8rem;">View</button>
                            <button class="jkit-btn jkit-btn-outline follow-btn" data-username="${a.owner}" style="padding: 5px 10px; font-size: 0.8rem;">Following</button>
                        </div>
                    </li>`).join('') : '<li><p>You are not following any agencies yet.</p></li>';
                
                panelsHTML += `<div id="following-panel" class="dashboard-panel">
                    <h3>People I Follow</h3>
                    <ul class="my-jobs-list">${followedPeopleHTML}</ul>
                    <h3 style="margin-top: 2rem;">Agencies I Follow</h3>
                    <ul class="my-jobs-list">${followedAgenciesHTML}</ul>
                </div>`;
                
                navHTML += `<li><button data-panel="notifications-panel"><i class="fas fa-bell"></i> Notifications</button></li>`;
                panelsHTML += `<div id="notifications-panel" class="dashboard-panel"><h3>Notification History</h3><ul class="my-jobs-list" id="dashboard-notification-list"></ul></div>`;


                navHTML += `<li><button data-panel="account-settings-panel" class="danger-zone-btn"><i class="fas fa-cog"></i> Account Settings</button></li>`;
                panelsHTML += `<div id="account-settings-panel" class="dashboard-panel">
                    <h3>Account Settings</h3>
                    <div style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--jkit-border-color);">
                        <h4>Password Reset</h4>
                        <p>If you've forgotten your password or wish to change it, you can request a password reset link to be sent to your email.</p>
                        <button class="jkit-btn" id="request-password-reset-btn" style="margin-top: 1rem;">Request Password Reset</button>
                    </div>
                    <div>
                        <h4 style="color: var(--airbnb-red);">Danger Zone</h4>
                        <p>Deleting your account is permanent. All of your data will be removed and cannot be recovered.</p>
                        ${currentUser.isAdmin 
                            ? `<button class="jkit-btn jkit-btn-danger" disabled title="The main admin account cannot be deleted." style="margin-top: 1rem;">Delete My Account</button>` 
                            : `<button class="jkit-btn jkit-btn-danger" id="delete-account-btn" style="margin-top: 1rem;">Delete My Account</button>`
                        }
                    </div>
                </div>`;

                navHTML += `<li><button data-panel="news-panel"><i class="fas fa-newspaper"></i> Manage News</button></li>`;

                if (currentUser && currentUser.isAdmin) {
                    navHTML += `<li><button data-panel="admin-jobs-panel"><i class="fas fa-hammer"></i> Job Management</button></li>`; 
                    navHTML += `<li><button data-panel="about-content-panel"><i class="fas fa-info-circle"></i> Manage About Page</button></li>`; 
                    navHTML += `<li><button data-panel="job-categories-panel"><i class="fas fa-sitemap"></i> Manage Job Categories</button></li>`;
                    navHTML += `<li><button data-panel="default-images-panel"><i class="fas fa-image"></i> Default Images</button></li>`;
                    navHTML += `<li><button data-panel="manage-timeline-panel"><i class="fas fa-stream"></i> Manage Timeline</button></li>`;
                    navHTML += `<li><button data-panel="admin-panel" style="color: var(--airbnb-red);"><i class="fas fa-user-shield"></i> User Management</button></li>`;
                    navHTML += `<li><button data-panel="timeline-panel"><i class="fas fa-history"></i> Site Event Log</button></li>`;
                    
                    let usersTableRows = allUsers.map(user => {
                        const profile = allProfiles.find(p => p.username === user.username);
                        const agency = allAgencies.find(a => a.owner === user.username);
                        let verificationHTML = '';
                        
                        if (user.type === 'Worker' || user.type === 'Talent' || user.type === 'Employer') {
                            if (profile) {
                                verificationHTML = `
                                    <label class="toggle-switch" title="Verify User Profile">
                                        <input type="checkbox" class="verification-toggle" data-type="profile" data-id="${user.username}" ${profile.isVerified ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                `;
                            }
                        } else if (user.type === 'Agent') {
                                if (agency) {
                                    verificationHTML = `
                                    <label class="toggle-switch" title="Verify Agency">
                                        <input type="checkbox" class="verification-toggle" data-type="agency" data-id="${agency.agencyId}" ${agency.isVerified ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                `;
                                }
                        }

                        return `
                        <tr>
                            <td data-label="Full Name">${user.fullName}</td>
                            <td data-label="Username">${user.username}</td>
                            <td data-label="Email">${user.email}</td>
                            <td data-label="Type">${user.type}</td>
                            <td data-label="JIN">${user.jkitId || 'N/A'}</td>
                            <td data-label="Verification">${verificationHTML}</td>
                            <td data-label="Actions">
                                <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${user.username}">View Profile</button>
                                <button class="jkit-btn jkit-btn-outline reset-password-btn" data-username="${user.username}">Reset Pass</button>
                                <button class="jkit-btn delete-user-btn" data-username="${user.username}" ${user.isAdmin ? 'disabled' : ''}>Delete</button>
                            </td>
                        </tr>
                    `}).join('');
                    panelsHTML += `<div id="admin-panel" class="dashboard-panel admin-user-management-panel">
                        <h3>User Management</h3>
                        <div class="admin-user-filters">
                            <div class="admin-filter-group">
                                <label for="admin-user-type-filter">Filter by Type:</label>
                                <select id="admin-user-type-filter" class="admin-filter-select">
                                    <option value="all">All Types</option>
                                    <option value="Worker">Worker</option>
                                    <option value="Talent">Talent</option>
                                    <option value="Employer">Employer</option>
                                    <option value="Agent">Agent</option>
                                </select>
                            </div>
                            <div class="admin-filter-group">
                                <label for="admin-user-search">Search:</label>
                                <input type="text" id="admin-user-search" class="admin-search-input" placeholder="Search by name, username, email, or JIN...">
                            </div>
                        </div>
                        <div class="admin-table-scroll-wrapper">
                            <div class="admin-table-container">
                                <table class="admin-user-table">
                                    <thead><tr><th>Full Name</th><th>Username</th><th>Email</th><th>Type</th><th>JIN</th><th>Verification</th><th>Actions</th></tr></thead>
                                    <tbody id="admin-user-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="admin-scroll-buttons-container">
                            <button class="admin-scroll-btn admin-scroll-left" aria-label="Scroll left">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="admin-scroll-btn admin-scroll-right" aria-label="Scroll right">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="admin-user-pagination">
                            <div class="admin-pagination-info">
                                <span id="admin-pagination-info-text">Showing 0 of 0 users</span>
                            </div>
                            <div class="admin-pagination-controls">
                                <button class="admin-pagination-btn" id="admin-pagination-prev" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span class="admin-pagination-page-info">
                                    Page <span id="admin-pagination-current-page">1</span> of <span id="admin-pagination-total-pages">1</span>
                                </span>
                                <button class="admin-pagination-btn" id="admin-pagination-next" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;

                    let allJobsListHTML = allJobs.length > 0 ? allJobs.map(job => `<li>
                        <img src="${job.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="${job.title}" class="job-list-image">
                        <div style="display: flex; flex-direction: column; flex-grow: 1;">
                            <span class="job-list-title">${job.title}</span>
                            <span style="font-size: 0.8rem; color: var(--jkit-text-muted);">Posted by: ${job.postedBy}</span>
                        </div>
                        <span class="job-status ${job.status || 'open'}">${job.status || 'open'}</span>
                        <div class="job-actions">
                            <button class="jkit-btn jkit-btn-outline apply-btn" data-job-id="${job.jobId}" style="padding: 5px 10px; font-size: 0.8rem;">View</button>
                            <button class="jkit-btn delete-btn admin-job-delete-btn" data-job-id="${job.jobId}" title="Delete Job"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>`).join('') : '<li><p>There are no jobs on the platform.</p></li>';
                    panelsHTML += `<div id="admin-jobs-panel" class="dashboard-panel"><h3>All Platform Jobs</h3><ul class="my-jobs-list">${allJobsListHTML}</ul></div>`;


                    panelsHTML += `<div id="job-categories-panel" class="dashboard-panel"></div>`;
                    panelsHTML += `<div id="about-content-panel" class="dashboard-panel"></div>`;

                    let timelineEventsListHTML = allTimelineEvents.length > 0 ? allTimelineEvents.map(event => `
                        <li class="my-events-list">
                            <img src="${event.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="${event.title}" class="event-list-image">
                            <span class="event-list-title">${event.title}</span>
                            <div class="event-actions">
                                <button class="edit-btn edit-timeline-event-btn" data-event-id="${event.timelineEventId}" title="Edit Timeline Event"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn delete-timeline-event-btn" data-event-id="${event.timelineEventId}" title="Delete Timeline Event"><i class="fas fa-trash"></i></button>
                            </div>
                        </li>`).join('') : '<li><p>No timeline events have been created yet.</p></li>';
                    panelsHTML += `<div id="manage-timeline-panel" class="dashboard-panel">
                        <h3>Manage Site Timeline</h3>
                        <button class="jkit-btn" id="dashboard-create-timeline-event-btn">+ Create New Timeline Event</button>
                        <ul class="my-events-list">${timelineEventsListHTML}</ul>
                    </div>`;

                    let timelineRows = allEventLogs.map(log => {
                        let detailsText = '';
                        if (typeof log.details === 'string') {
                            detailsText = log.details;
                        } else if (log.details && log.details.message) {
                            detailsText = log.details.message;
                        } else {
                            detailsText = JSON.stringify(log.details);
                        }
                        return `
                            <tr>
                                <td data-label="Time" class="timeline-time">${new Date(log.createdAt).toLocaleString()}</td>
                                <td data-label="Actor"><strong>${log.actorUsername}</strong></td>
                                <td data-label="Event">${detailsText}</td>
                            </tr>
                        `}).join('');
                    panelsHTML += `<div id="timeline-panel" class="dashboard-panel">
                        <h3>Site Event Log</h3>
                        <div style="overflow-x: auto;">
                            <table class="admin-timeline-table">
                                <thead><tr><th>Time</th><th>Actor</th><th>Event</th></tr></thead>
                                <tbody id="timeline-body">${timelineRows}</tbody>
                            </table>
                        </div>
                    </div>`;
                    
                    panelsHTML += `<div id="default-images-panel" class="dashboard-panel">
                        <div class="actions-header">
                                <h3>Manage Default Images</h3>
                                <div>
                                <button class="jkit-btn jkit-btn-outline" id="collapse-all-images-btn" style="padding: 6px 12px; font-size: 0.8rem;">Collapse All</button>
                                <button class="jkit-btn jkit-btn-outline" id="expand-all-images-btn" style="padding: 6px 12px; font-size: 0.8rem;">Expand All</button>
                            </div>
                        </div>

                        <div class="default-image-category-section">
                            <h4>Site-Wide Defaults</h4>
                            <div class="default-image-row">
                                <strong class="item-name">Default User Avatar</strong>
                                <div class="image-upload-wrapper">
                                    <img src="${DEFAULT_PERSON_AVATAR}" alt="User Avatar Preview" class="image-preview">
                                    <label class="image-upload-label">
                                        Upload
                                        <input type="file" class="default-image-input" accept="image/*" data-target-type="user-avatar">
                                    </label>
                                    <input type="hidden" class="default-image-path" value="${settings.defaultPersonAvatar || ''}">
                                </div>
                            </div>
                                <div class="default-image-row">
                                <strong class="item-name">Default Agency Avatar</strong>
                                <div class="image-upload-wrapper">
                                    <img src="${DEFAULT_AGENCY_AVATAR}" alt="Agency Avatar Preview" class="image-preview">
                                    <label class="image-upload-label">
                                        Upload
                                        <input type="file" class="default-image-input" accept="image/*" data-target-type="agency-avatar">
                                    </label>
                                    <input type="hidden" class="default-image-path" value="${settings.defaultAgencyAvatar || ''}">
                                </div>
                            </div>
                            <div class="default-image-row">
                                <strong class="item-name">Global Fallback Image</strong>
                                <div class="image-upload-wrapper">
                                    <img src="${GLOBAL_FALLBACK_IMAGE}" alt="Global Fallback Preview" class="image-preview">
                                    <label class="image-upload-label">
                                        Upload
                                        <input type="file" class="default-image-input" accept="image/*" data-target-type="global-fallback">
                                    </label>
                                    <input type="hidden" class="default-image-path" value="${settings.globalFallbackImage || ''}">
                                </div>
                            </div>
                        </div>

                        ${allJobCategories.sort((a, b) => a.name.localeCompare(b.name)).map(cat => `
                            <div class="default-image-category-section jobs-collapsed" data-category-name="${cat.name}">
                                <div class="default-image-category-header">
                                    <h4>${cat.name}</h4>
                                    ${cat.jobs && cat.jobs.length > 0 ? `
                                    <button class="toggle-specific-jobs-btn" type="button" aria-expanded="false" title="Toggle specific jobs visibility">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    ` : ''}
                                </div>

                                <div class="default-image-row">
                                    <div style="flex-grow: 1;">
                                        <strong class="item-name">Main Category Image</strong>
                                        <div class="toggle-switch-container" style="margin-top: 8px;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" class="category-image-toggle" ${cat.useCategoryDefaultImage ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                        <span>Use as fallback for jobs in this category</span>
                                        </div>
                                    </div>
                                    <div class="image-upload-wrapper">
                                        <img src="${cat.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="Category Preview" class="image-preview">
                                        <label class="image-upload-label">
                                            Upload
                                            <input type="file" class="default-image-input" accept="image/*" data-target-type="category">
                                        </label>
                                        <input type="hidden" class="default-image-path" value="${cat.imagePath || ''}">
                                    </div>
                                </div>
                                
                                ${cat.jobs && cat.jobs.length > 0 ? `
                                <div class="specific-jobs-container collapsed">
                                    ${cat.jobs.sort((a,b) => a.name.localeCompare(b.name)).map(job => `
                                        <div class="default-image-row specific-job-row" data-job-name="${job.name}">
                                            <span class="item-name">${job.name}</span>
                                            <div class="image-upload-wrapper">
                                                <img src="${job.imagePath || GLOBAL_FALLBACK_IMAGE}" alt="Job Preview" class="image-preview">
                                                <label class="image-upload-label">
                                                    Upload
                                                    <input type="file" class="default-image-input" accept="image/*" data-target-type="specific-job">
                                                </label>
                                                <input type="hidden" class="default-image-path" value="${job.imagePath || ''}">
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                        <button id="save-default-images-btn" class="jkit-btn" style="margin-top: 2rem;">Save All Image Changes</button>
                    </div>`;
                }

                // News panel - available to all users
                let newsListHTML = allNewsArticles.length > 0 ? allNewsArticles.map(article => `
                    <li class="my-news-list">
                        <img src="${article.imagePath}" alt="${article.title}" class="news-list-image">
                        <span class="news-list-title">${article.title}</span>
                        <div class="news-actions">
                            <button class="edit-btn" data-article-id="${article.articleId}" title="Edit Article"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-article-id="${article.articleId}" title="Delete Article"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>`).join('') : '<li><p>No news articles have been created yet.</p></li>';

                panelsHTML += `<div id="news-panel" class="dashboard-panel"><h3>Manage News</h3><button class="jkit-btn" id="dashboard-create-news-btn">+ Create New Article</button><ul class="my-news-list">${newsListHTML}</ul></div>`;

                container.innerHTML = `<h2>Welcome, ${profile.fullName}</h2><div class="dashboard-grid"><nav class="dashboard-nav"><ul>${navHTML}</ul></nav><div class="dashboard-content">${panelsHTML}</div></div>`;
                
                if (currentUser && currentUser.isAdmin) {
                    renderJobCategoriesAdminPanel();
                    renderAboutContentAdminPanel();
                }

                updateUnreadBadge('request');
                
                const serviceContainer = document.getElementById('service-rate-container');
                if (serviceContainer && profile.services && Object.keys(profile.services).length > 0) {
                    for (const [service, rate] of Object.entries(profile.services)) {
                        addServiceRateRow(service, rate);
                    }
                }
                
                const agencyServiceContainer = document.getElementById('agency-service-rate-container');
                const myAgency = allAgencies.find(a => a.owner === currentUser.username);
                if (agencyServiceContainer && myAgency && myAgency.services) {
                    for (const [service, rate] of Object.entries(myAgency.services)) {
                        addAgencyServiceRateRow(service, rate);
                    }
                }

                const cvStatusDisplay = document.getElementById('cv-status-display');
                if (profile.cvPath) {
                    const filename = profile.cvPath.split('/').pop();
                    cvStatusDisplay.textContent = `Current CV: ${filename}`;
                } else {
                    cvStatusDisplay.textContent = 'No CV uploaded.';
                }

                const dashboardNav = document.querySelector('.dashboard-nav');
                const lastTabKey = `jkit_lastDashboardTab_${currentUser.username}`;
                const lastActiveTab = localStorage.getItem(lastTabKey) || 'profile-panel';
                const tabButton = dashboardNav.querySelector(`button[data-panel="${lastActiveTab}"]`);
                
                if (tabButton) {
                    dashboardNav.querySelector('.active')?.classList.remove('active');
                    tabButton.classList.add('active');
                    document.querySelectorAll('.dashboard-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(lastActiveTab)?.classList.add('active');
                }

                renderDashboardNotifications();
                bindDashboardEvents();

                // --- NEW: Initialize map after HTML is rendered ---
                if (document.getElementById(lastActiveTab) === document.getElementById('profile-panel')) {
                    initDashboardMap(profile.location);
                }
                
                // Initialize admin table scroll buttons
                initAdminTableScrollButtons();
                
                // Initialize admin user management (filter, search, pagination)
                if (currentUser && currentUser.isAdmin) {
                    initAdminUserManagement();
                }
            }

            // --- NEW: Leaflet Map initialization and handling ---
            async function initDashboardMap(initialLocation) {
                const mapContainer = document.getElementById('dashboard-map-container');
                const locationInput = document.getElementById('profile-location');
                if (!mapContainer || !locationInput) return;

                // If a map instance exists, remove it before re-initializing
                if (dashboardMap) {
                    dashboardMap.remove();
                    dashboardMap = null;
                }

                dashboardMap = L.map(mapContainer);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(dashboardMap);

                let initialLatLng = [-22.5594, 17.0832]; // Default to Windhoek
                let initialZoom = 10;

                const setMarkerAndPan = (lat, lon, zoom) => {
                    if (dashboardMarker) {
                        dashboardMarker.setLatLng([lat, lon]);
                    } else {
                        dashboardMarker = L.marker([lat, lon], { draggable: true }).addTo(dashboardMap);
                        dashboardMarker.on('dragend', async (event) => {
                            const { lat, lng } = event.target.getLatLng();
                            // Reverse geocode
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                            const data = await response.json();
                            if (data && data.display_name) {
                                locationInput.value = data.display_name;
                            }
                        });
                    }
                    dashboardMap.setView([lat, lon], zoom);
                };

                if (initialLocation) {
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(initialLocation)}&format=json&limit=1`);
                        const data = await response.json();
                        if (data && data.length > 0) {
                            initialLatLng = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                            initialZoom = 14;
                        }
                    } catch (e) { console.error("Geocoding failed:", e); }
                }
                
                setMarkerAndPan(initialLatLng[0], initialLatLng[1], initialZoom);

                dashboardMap.on('click', async (e) => {
                    const { lat, lng } = e.latlng;
                    setMarkerAndPan(lat, lng, dashboardMap.getZoom());
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
                    const data = await response.json();
                    if (data && data.display_name) {
                        locationInput.value = data.display_name;
                    }
                });

                locationInput.addEventListener('change', async () => {
                    const address = locationInput.value;
                    if (address) {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`);
                            const data = await response.json();
                            if (data && data.length > 0) {
                                setMarkerAndPan(parseFloat(data[0].lat), parseFloat(data[0].lon), 14);
                            }
                        } catch(e) { console.error("Geocoding on input change failed:", e); }
                    }
                });

                document.getElementById('find-my-location-btn').addEventListener('click', () => {
                    const geoInfo = document.getElementById('geolocation-info');
                    if (navigator.geolocation) {
                        geoInfo.textContent = 'Finding your location...';
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const { latitude, longitude } = position.coords;
                            setMarkerAndPan(latitude, longitude, 15);
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                            const data = await response.json();
                            if (data && data.display_name) {
                                locationInput.value = data.display_name;
                                geoInfo.textContent = 'Location found!';
                            } else {
                                geoInfo.textContent = 'Could not determine address.';
                            }
                        }, () => {
                            geoInfo.textContent = 'Geolocation is not supported or was denied.';
                        });
                    } else {
                        geoInfo.textContent = 'Geolocation is not supported by your browser.';
                    }
                });
            }
            
            function initAdminTableScrollButtons() {
                const adminPanel = document.getElementById('admin-panel');
                if (!adminPanel) return;
                
                const scrollWrapper = adminPanel.querySelector('.admin-table-scroll-wrapper');
                const scrollContainer = adminPanel.querySelector('.admin-table-container');
                const scrollButtonsContainer = adminPanel.querySelector('.admin-scroll-buttons-container');
                const scrollLeftBtn = adminPanel.querySelector('.admin-scroll-left');
                const scrollRightBtn = adminPanel.querySelector('.admin-scroll-right');
                
                if (!scrollWrapper || !scrollContainer || !scrollLeftBtn || !scrollRightBtn) return;
                
                function updateButtonStates() {
                    const isAtStart = scrollContainer.scrollLeft <= 0;
                    const isAtEnd = scrollContainer.scrollWidth - scrollContainer.clientWidth - scrollContainer.scrollLeft < 1;
                    
                    scrollLeftBtn.disabled = isAtStart;
                    scrollRightBtn.disabled = isAtEnd;
                }
                
                scrollLeftBtn.addEventListener('click', () => {
                    scrollContainer.scrollTo({
                        left: 0,
                        behavior: 'smooth'
                    });
                });
                
                scrollRightBtn.addEventListener('click', () => {
                    scrollContainer.scrollTo({
                        left: scrollContainer.scrollWidth,
                        behavior: 'smooth'
                    });
                });
                
                scrollContainer.addEventListener('scroll', () => {
                    window.requestAnimationFrame(updateButtonStates);
                });
                
                // Update on resize
                new ResizeObserver(updateButtonStates).observe(scrollContainer);
                
                // Initial state
                updateButtonStates();
            }
            
            // Admin User Management: Filter, Search, and Pagination
            let adminUserManagementState = {
                allUsers: [],
                filteredUsers: [],
                currentPage: 1,
                itemsPerPage: 20,
                currentFilter: 'all',
                currentSearch: ''
            };
            
            function initAdminUserManagement() {
                const adminPanel = document.getElementById('admin-panel');
                if (!adminPanel) return;
                
                // Store all users data
                adminUserManagementState.allUsers = allUsers.map(user => {
                    const profile = allProfiles.find(p => p.username === user.username);
                    const agency = allAgencies.find(a => a.owner === user.username);
                    return { user, profile, agency };
                });
                
                // Initialize with all users
                adminUserManagementState.filteredUsers = [...adminUserManagementState.allUsers];
                
                // Render initial table
                renderAdminUserTable();
                
                // Add event listeners
                const typeFilter = document.getElementById('admin-user-type-filter');
                const searchInput = document.getElementById('admin-user-search');
                const prevBtn = document.getElementById('admin-pagination-prev');
                const nextBtn = document.getElementById('admin-pagination-next');
                
                if (typeFilter) {
                    typeFilter.addEventListener('change', (e) => {
                        adminUserManagementState.currentFilter = e.target.value;
                        adminUserManagementState.currentPage = 1;
                        filterAndSearchUsers();
                    });
                }
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        adminUserManagementState.currentSearch = e.target.value.toLowerCase().trim();
                        adminUserManagementState.currentPage = 1;
                        filterAndSearchUsers();
                    });
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        if (adminUserManagementState.currentPage > 1) {
                            adminUserManagementState.currentPage--;
                            renderAdminUserTable();
                            scrollToUserTable();
                        }
                    });
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const totalPages = Math.ceil(adminUserManagementState.filteredUsers.length / adminUserManagementState.itemsPerPage);
                        if (adminUserManagementState.currentPage < totalPages) {
                            adminUserManagementState.currentPage++;
                            renderAdminUserTable();
                            scrollToUserTable();
                        }
                    });
                }
            }
            
            function filterAndSearchUsers() {
                let filtered = [...adminUserManagementState.allUsers];
                
                // Filter by type
                if (adminUserManagementState.currentFilter !== 'all') {
                    filtered = filtered.filter(item => item.user.type === adminUserManagementState.currentFilter);
                }
                
                // Search filter
                if (adminUserManagementState.currentSearch) {
                    const searchTerm = adminUserManagementState.currentSearch;
                    filtered = filtered.filter(item => {
                        const user = item.user;
                        return (
                            (user.fullName && user.fullName.toLowerCase().includes(searchTerm)) ||
                            (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                            (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                            (user.jkitId && user.jkitId.toLowerCase().includes(searchTerm))
                        );
                    });
                }
                
                adminUserManagementState.filteredUsers = filtered;
                renderAdminUserTable();
            }
            
            function renderAdminUserTable() {
                const tableBody = document.getElementById('admin-user-table-body');
                if (!tableBody) return;
                
                const { filteredUsers, currentPage, itemsPerPage } = adminUserManagementState;
                const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageUsers = filteredUsers.slice(startIndex, endIndex);
                
                // Render table rows
                tableBody.innerHTML = pageUsers.map(({ user, profile, agency }) => {
                    let verificationHTML = '';
                    
                    if (user.type === 'Worker' || user.type === 'Talent' || user.type === 'Employer') {
                        if (profile) {
                            verificationHTML = `
                                <label class="toggle-switch" title="Verify User Profile">
                                    <input type="checkbox" class="verification-toggle" data-type="profile" data-id="${user.username}" ${profile.isVerified ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            `;
                        }
                    } else if (user.type === 'Agent') {
                        if (agency) {
                            verificationHTML = `
                                <label class="toggle-switch" title="Verify Agency">
                                    <input type="checkbox" class="verification-toggle" data-type="agency" data-id="${agency.agencyId}" ${agency.isVerified ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                            `;
                        }
                    }
                    
                    return `
                        <tr>
                            <td data-label="Full Name">${user.fullName}</td>
                            <td data-label="Username">${user.username}</td>
                            <td data-label="Email">${user.email}</td>
                            <td data-label="Type">${user.type}</td>
                            <td data-label="JIN">${user.jkitId || 'N/A'}</td>
                            <td data-label="Verification">${verificationHTML}</td>
                            <td data-label="Actions">
                                <button class="jkit-btn jkit-btn-outline view-profile-btn" data-username="${user.username}">View Profile</button>
                                <button class="jkit-btn jkit-btn-outline reset-password-btn" data-username="${user.username}">Reset Pass</button>
                                <button class="jkit-btn delete-user-btn" data-username="${user.username}" ${user.isAdmin ? 'disabled' : ''}>Delete</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Update pagination info
                updatePaginationInfo(filteredUsers.length, startIndex + 1, Math.min(endIndex, filteredUsers.length), totalPages);
                
                // Re-bind event listeners for verification toggles and action buttons
                bindAdminUserActionButtons();
            }
            
            function updatePaginationInfo(total, start, end, totalPages) {
                const infoText = document.getElementById('admin-pagination-info-text');
                const currentPageSpan = document.getElementById('admin-pagination-current-page');
                const totalPagesSpan = document.getElementById('admin-pagination-total-pages');
                const prevBtn = document.getElementById('admin-pagination-prev');
                const nextBtn = document.getElementById('admin-pagination-next');
                
                if (infoText) {
                    infoText.textContent = `Showing ${start} to ${end} of ${total} users`;
                }
                
                if (currentPageSpan) {
                    currentPageSpan.textContent = adminUserManagementState.currentPage;
                }
                
                if (totalPagesSpan) {
                    totalPagesSpan.textContent = totalPages || 1;
                }
                
                if (prevBtn) {
                    prevBtn.disabled = adminUserManagementState.currentPage === 1;
                }
                
                if (nextBtn) {
                    nextBtn.disabled = adminUserManagementState.currentPage >= totalPages;
                }
            }
            
            function scrollToUserTable() {
                const adminPanel = document.getElementById('admin-panel');
                if (adminPanel) {
                    adminPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
            
            function bindAdminUserActionButtons() {
                // Event delegation is already handled in bindDashboardEvents
                // This function is kept for future extensibility if needed
            }

            function addServiceRateRow(service = '', rate = '') {
                const container = document.getElementById('service-rate-container');
                if (!container) return;
                const div = document.createElement('div');
                div.className = 'service-rate-item';
                div.innerHTML = `
                    <input type="text" class="service-input" placeholder="Service Name (e.g., Plumbing)" value="${service}">
                    <input type="number" class="rate-input" placeholder="N$ Rate" value="${rate}">
                    <button type="button" class="remove-service-btn" aria-label="Remove Service">&times;</button>
                `;
                container.appendChild(div);
            }

            function addAgencyServiceRateRow(service = '', rate = '') {
                const container = document.getElementById('agency-service-rate-container');
                if (!container) return;
                const div = document.createElement('div');
                div.className = 'service-rate-item';
                div.innerHTML = `
                    <input type="text" class="service-input" placeholder="Agency Service Name" value="${service}">
                    <input type="number" class="rate-input" placeholder="N$ Rate" value="${rate}">
                    <button type="button" class="remove-service-btn" aria-label="Remove Service">&times;</button>
                `;
                container.appendChild(div);
            }

            async function handleApplicationAction(jobId, username, action) {
                const confirmMessage = action === 'accept'
                    ? `Are you sure you want to hire ${username}? Other applicants for this job will be automatically rejected.`
                    : `Are you sure you want to reject ${username}'s application?`;

                if (confirm(confirmMessage)) {
                    try {
                        const response = await fetch(`/api/jobs/${jobId}/applicants/${username}/handle`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action }),
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (!response.ok) {
                            throw new Error(result.message);
                        }
                        showToast(result.message, 'success');
                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                    }
                }
            }

            async function deleteContent(type, id, confirmMessage) {
                if (confirm(confirmMessage)) {
                    try {
                        const response = await fetch(`/api/content/${type}/${id}`, { 
                            method: 'DELETE', 
                            credentials: 'include' 
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.message);
                        }
                        showToast(`${type.slice(0, -1)} deleted successfully.`, 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } catch (error) {
                        showToast(`Error deleting: ${error.message}`, 'error');
                    }
                }
            }
            
            function bindDashboardEvents() { 
                const dashboardNav = document.querySelector('.dashboard-nav'); 
                if (!dashboardNav) return; 
                dashboardNav.addEventListener('click', e => { 
                    const button = e.target.closest('button'); 
                    if (button && button.dataset.panel) { 
                        const panelId = button.dataset.panel;
                        dashboardNav.querySelector('.active')?.classList.remove('active'); 
                        button.classList.add('active'); 
                        document.querySelectorAll('.dashboard-panel').forEach(p => p.classList.remove('active')); 
                        const targetPanel = document.getElementById(panelId);
                        if (targetPanel) {
                            targetPanel.classList.add('active');
                             // --- NEW: Re-initialize map if profile tab is selected ---
                            if (panelId === 'profile-panel' && currentUser) {
                                const profile = allProfiles.find(p => p.username === currentUser.username);
                                if (profile) {
                                    initDashboardMap(profile.location);
                                }
                            }
                        }
                        if (currentUser) {
                            localStorage.setItem(`jkit_lastDashboardTab_${currentUser.username}`, panelId);
                        }
                    } 
                }); 
                
                document.getElementById('add-service-btn')?.addEventListener('click', () => {
                    addServiceRateRow();
                });

                document.getElementById('service-rate-container')?.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-service-btn')) {
                        e.target.closest('.service-rate-item').remove();
                    }
                });
                
                document.getElementById('add-agency-service-btn')?.addEventListener('click', () => {
                    addAgencyServiceRateRow();
                });

                document.getElementById('agency-service-rate-container')?.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-service-btn')) {
                        e.target.closest('.service-rate-item').remove();
                    }
                });

                document.getElementById('request-password-reset-btn')?.addEventListener('click', async () => {
                    try {
                        const response = await fetch('/api/users/request-password-reset', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: currentUser.email }),
                            credentials: 'include'
                        });
                        const result = await response.json();
                        showToast(result.message, 'info');
                    } catch (error) {
                        showToast('An error occurred. Please try again later.', 'error');
                    }
                });

                document.getElementById('delete-account-btn')?.addEventListener('click', () => {
                    showModal(deleteAccountModal);
                });

                document.getElementById('delete-account-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Deleting...';

                    const password = document.getElementById('delete-confirm-password').value;
                    if (!password) {
                        showToast('Please enter your password to confirm deletion.', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Delete My Account Permanently';
                        return;
                    }
                    try {
                        const response = await fetch('/api/users/delete-account', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password }),
                            credentials: 'include'
                        });
                        const result = await response.json();
                        if (!response.ok) {
                            throw new Error(result.message || 'Failed to delete account.');
                        }
                        showToast(result.message, 'success');
                        setTimeout(() => window.location.href = '/', 2000);
                    } catch (error) {
                        showToast(`Error: ${error.message}`, 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Delete My Account Permanently';
                    }
                });
                
                document.querySelector('.dashboard-content')?.addEventListener('click', async e => {
                    const acceptBtn = e.target.closest('.accept-request-btn');
                    const rejectBtn = e.target.closest('.reject-request-btn');
                    const editNewsBtn = e.target.closest('.news-actions .edit-btn');
                    const deleteNewsBtn = e.target.closest('.news-actions .delete-btn');
                    const acceptJobBtn = e.target.closest('.accept-job-btn');
                    const declineJobBtn = e.target.closest('.decline-job-btn');
                    const deleteUserBtn = e.target.closest('.delete-user-btn');
                    const resetPassBtn = e.target.closest('.reset-password-btn');
                    const rateJobBtn = e.target.closest('.rate-job-btn'); // <-- NEW

                    const acceptApplicantBtn = e.target.closest('.accept-applicant-btn');
                    const rejectApplicantBtn = e.target.closest('.reject-applicant-btn');
                    const adminJobDeleteBtn = e.target.closest('.admin-job-delete-btn'); 
                    const editTimelineEventBtn = e.target.closest('.edit-timeline-event-btn');
                    const deleteTimelineEventBtn = e.target.closest('.delete-timeline-event-btn');
                    
                    if (editTimelineEventBtn) { 
                        openTimelineEventModal(editTimelineEventBtn.dataset.eventId);
                    }
                    if (deleteTimelineEventBtn) {
                        const eventId = deleteTimelineEventBtn.dataset.eventId;
                        deleteData(true, `timeline-events/${eventId}`, 'Are you sure you want to delete this timeline event?');
                    }

                    if (adminJobDeleteBtn) { 
                        deleteContent('jobs', adminJobDeleteBtn.dataset.jobId, 'Are you sure you want to permanently delete this job from the platform?');
                    }
                    if (acceptApplicantBtn) {
                        handleApplicationAction(acceptApplicantBtn.dataset.jobId, acceptApplicantBtn.dataset.username, 'accept');
                    }
                    if (rejectApplicantBtn) {
                        handleApplicationAction(rejectApplicantBtn.dataset.jobId, rejectApplicantBtn.dataset.username, 'reject');
                    }

                    if (acceptBtn) { handleJoinRequest(acceptBtn.dataset.requestId, 'accept'); }
                    if (rejectBtn) { handleJoinRequest(rejectBtn.dataset.requestId, 'reject'); }

                    if (deleteUserBtn) {
                        const username = deleteUserBtn.dataset.username;
                        if (confirm(`Are you sure you want to permanently delete the user '${username}'? This action cannot be undone.`)) {
                            try {
                                const response = await fetch(`/api/admin/users/${username}`, {
                                    method: 'DELETE',
                                    credentials: 'include'
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message);
                                showToast(result.message, 'success');
                                setTimeout(() => window.location.reload(), 1500); 
                            } catch (error) {
                                showToast(`Error deleting user: ${error.message}`, 'error');
                            }
                        }
                    }
                    if (resetPassBtn) {
                        const username = resetPassBtn.dataset.username;
                        if (confirm(`Are you sure you want to trigger a password reset for '${username}'?`)) {
                                try {
                                const response = await fetch(`/api/admin/users/reset-password/${username}`, {
                                    method: 'POST',
                                    credentials: 'include'
                                });
                                const result = await response.json();
                                if (!response.ok) throw new Error(result.message);
                                showToast(result.message, 'success');
                                setTimeout(() => window.location.reload(), 1500); 
                            } catch (error) {
                                showToast(`Error: ${error.message}`, 'error');
                            }
                        }
                    }

                    if (acceptJobBtn) {
                        const jobId = acceptJobBtn.dataset.jobId;
                        await saveData('jobs', jobId, { status: 'in-progress' });
                    }
                    if (declineJobBtn) {
                        const jobId = declineJobBtn.dataset.jobId;
                        await saveData('jobs', jobId, { status: 'open', assignedTo: null });
                    }
                    if (editNewsBtn) {
                        openNewsModal(editNewsBtn.dataset.articleId);
                    }
                    if (deleteNewsBtn) {
                        const articleId = deleteNewsBtn.dataset.articleId;
                        deleteData(true, `news/${articleId}`, 'Are you sure you want to delete this news article?');
                    }
                    if (rateJobBtn) { // <-- NEW
                        openRatingModal(rateJobBtn.dataset.jobId, rateJobBtn.dataset.workerUsername);
                    }
                });

                document.querySelector('.dashboard-content')?.addEventListener('change', async e => {
                    if (e.target.classList.contains('verification-toggle')) {
                        const toggle = e.target;
                        const { type, id } = toggle.dataset;
                        const isVerified = toggle.checked;

                        try {
                            const response = await fetch('/api/admin/verify', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ type, id, isVerified }),
                                credentials: 'include'
                            });

                            if (!response.ok) {
                                const err = await response.json();
                                throw new Error(err.message || `Failed to update ${type}`);
                            }
                            window.location.reload();
                        } catch (error) {
                            showToast(`Error: ${error.message}`, 'error');
                            toggle.checked = !isVerified; // Revert on failure
                        }
                    }
                });

                document.getElementById('profile-avatar-input')?.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if(file) {
                        document.getElementById('profile-avatar-preview').src = URL.createObjectURL(file);
                        const newPath = await handleFileUpload(file);
                        if (newPath) document.getElementById('profile-avatar-path-hidden').value = newPath;
                    }
                });

                document.getElementById('profile-cv-input')?.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if (file) {
                        const cvStatusDisplay = document.getElementById('cv-status-display');
                        cvStatusDisplay.textContent = `Uploading ${file.name}...`;
                        const newPath = await handleCvUpload(file);
                        if (newPath) {
                            document.getElementById('profile-cv-path-hidden').value = newPath;
                            cvStatusDisplay.textContent = `Upload complete: ${file.name}`;
                        } else {
                            cvStatusDisplay.textContent = 'Upload failed. Please try again.';
                        }
                    }
                });

                document.getElementById('agency-image-input')?.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if(file) {
                        document.getElementById('agency-image-preview').src = URL.createObjectURL(file);
                        const newPath = await handleFileUpload(file);
                        if (newPath) document.getElementById('agency-image-path-hidden').value = newPath;
                    }
                });
                document.getElementById('job-image-input')?.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if(file) {
                        document.getElementById('job-image-preview').src = URL.createObjectURL(file);
                        const newPath = await handleFileUpload(file);
                        if (newPath) document.getElementById('job-image-path-hidden').value = newPath;
                    }
                });

                document.getElementById('timeline-event-image-input')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('timeline-event-image-preview').src = URL.createObjectURL(file);
                        const newPath = await handleFileUpload(file);
                        if (newPath) document.getElementById('timeline-event-image-path-hidden').value = newPath;
                    }
                });

                document.getElementById('news-image-input')?.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('news-image-preview').src = URL.createObjectURL(file);
                        const newPath = await handleFileUpload(file);
                        if (newPath) document.getElementById('news-image-path-hidden').value = newPath;
                    }
                });

                const galleryContainer = document.getElementById('dashboard-gallery-container');
                if (galleryContainer) {
                    const mainImageEl = galleryContainer.querySelector('.dashboard-main-image img');
                    const thumbnailStrip = galleryContainer.querySelector('.dashboard-thumbnail-strip');

                    thumbnailStrip.addEventListener('click', e => {
                        const thumbItem = e.target.closest('.dashboard-thumbnail-item');
                        if (!thumbItem) return;

                        const thumbImg = thumbItem.querySelector('.dashboard-thumbnail-img');
                        if (thumbImg.src !== mainImageEl.src) {
                                mainImageEl.src = thumbImg.src;
                                thumbnailStrip.querySelectorAll('.dashboard-thumbnail-item').forEach(item => item.classList.remove('active'));
                                thumbItem.classList.add('active');
                        }
                    });

                    galleryContainer.addEventListener('change', async e => {
                        if (e.target.classList.contains('gallery-image-input')) {
                            const file = e.target.files[0];
                            if (!file) return;

                            const thumbItem = e.target.closest('.dashboard-thumbnail-item');
                            const thumbImg = thumbItem.querySelector('.dashboard-thumbnail-img');
                            const pathInput = thumbItem.querySelector('.gallery-image-path');
                            
                            thumbImg.src = URL.createObjectURL(file);
                            const newPath = await handleFileUpload(file);
                            if (newPath) {
                                pathInput.value = newPath;
                                if (thumbItem.classList.contains('active')) {
                                    mainImageEl.src = newPath;
                                }
                            }
                        }
                    });

                    galleryContainer.addEventListener('click', e => {
                        const removeBtn = e.target.closest('.remove-gallery-image-btn');
                        if (removeBtn) {
                            e.preventDefault();
                            const thumbItem = removeBtn.closest('.dashboard-thumbnail-item');
                            const thumbImg = thumbItem.querySelector('.dashboard-thumbnail-img');
                            const pathInput = thumbItem.querySelector('.gallery-image-path');
                            
                            thumbImg.src = GLOBAL_FALLBACK_IMAGE;
                            pathInput.value = '';
                            
                            if (thumbItem.classList.contains('active')) {
                                mainImageEl.src = GLOBAL_FALLBACK_IMAGE;
                            }
                        }
                    });
                }

                document.getElementById('profile-edit-form')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';
                    
                    try {
                        const services = {};
                        document.querySelectorAll('#service-rate-container .service-rate-item').forEach(item => {
                            const serviceName = item.querySelector('.service-input').value.trim();
                            const serviceRate = item.querySelector('.rate-input').value.trim();
                            if (serviceName && serviceRate) {
                                services[serviceName] = serviceRate;
                            }
                        });

                        const galleryPaths = Array.from(document.querySelectorAll('#dashboard-gallery-container .gallery-image-path'))
                                                    .map(input => input.value)
                                                    .filter(Boolean); 

                        const updatedProfile = { 
                            fullName: document.getElementById('profile-fullName').value, 
                            bio: document.getElementById('profile-bio').value, 
                            skills: document.getElementById('profile-skills').value.split(',').map(s => s.trim()).filter(Boolean), 
                            avatarPath: document.getElementById('profile-avatar-path-hidden').value, 
                            services: services, 
                            phone: document.getElementById('profile-phone').value, 
                            email: document.getElementById('profile-email').value, 
                            linkedin: document.getElementById('profile-linkedin').value, 
                            facebook: document.getElementById('profile-facebook').value, 
                            instagram: document.getElementById('profile-instagram').value,
                            x_twitter: document.getElementById('profile-x_twitter').value,
                            tiktok: document.getElementById('profile-tiktok').value,
                            whatsapp: document.getElementById('profile-whatsapp').value,
                            galleryImagePaths: galleryPaths, 
                            cvPath: document.getElementById('profile-cv-path-hidden').value,
                            location: document.getElementById('profile-location').value // --- NEW: Save location ---
                        };
                        await saveData('profiles', currentUser.username, updatedProfile);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Profile';
                    }
                });

                document.getElementById('agency-edit-form')?.addEventListener('submit', async e => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';

                    try {
                        const services = {};
                        document.querySelectorAll('#agency-service-rate-container .service-rate-item').forEach(item => {
                            const serviceName = item.querySelector('.service-input').value.trim();
                            const serviceRate = item.querySelector('.rate-input').value.trim();
                            if (serviceName && serviceRate) {
                                services[serviceName] = serviceRate;
                            }
                        });

                        const updatedAgency = { 
                            name: document.getElementById('agency-name').value, 
                            type: document.getElementById('agency-type').value, 
                            description: document.getElementById('agency-description').value, 
                            imagePath: document.getElementById('agency-image-path-hidden').value,
                            location: document.getElementById('agency-location').value,
                            services: services
                        };
                        await saveData('agencies', e.target.dataset.agencyId, updatedAgency);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Agency Details';
                    }
                });

                document.getElementById('create-new-agency-btn')?.addEventListener('click', async (e) => {
                    const submitBtn = e.target;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating...';
                    try {
                        const newAgency = { agencyId: `agency_${Date.now()}`, name: `${currentUser.fullName}'s Agency`, description: 'A brand new agency...', owner: currentUser.username, members: [], type: 'Individual Agency', services: {}, location: '' };
                        await createData('agencies', newAgency);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Create a New Agency';
                    }
                });

                document.getElementById('dashboard-post-job-btn')?.addEventListener('click', () => openJobModal());
                document.getElementById('dashboard-create-news-btn')?.addEventListener('click', () => openNewsModal());
                document.getElementById('dashboard-create-timeline-event-btn')?.addEventListener('click', () => openTimelineEventModal());
                document.querySelectorAll('.job-actions .edit-btn').forEach(btn => btn.addEventListener('click', () => openJobModal(btn.dataset.jobId)));
                document.querySelectorAll('.job-actions .delete-btn').forEach(btn => btn.addEventListener('click', () => deleteContent('jobs', btn.dataset.jobId, 'Are you sure you want to delete this job?')));
                document.querySelectorAll('.job-actions .close-btn').forEach(btn => btn.addEventListener('click', () => {
                    const job = allJobs.find(j => j.jobId === btn.dataset.jobId);
                    if(job) saveData('jobs', job.jobId, { ...job, status: 'closed' });
                }));
                
                const defaultImagesPanel = document.getElementById('default-images-panel');
                if (defaultImagesPanel) {
                    defaultImagesPanel.addEventListener('click', (e) => {
                        const header = e.target.closest('.default-image-category-header');
                        if (header) {
                            const section = header.closest('.default-image-category-section');
                            const container = section.querySelector('.specific-jobs-container');
                            const button = header.querySelector('.toggle-specific-jobs-btn');
                            
                            if (section && container && button) {
                                const isCollapsing = !section.classList.contains('jobs-collapsed');
                                section.classList.toggle('jobs-collapsed', isCollapsing);
                                container.classList.toggle('collapsed', isCollapsing);
                                button.setAttribute('aria-expanded', !isCollapsing);

                                const icon = button.querySelector('i');
                                if (icon) {
                                    icon.classList.toggle('fa-chevron-up', !isCollapsing);
                                    icon.classList.toggle('fa-chevron-down', isCollapsing);
                                }
                            }
                        }
                    });

                    document.getElementById('collapse-all-images-btn')?.addEventListener('click', () => {
                        document.querySelectorAll('#default-images-panel .default-image-category-section[data-category-name]').forEach(section => {
                            section.classList.add('jobs-collapsed');
                            const container = section.querySelector('.specific-jobs-container');
                            if (container) container.classList.add('collapsed');
                            const button = section.querySelector('.toggle-specific-jobs-btn');
                            if(button) {
                                button.setAttribute('aria-expanded', 'false');
                                const icon = button.querySelector('i');
                                if (icon) {
                                    icon.classList.remove('fa-chevron-up');
                                    icon.classList.add('fa-chevron-down');
                                }
                            }
                        });
                    });

                    document.getElementById('expand-all-images-btn')?.addEventListener('click', () => {
                        document.querySelectorAll('#default-images-panel .default-image-category-section[data-category-name]').forEach(section => {
                            section.classList.remove('jobs-collapsed');
                            const container = section.querySelector('.specific-jobs-container');
                            if (container) container.classList.remove('collapsed');
                            const button = section.querySelector('.toggle-specific-jobs-btn');
                            if(button){
                                button.setAttribute('aria-expanded', 'true');
                                const icon = button.querySelector('i');
                                if (icon) {
                                    icon.classList.remove('fa-chevron-down');
                                    icon.classList.add('fa-chevron-up');
                                }
                            }
                        });
                    });
                    
                    defaultImagesPanel.addEventListener('change', async (e) => {
                        if (e.target.classList.contains('default-image-input')) {
                            const file = e.target.files[0];
                            if (file) {
                                const wrapper = e.target.closest('.image-upload-wrapper');
                                const preview = wrapper.querySelector('.image-preview');
                                const pathInput = wrapper.querySelector('.default-image-path');
                                
                                preview.src = URL.createObjectURL(file);
                                const newPath = await handleFileUpload(file);
                                if (newPath) {
                                    pathInput.value = newPath;
                                }
                            }
                        }
                    });

                    document.getElementById('save-default-images-btn')?.addEventListener('click', async (e) => {
                        const submitBtn = e.target;
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Saving...';
                        
                        try {
                            let siteDefaultsSuccess = false;
                            let jobCatSuccess = false;

                            const siteWideDefaultsSection = defaultImagesPanel.querySelector('.default-image-category-section:not([data-category-name])');
                            const defaultPersonAvatarPath = siteWideDefaultsSection.querySelector('[data-target-type="user-avatar"]').closest('.image-upload-wrapper').querySelector('.default-image-path').value;
                            const defaultAgencyAvatarPath = siteWideDefaultsSection.querySelector('[data-target-type="agency-avatar"]').closest('.image-upload-wrapper').querySelector('.default-image-path').value;
                            const globalFallbackImagePath = siteWideDefaultsSection.querySelector('[data-target-type="global-fallback"]').closest('.image-upload-wrapper').querySelector('.default-image-path').value;


                            const settingsPayload = {
                                defaultPersonAvatar: defaultPersonAvatarPath,
                                defaultAgencyAvatar: defaultAgencyAvatarPath,
                                globalFallbackImage: globalFallbackImagePath
                            };
                            
                            try {
                                const settingsResponse = await fetch('/api/admin/settings', {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(settingsPayload),
                                    credentials: 'include'
                                });
                                if (settingsResponse.ok) {
                                    siteDefaultsSuccess = true;
                                } else {
                                    console.error('Failed to save site-wide settings:', await settingsResponse.text());
                                }
                            } catch (error) {
                                console.error('Error saving site-wide settings:', error);
                            }

                            const sections = defaultImagesPanel.querySelectorAll('.default-image-category-section[data-category-name]');
                            const updatePromises = Array.from(sections).map(section => {
                                const categoryName = section.dataset.categoryName;
                                const jobsData = Array.from(section.querySelectorAll('.specific-job-row')).map(row => ({
                                    name: row.dataset.jobName,
                                    imagePath: row.querySelector('.default-image-path').value
                                }));
                                const categoryRow = section.querySelector('.default-image-row:not(.specific-job-row)');
                                const payload = {
                                    imagePath: categoryRow.querySelector('.default-image-path').value,
                                    useCategoryDefaultImage: section.querySelector('.category-image-toggle').checked,
                                    jobs: jobsData
                                };
                                return fetch(`/api/admin/job-categories/${encodeURIComponent(categoryName)}/config`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload),
                                    credentials: 'include'
                                });
                            });
                            
                            try {
                                const results = await Promise.all(updatePromises);
                                const failed = results.filter(res => !res.ok);
                                if (failed.length > 0) {
                                    console.error(`${failed.length} job category updates failed.`);
                                }
                                jobCatSuccess = failed.length === 0;
                            } catch (err) {
                                jobCatSuccess = false;
                                console.error("Error saving job category configs:", err);
                            }

                            if (siteDefaultsSuccess || jobCatSuccess) {
                                showToast('Default image settings saved successfully!', 'success');
                                setTimeout(() => window.location.reload(), 2000); 
                            } else {
                                showToast('An error occurred. Please check the console.', 'error');
                            }
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Save All Image Changes';
                        }
                    });
                }
            
                const jobCatPanel = document.getElementById('job-categories-panel');
                if(jobCatPanel) {
                    document.getElementById('create-category-btn').addEventListener('click', () => openJobCategoryModal());

                    jobCatPanel.addEventListener('click', e => {
                        const editCatBtn = e.target.closest('.category-admin-actions .edit-btn');
                        const deleteCatBtn = e.target.closest('.category-admin-actions .delete-btn');
                        const addJobBtn = e.target.closest('.add-specific-job-btn');
                        const editJobBtn = e.target.closest('.specific-job-item .edit-job-btn');
                        const deleteJobBtn = e.target.closest('.specific-job-item .delete-job-btn');

                        if (editCatBtn) { openJobCategoryModal(editCatBtn.dataset.name); }
                        if (deleteCatBtn) { deleteData(true, `job-categories/${encodeURIComponent(deleteCatBtn.dataset.name)}`, `Are you sure you want to delete the entire "${deleteCatBtn.dataset.name}" category and all its job types?`); }
                        if (addJobBtn) { openSpecificJobModal(addJobBtn.dataset.catName); }
                        if (editJobBtn) { openSpecificJobModal(editJobBtn.dataset.catName, editJobBtn.dataset.jobName); }
                        
                        if (deleteJobBtn) {
                            const catName = deleteJobBtn.dataset.catName;
                            const jobName = deleteJobBtn.dataset.jobName;
                            const endpoint = `job-categories/${encodeURIComponent(catName)}/jobs?jobName=${encodeURIComponent(jobName)}`;
                            deleteData(true, endpoint, `Are you sure you want to delete the job type "${jobName}"?`); 
                        }
                    });

                    document.getElementById('job-category-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Saving...';
                        
                        try {
                            const originalName = document.getElementById('job-category-original-name').value;
                            const newName = document.getElementById('job-category-name').value;
                            if(originalName) {
                                await saveData('job-categories', encodeURIComponent(originalName), { newName }, true);
                            } else {
                                await createData('job-categories', { name: newName }, true);
                            }
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Save Category';
                        }
                    });

                    document.getElementById('specific-job-form').addEventListener('submit', async e => {
                        e.preventDefault();
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Saving...';

                        try {
                            const categoryName = document.getElementById('specific-job-category-name').value;
                            const originalName = document.getElementById('specific-job-original-name').value;
                            const newName = document.getElementById('specific-job-name').value;
                            
                            if(originalName) {
                                const endpoint = `/api/admin/job-categories/${encodeURIComponent(categoryName)}/jobs?jobName=${encodeURIComponent(originalName)}`;
                                    try {
                                    const response = await fetch(endpoint, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ newName }),
                                        credentials: 'include'
                                    });
                                    if (!response.ok) {
                                        const err = await response.json().catch(() => ({ message: 'An unknown error occurred.' }));
                                        throw new Error(err.message);
                                    }
                                    showToast('Job type updated successfully!', 'success');
                                    closeModal();
                                } catch (error) {
                                    showToast(`Error updating job type: ${error.message}`, 'error');
                                }
                            } else {
                                await createData('job-categories', { name: newName }, true, `job-categories/${encodeURIComponent(categoryName)}/jobs`);
                            }
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Save Job Type';
                        }
                    });
                }

                // NEW: About Content Editor Events
                const aboutContentForm = document.getElementById('about-content-form');
                if (aboutContentForm) {
                    aboutContentForm.addEventListener('click', e => {
                        const createDeletableInput = (containerId, className, placeholder) => {
                                const container = document.getElementById(containerId);
                                const newIndex = container.children.length + 1;
                                container.insertAdjacentHTML('beforeend', createDeletableItem(`${placeholder} ${newIndex}`, `<input type="text" class="${className}" value="" placeholder="${placeholder} URL">`));
                        };
                        const createDeletableTextarea = (containerId, className, placeholder) => {
                                const container = document.getElementById(containerId);
                                const newIndex = container.children.length + 1;
                                container.insertAdjacentHTML('beforeend', createDeletableItem(`${placeholder} ${newIndex}`, `<textarea class="${className}"></textarea>`));
                        };
                        
                        if (e.target.classList.contains('remove-item-btn')) {
                            e.target.closest('.deletable-item').remove();
                        } else if (e.target.id === 'add-story-paragraph') {
                                createDeletableTextarea('about-story-paragraphs-editor', 'about-story-paragraph', 'Paragraph');
                        } else if (e.target.id === 'add-story-image') {
                            document.getElementById('about-story-images-editor').insertAdjacentHTML('beforeend', `
                                <div class="deletable-item image-upload-wrapper">
                                    <img src="${GLOBAL_FALLBACK_IMAGE}" class="image-preview about-story-image-preview">
                                    <input type="text" class="about-story-image-url" value="" style="flex-grow:1;" placeholder="Image URL">
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`);
                        } else if (e.target.id === 'add-mission-item') {
                            createDeletableTextarea('about-mission-items-editor', 'about-mission-item', 'Mission Item');
                        } else if (e.target.id === 'add-value-card') {
                                document.getElementById('about-values-cards-editor').insertAdjacentHTML('beforeend', `
                                <div class="deletable-item about-value-card-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>New Card Icon</label><input type="text" class="about-value-card-icon" value="fas fa-star"></div>
                                        <div class="form-group"><label>New Card Title</label><input type="text" class="about-value-card-title" value=""></div>
                                        <div class="form-group"><label>New Card Description</label><textarea class="about-value-card-description"></textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`);
                        } else if (e.target.id === 'add-howitworks-item') {
                            document.getElementById('about-howitworks-items-editor').insertAdjacentHTML('beforeend', `
                                <div class="deletable-item about-howitworks-item-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>New Item Icon</label><input type="text" class="about-howitworks-item-icon" value="fas fa-check-circle"></div>
                                        <div class="form-group"><label>New Item Title</label><input type="text" class="about-howitworks-item-title" value=""></div>
                                        <div class="form-group"><label>New Item Description</label><textarea class="about-howitworks-item-description"></textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`);
                        } else if (e.target.id === 'add-problem-item') {
                                createDeletableTextarea('about-problem-items-editor', 'about-problem-item', 'Problem Item');
                        } else if (e.target.id === 'add-solution-item') {
                                createDeletableTextarea('about-solution-items-editor', 'about-solution-item', 'Solution Item');
                        } else if (e.target.id === 'add-audience-card') {
                            document.getElementById('about-serve-audience-editor').insertAdjacentHTML('beforeend', `
                                <div class="deletable-item about-audience-card-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>New Audience Icon</label><input type="text" class="about-audience-card-icon" value="fas fa-user-friends"></div>
                                        <div class="form-group"><label>New Audience Title</label><input type="text" class="about-audience-card-title" value=""></div>
                                        <div class="form-group"><label>New Audience List Items (one per line)</label><textarea class="about-audience-card-items"></textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`);
                        }
                    });

                    aboutContentForm.addEventListener('submit', async e => {
                        e.preventDefault();
                        const submitBtn = e.target.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Saving...';
                        
                        try {
                            const newContent = {
                                tagline: document.getElementById('about-tagline-editor').value,
                                ourStory: {
                                    title: document.getElementById('about-story-title-editor').value,
                                    paragraphs: Array.from(document.querySelectorAll('.about-story-paragraph')).map(el => el.value.replace(/\n/g, '<br>')),
                                    images: Array.from(document.querySelectorAll('.about-story-image-url')).map(el => el.value)
                                },
                                vision: {
                                    title: document.getElementById('about-vision-title-editor').value,
                                    content: document.getElementById('about-vision-content-editor').value,
                                },
                                mission: {
                                    title: document.getElementById('about-mission-title-editor').value,
                                    items: Array.from(document.querySelectorAll('.about-mission-item')).map(el => el.value)
                                },
                                values: {
                                    title: document.getElementById('about-values-title-editor').value,
                                    cards: Array.from(document.querySelectorAll('.about-value-card-editor')).map(card => ({
                                        icon: card.querySelector('.about-value-card-icon').value,
                                        title: card.querySelector('.about-value-card-title').value,
                                        description: card.querySelector('.about-value-card-description').value,
                                    }))
                                },
                                howItWorks: {
                                    title: document.getElementById('about-howitworks-title-editor').value,
                                    items: Array.from(document.querySelectorAll('.about-howitworks-item-editor')).map(item => ({
                                        icon: item.querySelector('.about-howitworks-item-icon').value,
                                        title: item.querySelector('.about-howitworks-item-title').value,
                                        description: item.querySelector('.about-howitworks-item-description').value,
                                    }))
                                },
                                problemSolution: {
                                    problem: {
                                        title: document.getElementById('about-problem-title-editor').value,
                                        items: Array.from(document.querySelectorAll('.about-problem-item')).map(el => el.value)
                                    },
                                    solution: {
                                        title: document.getElementById('about-solution-title-editor').value,
                                        items: Array.from(document.querySelectorAll('.about-solution-item')).map(el => el.value)
                                    }
                                },
                                whoWeServe: {
                                    title: document.getElementById('about-serve-title-editor').value,
                                    audiences: Array.from(document.querySelectorAll('.about-audience-card-editor')).map(aud => ({
                                        icon: aud.querySelector('.about-audience-card-icon').value,
                                        title: aud.querySelector('.about-audience-card-title').value,
                                        items: aud.querySelector('.about-audience-card-items').value.split('\n').filter(Boolean)
                                    }))
                                },
                                cta: {
                                    title: document.getElementById('about-cta-title-editor').value,
                                    paragraph: document.getElementById('about-cta-paragraph-editor').value,
                                    buttonText: document.getElementById('about-cta-button-editor').value
                                }
                            };

                            const response = await fetch('/api/admin/about-content', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newContent),
                                credentials: 'include'
                            });
                                const result = await response.json();
                            if (!response.ok) {
                                throw new Error(result.message);
                            }
                            showToast(result.message, 'success');
                            setTimeout(() => window.location.reload(), 2000);
                        } catch (error) {
                            showToast('Error saving content: ' + error.message, 'error');
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Save All About Page Content';
                        }
                    });
                }
            }
            
            function openJobModal(jobId = null) {
                const form = document.getElementById('job-form');
                form.reset();
                
                document.getElementById('job-modal-title').textContent = jobId ? 'Edit Job' : 'Post a New Job';
                document.getElementById('job-id').value = jobId || '';
                document.getElementById('job-image-preview').src = GLOBAL_FALLBACK_IMAGE;
                document.getElementById('job-image-path-hidden').value = '';
                document.getElementById('job-maxPeople').value = 1;
                document.getElementById('job-payRate').value = 'once-off';
                document.getElementById('job-assignedTo').value = '';
                    document.getElementById('job-type').value = '';


                // Enable fields that might be disabled during a direct hire
                document.getElementById('job-title').disabled = false;
                document.getElementById('job-maxPeople').disabled = false;
                document.getElementById('job-payRate').disabled = false;

                if (jobId) {
                    const job = allJobs.find(j => j.jobId === jobId);
                    if (job) {
                        document.getElementById('job-title').value = job.title;
                        document.getElementById('job-type').value = job.jobType;
                        document.getElementById('job-description').value = job.description;
                        document.getElementById('job-location').value = job.location;
                        document.getElementById('job-price').value = job.price;
                        document.getElementById('job-payRate').value = job.payRate || 'once-off';
                        document.getElementById('job-duration').value = job.duration;
                        document.getElementById('job-dueDate').value = new Date(job.dueDate).toISOString().split('T')[0];
                        document.getElementById('job-image-path-hidden').value = job.imagePath;
                        document.getElementById('job-image-preview').src = job.imagePath || GLOBAL_FALLBACK_IMAGE;
                        document.getElementById('job-maxPeople').value = job.maxPeople || 1;
                        document.getElementById('job-assignedTo').value = job.assignedTo || '';
                    }
                }

                showModal(jobModal);
            }
            
            function openNewsModal(articleId = null) {
                const form = document.getElementById('news-form');
                if (form) form.reset();

                document.getElementById('news-modal-title').textContent = articleId ? 'Edit News Article' : 'Create News Article';
                document.getElementById('news-id').value = articleId || '';
                document.getElementById('news-image-preview').src = GLOBAL_FALLBACK_IMAGE;
                document.getElementById('news-image-path-hidden').value = '';

                if (articleId && typeof allNewsArticles !== 'undefined') {
                    const article = allNewsArticles.find(a => a.articleId === articleId);
                    if (article) {
                        document.getElementById('news-title').value = article.title || '';
                        document.getElementById('news-content').value = article.content || '';
                        document.getElementById('news-image-path-hidden').value = article.imagePath || '';
                        document.getElementById('news-image-preview').src = article.imagePath || GLOBAL_FALLBACK_IMAGE;
                    }
                }

                showModal(newsModal);
            }
            
            function openJobCategoryModal(categoryName = null) {
                const form = document.getElementById('job-category-form');
                if (form) form.reset();

                document.getElementById('job-category-modal-title').textContent = categoryName ? 'Edit Job Category' : 'Create New Job Category';
                document.getElementById('job-category-original-name').value = categoryName || '';
                document.getElementById('job-category-name').value = categoryName || '';

                showModal(jobCategoryModal);
            }

            function openSpecificJobModal(categoryName, jobName = null) {
                const form = document.getElementById('specific-job-form');
                if (form) form.reset();

                document.getElementById('specific-job-modal-title').textContent = jobName ? 'Edit Job Type' : 'Add New Job Type';
                document.getElementById('specific-job-category-name').value = categoryName || '';
                document.getElementById('specific-job-original-name').value = jobName || '';
                document.getElementById('specific-job-name').value = jobName || '';

                showModal(specificJobModal);
            }
            
            function openJobModalForDirectHire(username, serviceName) {
                openJobModal();
                const workerProfile = allProfiles.find(p => p.username === username);
                if (!workerProfile) return;

                document.getElementById('job-modal-title').textContent = `Hire ${workerProfile.fullName} for ${serviceName}`;
                document.getElementById('job-assignedTo').value = username;

                document.getElementById('job-title').value = serviceName;
                document.getElementById('job-title').disabled = true;

                const agency = allAgencies.find(a => a.members && a.members.includes(username));
                const servicesSource = agency ? agency.services : workerProfile.services;
                const price = servicesSource ? servicesSource[serviceName] : 0;
                document.getElementById('job-price').value = price || '';

                document.getElementById('job-description').value = `This is a direct hire for ${workerProfile.fullName} to perform the service: ${serviceName}. Please add any specific requirements or details below.`;
                document.getElementById('job-maxPeople').value = 1;
                document.getElementById('job-maxPeople').disabled = true;
                document.getElementById('job-payRate').value = 'once-off';
                document.getElementById('job-payRate').disabled = true;
            }
            
            // --- NEW HIRE FUNCTION ---
            function openJobModalForGenericHire(username) {
                openJobModal(); // Resets and opens the modal
                const profileToHire = allProfiles.find(p => p.username === username);
                if (!profileToHire) return;

                document.getElementById('job-modal-title').textContent = `Hire ${profileToHire.fullName}`;
                document.getElementById('job-assignedTo').value = username;

                // Leave title blank for user to fill
                document.getElementById('job-title').value = ''; 
                document.getElementById('job-title').disabled = false;
                document.getElementById('job-title').placeholder = 'e.g., General Cleaning, Event Assistance...';

                // Set a generic description
                document.getElementById('job-description').value = `This is a direct hire for ${profileToHire.fullName}. Please specify the job title and details below.`;
                
                // Default max people to 1 and disable
                document.getElementById('job-maxPeople').value = 1;
                document.getElementById('job-maxPeople').disabled = true;
            }


            document.getElementById('job-form').addEventListener('submit', async e => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                
                try {
                    const jobId = document.getElementById('job-id').value;
                    const assignedTo = document.getElementById('job-assignedTo').value;
                    
                    const jobData = {
                        title: document.getElementById('job-title').value,
                        jobType: document.getElementById('job-type').value,
                        description: document.getElementById('job-description').value,
                        location: document.getElementById('job-location').value,
                        price: parseFloat(document.getElementById('job-price').value),
                        payRate: document.getElementById('job-payRate').value,
                        duration: document.getElementById('job-duration').value,
                        dueDate: document.getElementById('job-dueDate').value,
                        imagePath: document.getElementById('job-image-path-hidden').value,
                        postedBy: currentUser.username,
                        maxPeople: parseInt(document.getElementById('job-maxPeople').value, 10) || 1,
                        assignedTo: assignedTo || null
                    };
                    
                    if(!jobData.title || !jobData.jobType) {
                        showToast('Please provide a job title and select a job type before saving.', 'error');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save Job';
                        return;
                    }

                    if (jobId) {
                        const originalJob = allJobs.find(j => j.jobId === jobId);
                        if (originalJob) {
                            jobData.status = originalJob.status;
                            jobData.category = originalJob.category; // Preserve original category on edit
                        }
                        await saveData('jobs', jobId, jobData);
                    } else {
                        jobData.jobId = `job_${Date.now()}`;
                        jobData.status = assignedTo ? 'assigned' : 'open';
                        await createData('jobs', jobData);
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Job';
                }
            });

            document.getElementById('timeline-event-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    const eventId = document.getElementById('timeline-event-id').value;
                    const eventData = {
                        title: document.getElementById('timeline-event-title').value,
                        description: document.getElementById('timeline-event-description').value,
                        date: document.getElementById('timeline-event-date').value,
                        imagePath: document.getElementById('timeline-event-image-path-hidden').value
                    };

                    if (eventId) {
                        await saveData('timeline-events', eventId, eventData, true);
                    } else {
                        eventData.timelineEventId = `tl_event_${Date.now()}`;
                        await createData('timeline-events', eventData, true);
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Timeline Event';
                }
            });

            document.getElementById('news-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';

                try {
                    const articleId = document.getElementById('news-id').value;
                    const articleData = {
                        articleId: articleId || `news_${Date.now()}`,
                        title: document.getElementById('news-title').value,
                        content: document.getElementById('news-content').value,
                        imagePath: document.getElementById('news-image-path-hidden').value
                    };

                    if (articleId) {
                        await saveData('news', articleId, articleData, true);
                    } else {
                        await createData('news', articleData, true);
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save Article';
                }
            });

            // --- NEW: RATING FORM SUBMISSION ---
            document.getElementById('rating-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const selectedStar = document.querySelector('#rating-modal .stars-input i.selected');
                
                if (!selectedStar) {
                    showToast('Please select a star rating.', 'error');
                    return;
                }

                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';

                const ratingData = {
                    jobId: document.getElementById('rating-job-id').value,
                    ratedUsername: document.getElementById('rating-worker-username').value,
                    rating: parseInt(selectedStar.dataset.value, 10),
                    comment: document.getElementById('rating-comment').value
                };

                try {
                    const response = await fetch('/api/ratings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ratingData),
                        credentials: 'include'
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message);
                    }
                    showToast(result.message, 'success');
                    closeModal();
                    // No full reload needed, rely on socket.io for profile update
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Rating';
                }
            });

            // =========================================================================
            //  6. EVENT BINDING & FILTERS
            // =========================================================================
            
            async function handleRatingAction(button) {
                if (!currentUser) { showModal(loginModal); return; }

                const itemId = button.dataset.itemId;
                const ratingType = button.dataset.rating;

                let userRatings = allLikes.find(l => l.username === currentUser.username);
                if (!userRatings) {
                    userRatings = { username: currentUser.username, likedItems: [], dislikedItems: [], favoritedItems: [] };
                }
                
                userRatings.likedItems = userRatings.likedItems || [];
                userRatings.dislikedItems = userRatings.dislikedItems || [];
                userRatings.favoritedItems = userRatings.favoritedItems || [];

                const toggleItem = (array, item) => {
                    const index = array.indexOf(item);
                    if (index > -1) array.splice(index, 1);
                    else array.push(item);
                    return array;
                };

                if (ratingType === 'like') {
                    userRatings.likedItems = toggleItem(userRatings.likedItems, itemId);
                    userRatings.dislikedItems = userRatings.dislikedItems.filter(id => id !== itemId);
                } else if (ratingType === 'dislike') {
                    userRatings.dislikedItems = toggleItem(userRatings.dislikedItems, itemId);
                    userRatings.likedItems = userRatings.likedItems.filter(id => id !== itemId);
                } else if (ratingType === 'favorite') {
                    userRatings.favoritedItems = toggleItem(userRatings.favoritedItems, itemId);
                }

                try {
                    await fetch('/api/likes', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(userRatings), credentials: 'include' });
                } catch (error) {
                    showToast("Failed to save your preference. Please try again.", "error");
                    console.error(error);
                }
            }

            
            async function handleFollow(followBtn) {
                if (!currentUser) { 
                    showModal(loginModal); 
                    return; 
                }

                const username = followBtn.dataset.username;
                const isCurrentlyFollowing = allFollowers.some(f => f.user === username && f.follower === currentUser.username);
                const endpoint = isCurrentlyFollowing ? `/api/users/${username}/unfollow` : `/api/users/${username}/follow`;

                followBtn.disabled = true;

                try {
                    const response = await fetch(endpoint, { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'An unknown error occurred.');
                    }

                } catch (error) {
                    showToast(`Action failed: ${error.message}`, 'error');
                } finally {
                    followBtn.disabled = false;
                }
            }


            async function handleApplyModalAction(actionBtn) {
                if (!currentUser) {
                    showModal(loginModal);
                    return;
                }

                const actionGroup = actionBtn.closest('.action-btn-group');
                const itemId = actionGroup.dataset.itemId;
                const action = actionBtn.dataset.action;

                let userRatings = allLikes.find(l => l.username === currentUser.username);
                if (!userRatings) {
                    userRatings = { username: currentUser.username, likedItems: [], dislikedItems: [], favoritedItems: [] };
                }
                userRatings.likedItems = userRatings.likedItems || [];
                userRatings.dislikedItems = userRatings.dislikedItems || [];
                userRatings.favoritedItems = userRatings.favoritedItems || [];

                if (action === 'like') {
                    const wasActive = userRatings.likedItems.includes(itemId);
                    userRatings.likedItems = wasActive ? userRatings.likedItems.filter(id => id !== itemId) : [...userRatings.likedItems, itemId];
                    if (!wasActive) userRatings.dislikedItems = userRatings.dislikedItems.filter(id => id !== itemId);
                } else if (action === 'dislike') {
                    const wasActive = userRatings.dislikedItems.includes(itemId);
                    userRatings.dislikedItems = wasActive ? userRatings.dislikedItems.filter(id => id !== itemId) : [...userRatings.dislikedItems, itemId];
                    if (!wasActive) userRatings.likedItems = userRatings.likedItems.filter(id => id !== itemId);
                } else if (action === 'favorite') {
                    const wasActive = userRatings.favoritedItems.includes(itemId);
                    userRatings.favoritedItems = wasActive ? userRatings.favoritedItems.filter(id => id !== itemId) : [...userRatings.favoritedItems, itemId];
                }
                
                try {
                    await fetch('/api/likes', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userRatings),
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error("Failed to save preference:", error);
                    showToast("Sorry, there was an issue saving your preference.", "error");
                }
            }


            function openApplyModal(jobId) { 
                const job = allJobs.find(j => j.jobId === jobId); 
                if (!job) return;
                const employer = allProfiles.find(p => p.username === job.postedBy); 
                if (!employer) return;
                
                const state = { modal: 'job-details', id: jobId };
                const title = `Job: ${job.title}`;
                const url = `#job-details?id=${jobId}`;
                if (!(history.state && history.state.modal === 'job-details' && history.state.id === jobId)) {
                    history.pushState(state, title, url);
                }
                
                const payRateText = job.payRate === 'once-off' ? 'total' : job.payRate;
                const perPersonText = (job.maxPeople || 1) > 1 ? ' per person' : ''; 

                document.getElementById('apply-modal-job-title').textContent = job.title; 
                document.getElementById('apply-modal-employer').textContent = employer.fullName; 
                
                const mainImageEl = document.getElementById('apply-modal-main-image');
                const thumbnailStrip = document.getElementById('apply-modal-thumbnail-strip');
                thumbnailStrip.innerHTML = '';
                
                const imageList = [job.imagePath];
                if (employer.galleryImagePaths && employer.galleryImagePaths.length > 0) {
                    const uniqueGalleryImages = employer.galleryImagePaths.filter(p => p !== job.imagePath);
                    imageList.push(...uniqueGalleryImages.slice(0, 3));
                }
                
                displayImage(mainImageEl, imageList[0], GLOBAL_FALLBACK_IMAGE);
                
                if (imageList.length > 1) {
                    thumbnailStrip.style.display = 'flex';
                    imageList.forEach((path, index) => {
                        const thumb = document.createElement('img');
                        displayImage(thumb, path, GLOBAL_FALLBACK_IMAGE);
                        if (index === 0) thumb.classList.add('active');
                        thumbnailStrip.appendChild(thumb);
                    });

                    thumbnailStrip.addEventListener('click', (e) => {
                        if (e.target.tagName === 'IMG') {
                            mainImageEl.src = e.target.src;
                            thumbnailStrip.querySelectorAll('img').forEach(img => img.classList.remove('active'));
                            e.target.classList.add('active');
                        }
                    });
                } else {
                    thumbnailStrip.style.display = 'none';
                }

                document.getElementById('apply-modal-req').textContent = job.description; 
                document.getElementById('apply-modal-location').textContent = job.location; 
                document.getElementById('apply-modal-duration').textContent = job.duration; 
                document.getElementById('apply-modal-category').textContent = job.category || 'Not Specified';
                document.getElementById('apply-modal-specific-job').textContent = job.title;
                document.getElementById('apply-modal-price').textContent = `N$ ${job.price} ${payRateText}${perPersonText}`; 
                document.getElementById('apply-modal-maxPeople').textContent = `${job.maxPeople || 1} person(s)`;
                document.getElementById('apply-modal-date').textContent = new Date(job.dueDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }); 
                
                const finalApplyBtn = document.getElementById('final-apply-btn');
                finalApplyBtn.dataset.jobId = jobId;

                if (currentUser && job.applicants && job.applicants.includes(currentUser.username)) {
                    finalApplyBtn.disabled = true;
                    finalApplyBtn.textContent = 'Already Applied';
                } else {
                    finalApplyBtn.disabled = false;
                    finalApplyBtn.textContent = 'Apply for job';
                }

                const actionsGroup = document.getElementById('apply-modal-actions');
                actionsGroup.dataset.itemId = jobId; 

                actionsGroup.querySelectorAll('.action-btn').forEach(btn => btn.classList.remove('active'));
                const favoriteBtnIcon = actionsGroup.querySelector('.favorite i');
                if(favoriteBtnIcon) favoriteBtnIcon.classList.replace('fas', 'far');

                if (currentUser) {
                    const userRatings = allLikes.find(l => l.username === currentUser.username);
                    if (userRatings) {
                        if (userRatings.likedItems?.includes(jobId)) actionsGroup.querySelector('.like').classList.add('active');
                        if (userRatings.dislikedItems?.includes(jobId)) actionsGroup.querySelector('.dislike').classList.add('active');
                        if (userRatings.favoritedItems?.includes(jobId)) {
                            const favBtn = actionsGroup.querySelector('.favorite');
                            favBtn.classList.add('active');
                            if(favBtn.querySelector('i')) favBtn.querySelector('i').classList.replace('far', 'fas');
                        }
                    }
                }
                
                const footer = document.querySelector('#apply-modal .apply-modal-footer');
                const existingMsgBtn = footer.querySelector('.send-message-btn');
                if (existingMsgBtn) existingMsgBtn.remove();
                footer.querySelector('#final-apply-btn').insertAdjacentHTML('beforebegin',
                    `<button class="jkit-btn send-message-btn" data-username="${job.postedBy}"><i class="fas fa-paper-plane"></i> Message Employer</button>`
                );

                showModal(applyModal); 
            }
            
            function bindActionButtons() {
                document.body.addEventListener('click', async e => {
                    const interactionButton = e.target.closest('.interaction-item button');
                    const followBtn = e.target.closest('.follow-btn');
                    const applyBtn = e.target.closest('.apply-btn');
                    const viewAgencyBtn = e.target.closest('.view-agency-btn');
                    const viewProfileBtn = e.target.closest('.view-profile-btn');
                    const backBtn = e.target.closest('.back-btn');
                    const requestJoinBtn = e.target.closest('.request-join-btn');
                    const sendMessageBtn = e.target.closest('.send-message-btn');
                    const hireSkillBtn = e.target.closest('.hire-skill-btn');
                    const hireServiceBtn = e.target.closest('.hire-service-btn');
                    const hireAgencyServiceBtn = e.target.closest('.hire-agency-service-btn');
                    const aiChatToggle = e.target.closest('#ai-chat-toggle-guest, #ai-chat-toggle-user');
                    const locationBtn = e.target.closest('.view-location-btn');
                    const viewCvBtn = e.target.closest('.view-cv-btn');
                    const readMoreBtn = e.target.closest('.read-more-btn');
                    const navMessageBtn = e.target.closest('#nav-message-btn');
                    const enlargeableImage = e.target.closest('.enlargeable-image');
                    const peoplePageImageContainer = e.target.closest('#people-page .card-image-container.view-profile-btn');
                    const employersPageImageContainer = e.target.closest('#employers-page .card-image-container.view-profile-btn'); // Added for employers
                    const applyModalActionBtn = e.target.closest('#apply-modal-actions .action-btn');
                    const hireBtn = e.target.closest('.hire-btn');

                    if (interactionButton) { e.preventDefault(); e.stopPropagation(); handleRatingAction(interactionButton); } 
                    else if (applyModalActionBtn) { e.preventDefault(); handleApplyModalAction(applyModalActionBtn); }
                    else if (followBtn) { 
                        e.preventDefault(); 
                        handleFollow(followBtn); 
                    }
                    else if (applyBtn) { e.preventDefault(); openApplyModal(applyBtn.dataset.jobId); } 
                    else if (viewAgencyBtn) { e.preventDefault(); renderAgencyDetailPage(viewAgencyBtn.dataset.agencyId); } 
                    else if (peoplePageImageContainer) {
                        e.preventDefault();
                        openProfileDetailPage(peoplePageImageContainer.dataset.username);
                    }
                    else if (employersPageImageContainer) { // Handler for employers page
                        e.preventDefault();
                        openProfileDetailPage(employersPageImageContainer.dataset.username);
                    }
                    else if (viewProfileBtn) { e.preventDefault(); openProfileDetailPage(viewProfileBtn.dataset.username); } 
                    else if (enlargeableImage) {
                        e.preventDefault();
                        openImageViewer(enlargeableImage.src);
                    }
                    else if (locationBtn) {
                        e.preventDefault();
                        openLocationModal(locationBtn.dataset.location, locationBtn.dataset.agencyName);
                    }
                    else if (viewCvBtn) {
                        e.preventDefault();
                        openCvModal(viewCvBtn.dataset.cvPath);
                    }
                    else if (backBtn) {
                        e.preventDefault();
                        const previousPage = sessionStorage.getItem('jkit_previousListPage');
                        const fallbackPage = backBtn.dataset.fallback;
                        window.showPage(previousPage || fallbackPage, {});
                    }
                    else if (requestJoinBtn) {
                        e.preventDefault();
                        if (!currentUser) { showToast('You must be logged in to join an agency.', 'info'); showModal(loginModal); return; }
                        if (currentUser.type !== 'Worker' && currentUser.type !== 'Talent') { showToast('Only workers and talents can join agencies.', 'info'); return; }
                        const agencyId = requestJoinBtn.dataset.agencyId;
                        const newRequest = { requestId: `req_${Date.now()}`, agencyId: agencyId, username: currentUser.username, status: 'pending' };
                        await createData('agencyRequests', newRequest);
                    } else if (sendMessageBtn) {
                        e.preventDefault();
                        if (!currentUser) { showModal(loginModal); return; }
                        openChatWith(sendMessageBtn.dataset.username);
                    }
                        else if (navMessageBtn) {
                        e.preventDefault();
                        if (!currentUser) { showModal(loginModal); return; }
                    } 
                    else if (aiChatToggle) {
                        e.preventDefault();
                        if (!currentUser) { showModal(loginModal); return; }
                        openChatWith(AI_ASSISTANT_ID);
                    }
                    else if (hireSkillBtn || hireServiceBtn || hireAgencyServiceBtn) {
                        e.preventDefault();
                        if (!currentUser) {
                            showToast('Please log in to hire talent.', 'info');
                            showModal(loginModal);
                            return;
                        }
                        const btn = hireSkillBtn || hireServiceBtn || hireAgencyServiceBtn;
                        const { username, skill, service } = btn.dataset;
                        openJobModalForDirectHire(username, skill || service);
                    }
                     else if (hireBtn) {
                        e.preventDefault();
                        if (!currentUser) {
                            showToast('Please log in to hire someone.', 'info');
                            showModal(loginModal);
                            return;
                        }
                        openJobModalForGenericHire(hireBtn.dataset.username);
                    }
                    else if(readMoreBtn) {
                        e.preventDefault();
                        const article = allNewsArticles.find(a => a.articleId === readMoreBtn.dataset.articleId);
                        console.log('Read More clicked. Article:', article);
                        if(article) {
                            document.getElementById('read-more-title').textContent = article.title;
                            document.getElementById('read-more-content').textContent = article.content;
                            const imgElement = document.getElementById('read-more-image');
                            console.log('Setting image. imagePath:', article.imagePath, 'GLOBAL_FALLBACK_IMAGE:', GLOBAL_FALLBACK_IMAGE);
                            displayImage(imgElement, article.imagePath, GLOBAL_FALLBACK_IMAGE);
                            console.log('Image element after displayImage:', imgElement.src);
                            showModal(readMoreModal);
                        }
                    }
                });
                
                document.getElementById('final-apply-btn').addEventListener('click', async (e) => {
                    const jobId = e.target.dataset.jobId;
                    if (!jobId) return;

                    if (!currentUser) {
                        showToast('You must be logged in to apply for a job.', 'info');
                        showModal(loginModal);
                        return;
                    }

                    if (currentUser.type !== 'Worker' && currentUser.type !== 'Talent') {
                        showToast('Only users registered as a "Worker" or "Talent" can apply for jobs.', 'info');
                        return;
                    }
                    e.target.disabled = true;
                    e.target.textContent = 'Applying...';
                    try {
                        const response = await fetch(`/api/jobs/${jobId}/apply`, {
                            method: 'POST',
                            credentials: 'include'
                        });

                        const result = await response.json();
                        if (!response.ok) {
                            throw new Error(result.message);
                        }

                        showToast(result.message, 'success');
                        setTimeout(() => window.location.reload(), 2000);
                        closeModal();

                    } catch (error) {
                        showToast(`Application failed: ${error.message}`, 'error');
                    } finally {
                        e.target.disabled = false;
                        e.target.textContent = 'Apply for job';
                    }
                });

                document.getElementById('post-new-job-from-jobs-page-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    openJobModal();
                });
                const ticketForm = document.getElementById('ticketForm');
                if (ticketForm) {
                    ticketForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const submitBtn = document.getElementById('submitBtn');
                        const statusMessage = document.getElementById('statusMessage');

                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Submitting...';
                        statusMessage.style.display = 'none';
                        statusMessage.className = '';

                        const formData = new FormData(ticketForm);
                        const data = Object.fromEntries(formData.entries());

                        try {
                            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCLsFTJJo5O9JU6C78gmH7Kv-wg74EW4i4okErEZQO429gCHNsYsMjYeaHKBMCBlpX/exec"; 
                            
                            const response = await fetch(SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors', 
                                cache: 'no-cache',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(data)
                            });
                            
                            statusMessage.textContent = "Your ticket has been submitted successfully! Please check your email for a confirmation.";
                            statusMessage.className = 'success';
                            ticketForm.reset();

                        } catch (error) {
                            console.error('Submission Error:', error);
                            statusMessage.textContent = `An error occurred. Please try again or contact us directly.`;
                            statusMessage.className = 'error';
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Submit';
                            statusMessage.style.display = 'block';
                        }
                    });
                }
            }
            
            function setupFilters() {
                const specificJobPopup = document.getElementById('specific-job-popup');
                let popupHideTimer;
                const hidePopups = () => {
                    document.querySelectorAll('.filter-popup.popup-open').forEach(p => p.classList.remove('popup-open'));
                    document.body.classList.remove('filter-popup-open');
                };
                const cancelHideTimer = () => clearTimeout(popupHideTimer);
                const startHideTimer = () => { popupHideTimer = setTimeout(hidePopups, 300); };
                document.getElementById('specific-job-popup-close').addEventListener('click', hidePopups);

                function setupCategoryFilter({
                    triggerWrapper,
                    displayElement,
                    hiddenInput,
                    categoryProvider,
                    specificItemTitlePrefix,
                    onUpdate,
                    otherPopups = []
                }) {
                    const categoryPopup = document.createElement('div');
                    categoryPopup.className = 'filter-popup category-popup-main';
                    categoryPopup.innerHTML = `<div class="filter-popup-header"><h4>Categories</h4><button class="close-btn">&times;</button></div><ul class="filter-popup-list"></ul><div class="filter-popup-footer"><button class="scroll-bottom-btn">Scroll to Bottom <i class="fas fa-chevron-down"></i></button></div>`;
                    document.body.appendChild(categoryPopup);

                    otherPopups.push(categoryPopup);

                    let lastHoveredCategory = "";

                    const showSpecificItemPopup = (categoryName, anchorElement) => {
                        lastHoveredCategory = categoryName;
                        const categoryData = allJobCategories.find(cat => cat.name === categoryName);
                        const itemsToShow = (categoryData?.jobs) ? categoryData.jobs.map(j => j.name) : [];

                        if (itemsToShow.length > 0) {
                            document.body.classList.add('filter-popup-open');
                            specificJobPopup.querySelector('.filter-popup-header h4').textContent = `${specificItemTitlePrefix} in ${categoryName}`;
                            const list = specificJobPopup.querySelector('#specific-job-list');
                            list.innerHTML = `<button data-job-name="">All in ${categoryName}</button>`;
                            itemsToShow.sort().forEach(item => {
                                list.innerHTML += `<button data-job-name="${item}">${item}</button>`;
                            });

                            if (window.innerWidth <= 768) {
                                specificJobPopup.classList.add('popup-open');
                            } else {
                                const mainPopupRect = categoryPopup.getBoundingClientRect();
                                const anchorRect = anchorElement.getBoundingClientRect();
                                specificJobPopup.style.top = `${mainPopupRect.top}px`;
                                specificJobPopup.style.left = `${anchorRect.right + 5}px`;
                                specificJobPopup.classList.add('popup-open');
                            }
                        } else {
                            specificJobPopup.classList.remove('popup-open');
                        }
                    };

                    const showCategoryPopup = () => {
                        otherPopups.forEach(p => {
                            if (p !== categoryPopup) {
                                p.classList.remove('popup-open');
                            }
                        });
                        specificJobPopup.classList.remove('popup-open');

                        document.body.classList.add('filter-popup-open');
                        const categoryList = categoryPopup.querySelector('.filter-popup-list');
                        const categories = categoryProvider();
                        categoryList.innerHTML = `<li data-category="">All Categories</li>` + categories.map(catName => {
                            const hasSubmenu = allJobCategories.some(cat => cat.name === catName && cat.jobs?.length > 0);
                            return `<li class="${hasSubmenu ? 'has-submenu' : ''}" data-category="${catName}">${catName}</li>`;
                        }).join('');

                        if (window.innerWidth > 768) {
                            const wrapperRect = triggerWrapper.getBoundingClientRect();
                            categoryPopup.style.top = `${wrapperRect.bottom + 5}px`;
                            categoryPopup.style.left = `${wrapperRect.left}px`;
                            categoryPopup.style.width = `${wrapperRect.width}px`;
                        }
                        categoryPopup.classList.add('popup-open');
                    };

                    triggerWrapper.addEventListener('mouseenter', () => { if (window.innerWidth > 768) { cancelHideTimer(); showCategoryPopup(); } });
                    triggerWrapper.addEventListener('mouseleave', () => { if (window.innerWidth > 768) startHideTimer(); });
                    triggerWrapper.addEventListener('click', showCategoryPopup);

                    categoryPopup.querySelector('.close-btn').addEventListener('click', hidePopups);
                    [categoryPopup, specificJobPopup].forEach(p => {
                        p.addEventListener('mouseenter', () => { if (window.innerWidth > 768) cancelHideTimer(); });
                        p.addEventListener('mouseleave', () => { if (window.innerWidth > 768) startHideTimer(); });
                    });

                    categoryPopup.querySelector('.filter-popup-list').addEventListener('mouseover', e => {
                        if (window.innerWidth > 768 && e.target.tagName === 'LI') {
                            showSpecificItemPopup(e.target.dataset.category, e.target);
                        }
                    });

                    categoryPopup.querySelector('.filter-popup-list').addEventListener('click', e => {
                        if (e.target.tagName === 'LI') {
                            const categoryName = e.target.dataset.category;
                            if (window.innerWidth <= 768 && e.target.classList.contains('has-submenu')) {
                                setTimeout(() => {
                                    showSpecificItemPopup(categoryName, e.target);
                                }, 50); 
                            } else {
                                hiddenInput.value = categoryName;
                                displayElement.textContent = categoryName || 'All Categories';
                                hidePopups();
                                onUpdate({ category: categoryName, specific: '' });
                            }
                        }
                    });
                    
                    categoryPopup.querySelector('.scroll-bottom-btn').addEventListener('click', () => {
                        const list = categoryPopup.querySelector('.filter-popup-list');
                        list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
                    });
                    specificJobPopup.querySelector('.scroll-bottom-btn').addEventListener('click', () => {
                        const list = specificJobPopup.querySelector('.filter-popup-list');
                        list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
                    });


                    specificJobPopup.querySelector('#specific-job-list').addEventListener('click', e => {
                        if (e.target.tagName === 'BUTTON') {
                            const specificName = e.target.dataset.jobName;
                            hiddenInput.value = lastHoveredCategory;
                            displayElement.textContent = lastHoveredCategory || 'All Categories';
                            hidePopups();
                            onUpdate({ category: lastHoveredCategory, specific: specificName });
                        }
                    });
                }
                
                const searchJobsInput = document.getElementById('search-jobs-input');
                const jobTypeFilter = document.getElementById('job-type-filter');
                let currentJobFilters = { text: '', jobType: '', category: '', specific: '' };

                const updateAllJobFilters = () => renderJobsPage(currentJobFilters.text, currentJobFilters.jobType, currentJobFilters.category, currentJobFilters.specific);
                
                searchJobsInput.addEventListener('input', () => {
                    currentJobFilters.text = searchJobsInput.value;
                    updateAllJobFilters();
                });
                
                jobTypeFilter.addEventListener('change', () => {
                    currentJobFilters.jobType = jobTypeFilter.value;
                    updateAllJobFilters();
                });
                
                setupCategoryFilter({
                    triggerWrapper: document.getElementById('category-filter-item-wrapper'),
                    displayElement: document.getElementById('category-filter-display'),
                    hiddenInput: document.getElementById('category-jobs-filter'),
                    categoryProvider: () => [...new Set(allJobCategories.map(cat => cat.name))].sort(),
                    specificItemTitlePrefix: 'Specific Jobs',
                    onUpdate: ({ category, specific }) => {
                        currentJobFilters.category = category;
                        currentJobFilters.specific = specific;
                        updateAllJobFilters();
                    }
                });

                const homeSearchInput = document.getElementById('search-home-input');
                const homeSearchBtn = document.getElementById('home-search-btn');
                
                const executeHomeSearch = () => {
                    const query = homeSearchInput.value.trim().toLowerCase();
                    if (!query) return;

                    // Prioritize J-KIT ID search
                    if (/^\d{8}$/.test(query) || query.startsWith('jk-na-')) {
                        const searchId = query.startsWith('jk-na-') ? query : `jk-na-${query}`;
                        const user = allUsers.find(u => u.jkitId && u.jkitId.toLowerCase() === searchId.toLowerCase());
                        if (user) {
                            openProfileDetailPage(user.username);
                            return;
                        }
                    }

                    // Check for matches in other data sets
                    const jobMatch = allJobs.some(job => job.title.toLowerCase().includes(query));
                    const personMatch = allProfiles.some(profile => 
                        profile.fullName.toLowerCase().includes(query) || 
                        (profile.skills || []).some(skill => skill.toLowerCase().includes(query))
                    );
                    const agencyMatch = allAgencies.some(agency => agency.name.toLowerCase().includes(query));

                    // Navigate based on match priority
                    if (personMatch) {
                        window.showPage('people-page', {});
                        setTimeout(() => {
                            document.getElementById('search-people-input').value = query;
                            currentPeopleFilters.text = query;
                            updateAllPeopleFilters();
                        }, 50);
                    } else if (jobMatch) {
                        window.showPage('jobs-page', {});
                        setTimeout(() => {
                            document.getElementById('search-jobs-input').value = query;
                            currentJobFilters.text = query;
                            updateAllJobFilters();
                        }, 50);
                    } else if (agencyMatch) {
                        window.showPage('zone-page', {});
                        setTimeout(() => {
                            document.getElementById('search-agencies-input').value = query;
                            renderAgenciesPage(query, document.getElementById('type-agencies-filter').value);
                        }, 50);
                    } else {
                        // Default to searching people if no specific match is found
                        window.showPage('people-page', {});
                            setTimeout(() => {
                            document.getElementById('search-people-input').value = query;
                            currentPeopleFilters.text = query;
                            updateAllPeopleFilters();
                        }, 50);
                    }
                };
                homeSearchBtn.addEventListener('click', executeHomeSearch);
                homeSearchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { executeHomeSearch(); }});

                const searchPeopleInput = document.getElementById('search-people-input');
                let currentPeopleFilters = { text: '', type: 'all', workerCat: '', talentCat: '', specific: '' };
                const updateAllPeopleFilters = () => renderPeoplePage(currentPeopleFilters.text, currentPeopleFilters.type, currentPeopleFilters.workerCat, currentPeopleFilters.talentCat, currentPeopleFilters.specific);
                
                document.getElementById('people-type-filter-buttons').addEventListener('click', (e) => {
                    const button = e.target.closest('.people-cat-btn');
                    if (button) {
                        document.querySelectorAll('#people-type-filter-buttons .people-cat-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentPeopleFilters.type = button.dataset.filter;
                        updateAllPeopleFilters();
                    }
                });

                searchPeopleInput.addEventListener('input', () => { currentPeopleFilters.text = searchPeopleInput.value; updateAllPeopleFilters(); });

                const peopleCategoryPopups = [];

                const workerCategories = () => [...new Set(allJobCategories.filter(cat => !cat.types.includes('Creative talent')).map(c => c.name))].sort();
                const talentCategories = () => [...new Set(allJobCategories.filter(cat => cat.types.includes('Creative talent')).map(c => c.name))].sort();

                setupCategoryFilter({
                    triggerWrapper: document.getElementById('worker-category-filter-wrapper'),
                    displayElement: document.getElementById('worker-category-filter-display'),
                    hiddenInput: document.getElementById('worker-category-filter-input'),
                    categoryProvider: workerCategories,
                    specificItemTitlePrefix: 'Specific Skills',
                    onUpdate: ({ category, specific }) => {
                        currentPeopleFilters.workerCat = category;
                        currentPeopleFilters.talentCat = ''; 
                        currentPeopleFilters.specific = specific;
                        document.getElementById('talent-category-filter-display').textContent = 'All Talents';
                        document.getElementById('talent-category-filter-input').value = '';
                        updateAllPeopleFilters();
                    },
                    otherPopups: peopleCategoryPopups
                });

                setupCategoryFilter({
                    triggerWrapper: document.getElementById('talent-category-filter-wrapper'),
                    displayElement: document.getElementById('talent-category-filter-display'),
                    hiddenInput: document.getElementById('talent-category-filter-input'),
                    categoryProvider: talentCategories,
                    specificItemTitlePrefix: 'Specific Talents',
                    onUpdate: ({ category, specific }) => {
                        currentPeopleFilters.talentCat = category;
                        currentPeopleFilters.workerCat = '';
                        currentPeopleFilters.specific = specific;
                        document.getElementById('worker-category-filter-display').textContent = 'All Workers';
                        document.getElementById('worker-category-filter-input').value = '';
                        updateAllPeopleFilters();
                    },
                    otherPopups: peopleCategoryPopups
                });
                
                const agencySearchInput = document.getElementById('search-agencies-input');
                const agencyTypeFilter = document.getElementById('type-agencies-filter');
                const updateAgencyFilters = () => renderAgenciesPage(agencySearchInput.value, agencyTypeFilter.value);
                agencySearchInput.addEventListener('input', updateAgencyFilters);
                agencyTypeFilter.addEventListener('change', updateAgencyFilters);

                // --- NEW EMPLOYER FILTER LOGIC ---
                const searchEmployersInput = document.getElementById('search-employers-input');
                const employerTypeFilter = document.getElementById('employer-type-filter');

                const updateEmployerFilters = () => {
                    renderEmployersPage(searchEmployersInput.value, employerTypeFilter.value);
                };

                if (searchEmployersInput && employerTypeFilter) {
                    searchEmployersInput.addEventListener('input', updateEmployerFilters);
                    employerTypeFilter.addEventListener('change', updateEmployerFilters);
                }
            }
            
            function initCarousels() { const wrappers = document.querySelectorAll('.carousel-wrapper'); const scrollAmount = 320; wrappers.forEach(wrapper => { const carousel = wrapper.querySelector('.card-carousel'); const btnLeft = wrapper.querySelector('.scroll-left'); const btnRight = wrapper.querySelector('.scroll-right'); if (!carousel || !btnLeft || !btnRight) return; function updateButtonState() { const isAtStart = carousel.scrollLeft <= 0; const isAtEnd = carousel.scrollWidth - carousel.clientWidth - carousel.scrollLeft < 1; btnLeft.classList.toggle('hidden', isAtStart); btnRight.classList.toggle('hidden', isAtEnd); } btnLeft.addEventListener('click', () => { carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' }); }); btnRight.addEventListener('click', () => { carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' }); }); carousel.addEventListener('scroll', () => { window.requestAnimationFrame(updateButtonState); }); new ResizeObserver(updateButtonState).observe(carousel); updateButtonState(); }); }
            
            // =========================================================================
            //  7. UNIFIED CHAT & NOTIFICATION LOGIC (with Socket.IO)
            // =========================================================================
            
            let socket;
            let activeChatRecipient = null;
            let unreadMessages = {};
            let unreadRequestCount = 0;
            let aiChatHistory = [{ type: 'ai-message', content: "Hello! I'm the J-KIT assistant. How can I help you find jobs, talent, or information today?" }];
            
            function updateUnreadBadge(type) {
                if (type === 'message') {
                    const badge = document.getElementById('nav-message-badge');
                    if (!badge) return;
                    const totalUnread = Object.values(unreadMessages).reduce((sum, count) => sum + count, 0);
                    badge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                    badge.classList.toggle('visible', totalUnread > 0);
                } else if (type === 'request') {
                    const reqNavBtn = document.querySelector('.dashboard-nav button[data-panel="requests-panel"]');
                    if(reqNavBtn) {
                        let badge = reqNavBtn.querySelector('.dashboard-badge');
                        if (!badge) {
                            reqNavBtn.insertAdjacentHTML('beforeend', '<span class="notification-badge dashboard-badge">0</span>');
                            badge = reqNavBtn.querySelector('.dashboard-badge');
                        }
                        badge.textContent = unreadRequestCount > 9 ? '9+' : unreadRequestCount;
                        badge.classList.toggle('visible', unreadRequestCount > 0);
                    }
                }
            }

            function initializeSocketIO() {
                if (!currentUser) return;
                
                socket = io();

                socket.on('connect', () => {
                    console.log('Socket.IO connection established.');
                    socket.emit('init', currentUser.username);
                });

                socket.on('chat', (message) => {
                    const { sender, recipient } = message;
                    
                    const otherUser = sender === currentUser.username ? recipient : sender;
                    const existingConvoIndex = allConversations.findIndex(c => c.username === otherUser);
                    if (existingConvoIndex > -1) {
                        allConversations[existingConvoIndex] = { ...allConversations[existingConvoIndex], lastMessage: message.content, timestamp: message.timestamp };
                    } else {
                        allConversations.push({ username: otherUser, lastMessage: message.content, timestamp: message.timestamp });
                    }
                    populateChatContacts();
                    renderChatNotifications();

                    const chatPopup = document.getElementById('chat-popup');

                    const chatIsOpen = chatPopup && chatPopup.style.display === 'flex';
                    
                    if (sender === activeChatRecipient && chatIsOpen) {
                        appendMessage(message, false);
                    } else if (sender !== currentUser.username) {
                        unreadMessages[sender] = (unreadMessages[sender] || 0) + 1;
                        updateUnreadBadge('message');
                    }
                });

                socket.on('agency_join_request_received', (data) => {
                    allAgencyRequests.push(data.request);
                    unreadRequestCount++;
                    updateUnreadBadge('request');
                    renderDashboardPage();
                });
                
                socket.on('notification', (notification) => {
                    allNotifications.unshift(notification);
                    renderNotifications();
                    renderDashboardNotifications();
                    updateUnreadNotificationBadge();
                });

                socket.on('event_log_created', (log) => {
                    allEventLogs.unshift(log);
                    const timelineBody = document.getElementById('timeline-body');
                    if (timelineBody) {
                        const newRow = document.createElement('tr');
                        newRow.className = 'new-event';
                        let detailsText = '';
                        if (typeof log.details === 'string') {
                            detailsText = log.details;
                        } else if (log.details && log.details.message) {
                            detailsText = log.details.message;
                        } else {
                            detailsText = JSON.stringify(log.details);
                        }
                        newRow.innerHTML = `
                            <td data-label="Time" class="timeline-time">${new Date(log.createdAt).toLocaleString()}</td>
                            <td data-label="Actor"><strong>${log.actorUsername}</strong></td>
                            <td data-label="Event">${detailsText}</td>
                        `;
                        timelineBody.prepend(newRow);
                        setTimeout(() => newRow.classList.remove('new-event'), 2000);
                    }
                });
                
                socket.on('disconnect', () => console.log('Socket.IO connection closed.'));
                
                socket.on('online_users', (users) => {
                    onlineUsers.clear();
                    users.forEach(user => onlineUsers.add(user));
                    updateChatHeaderStatus();
                });

                socket.on('user_online', (username) => {
                    onlineUsers.add(username);
                    updateChatHeaderStatus();
                });

                socket.on('user_offline', (username) => {
                    onlineUsers.delete(username);
                    updateChatHeaderStatus();
                });

                // REAL-TIME DATA LISTENERS

                socket.on('content_created', ({ type, data }) => {
                    window[`all${type.charAt(0).toUpperCase() + type.slice(1)}`].push(data);
                    rerenderCurrentPage();
                });

                socket.on('content_updated', ({ type, data }) => {
                    const collection = window[`all${type.charAt(0).toUpperCase() + type.slice(1)}`];
                    let key = 'jobId'; // Default key
                    if (type === 'profiles') key = 'username';
                    else if (type === 'agencies') key = 'agencyId';
                    else if (type === 'agencyRequests') key = 'requestId';
                    else if (type === 'newsArticles') key = 'articleId';
                    else if (type === 'jobCategories') key = '_id';
                    else if (type === 'timelineEvents') key = 'timelineEventId';

                    const index = collection.findIndex(item => item[key] === data[key]);
                    if (index > -1) {
                        collection[index] = data;
                    } else {
                        collection.push(data);
                    }
                    rerenderCurrentPage();
                });

                socket.on('content_deleted', ({ type, id }) => {
                    let collection = window[`all${type.charAt(0).toUpperCase() + type.slice(1)}`];
                    let key = 'jobId';
                    if (type === 'newsArticles') key = 'articleId';
                    else if (type === 'jobCategories') key = '_id';
                    else if (type === 'timelineEvents') key = 'timelineEventId';

                    window[`all${type.charAt(0).toUpperCase() + type.slice(1)}`] = collection.filter(item => item[key] !== id);
                    rerenderCurrentPage();
                });
                
                socket.on('user_deleted', ({ username }) => {
                    allUsers = allUsers.filter(u => u.username !== username);
                    allProfiles = allProfiles.filter(p => p.username !== username);
                    rerenderCurrentPage();
                });

                socket.on('likes_updated', (updatedLikesDoc) => {
                    const index = allLikes.findIndex(l => l.username === updatedLikesDoc.username);
                    if (index > -1) {
                        allLikes[index] = updatedLikesDoc;
                    } else {
                        allLikes.push(updatedLikesDoc);
                    }
                    rerenderCurrentPage();
                });

                socket.on('follow_updated', ({ user, follower, isFollowing }) => {
                    if (isFollowing) {
                        if (!allFollowers.some(f => f.user === user && f.follower === follower)) {
                            allFollowers.push({ user, follower });
                        }
                    } else {
                        allFollowers = allFollowers.filter(f => !(f.user === user && f.follower === follower));
                    }
                    rerenderCurrentPage();
                });
                
                socket.on('settings_updated', (newSettings) => {
                    settings = newSettings;
                    DEFAULT_PERSON_AVATAR = settings.defaultPersonAvatar || FALLBACK_PERSON_IMG;
                    DEFAULT_AGENCY_AVATAR = settings.defaultAgencyAvatar || FALLBACK_AGENCY_IMG;
                    GLOBAL_FALLBACK_IMAGE = settings.globalFallbackImage || '/jkitlogo.png';
                    rerenderCurrentPage();
                });

                socket.on('about_content_updated', (newContent) => {
                    aboutContent = newContent;
                    renderAboutPage();
                    if (document.getElementById('about-content-panel')?.classList.contains('active')) {
                        renderAboutContentAdminPanel();
                    }
                });
            }

            function appendMessage(msg, isSentByCurrentUser, isAI = false, isThinking = false, isExplanation = false) {
                const chatMessagesContainer = document.getElementById('chat-messages');
                if (!chatMessagesContainer) return;
                const msgEl = document.createElement('div');
                let senderClass = 'chat-message';
                if (isAI) senderClass += ' received ai-message';
                else senderClass += isSentByCurrentUser ? ' sent' : ' received';
                if (isThinking) senderClass += ' thinking';
                if (isExplanation) senderClass += ' explanation';
                
                msgEl.className = senderClass;
                if(isExplanation) {
                    msgEl.innerHTML = `<h3><i class="fas fa-lightbulb"></i> What it is:</h3><p>${msg.content.what}</p><h3><i class="fas fa-star"></i> Why it's important:</h3><p>${msg.content.why}</p><h3><i class="fas fa-cogs"></i> How it works:</h3><p>${msg.content.how}</p><h3><i class="fas fa-tachometer-alt"></i> Benefits:</h3><p>${msg.content.performance}</p>`;
                } else {
                    msgEl.textContent = msg.content;
                }
                
                chatMessagesContainer.appendChild(msgEl);
                chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                return msgEl;
            }
            
            async function fetchChatHistory(recipient) {
                const chatMessagesContainer = document.getElementById('chat-messages');
                if (!chatMessagesContainer) return;
                chatMessagesContainer.innerHTML = '<em>Loading history...</em>';
                try {
                    const response = await fetch(`/api/chat/history/${recipient}`, { credentials: 'include' });
                    if (!response.ok) throw new Error('Failed to fetch history');
                    const history = await response.json();
                    chatMessagesContainer.innerHTML = '';
                    history.forEach(msg => appendMessage(msg, msg.sender === currentUser.username));
                } catch (error) {
                    chatMessagesContainer.innerHTML = '<em>Could not load chat history.</em>';
                    console.error(error);
                }
            }

            function openChatWith(username) {
                if (currentUser && username === currentUser.username) { showToast("You cannot chat with yourself.", 'info'); return; }
                activeChatRecipient = username;
                
                const chatPopup = document.getElementById('chat-popup');
                const chatContactsList = document.getElementById('chat-contacts-list');
                const chatMain = document.querySelector('.chat-main');
                const chatInput = document.getElementById('chat-input');
                const toggleIcon = document.querySelector('#chat-contacts-toggle i');

                chatPopup.style.display = 'flex';
                document.documentElement.classList.add('chat-open-mobile');
                document.body.classList.add('chat-open-mobile');

                // Push a history state on mobile so the back button can close the chat
                try {
                    if (window.innerWidth <= 768 && !(history.state && history.state.modal === 'chat')) {
                        history.pushState({ modal: 'chat' }, '', location.href);
                    }
                } catch (e) {
                    console.warn('History pushState failed:', e);
                }
                
                chatContactsList.style.display = 'flex';
                chatPopup.classList.remove('contacts-open');
                if (toggleIcon) {
                    toggleIcon.classList.add('fa-chevron-right');
                    toggleIcon.classList.remove('fa-chevron-left');
                }
                
                if (!username && window.innerWidth <= 768) {
                    chatPopup.classList.add('contacts-open');
                    if (toggleIcon) {
                        toggleIcon.classList.remove('fa-chevron-right');
                        toggleIcon.classList.add('fa-chevron-left');
                    }
                }
                
                if (!username) {
                    document.getElementById('no-active-chat-placeholder').style.display = 'flex';
                    document.getElementById('chat-conversation-area').style.display = 'none';
                    return;
                }
                
                if (username === AI_ASSISTANT_ID) {
                    chatInput.placeholder = "Ask me anything about J-KIT...";
                    setupAIChatUI();
                } else {
                    if (unreadMessages[username]) {
                        delete unreadMessages[username];
                        updateUnreadBadge('message');
                    }
                    chatInput.placeholder = "Type a message...";
                    setupUserChatUI(username);
                    fetchChatHistory(username);
                }
                
                document.querySelector('#chat-conversation-area').style.display = 'flex';
                document.querySelector('#no-active-chat-placeholder').style.display = 'none';
            }

            function closeChat() {
                const chatPopup = document.getElementById('chat-popup');
                if (!chatPopup) return;
                chatPopup.style.display = 'none';
                document.documentElement.classList.remove('chat-open-mobile');
                document.body.classList.remove('chat-open-mobile');
                const chatContactsList = document.getElementById('chat-contacts-list');
                if (chatContactsList) chatContactsList.style.display = '';
                activeChatRecipient = null;
            }
            
            function handleSendMessage(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const content = input.value.trim();
                if (!content) return;
                
                if (activeChatRecipient === AI_ASSISTANT_ID) {
                    handleAISend(content);
                } else if (activeChatRecipient && socket && socket.connected) {
                    const message = { sender: currentUser.username, recipient: activeChatRecipient, content };
                    socket.emit('chat', message);
                    appendMessage(message, true);
                }
                
                input.value = '';
                input.focus();
            }
            
            function timeSince(date) {
                const seconds = Math.floor((new Date() - new Date(date)) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "y";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "m";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "d";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "h";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + "min";
                return "now";
            }

            function populateChatContacts() {
                if (!currentUser) return;
                const listEl = document.getElementById('chat-contacts-list').querySelector('.chat-contacts-body');
                listEl.innerHTML = '';
                
                const contactsMap = new Map();

                (allConversations || []).forEach(convo => {
                    if (!contactsMap.has(convo.username)) {
                        contactsMap.set(convo.username, {
                            username: convo.username,
                            lastMessage: convo.lastMessage,
                            timestamp: new Date(convo.timestamp)
                        });
                    }
                });

                allFollowers.forEach(follow => {
                    if (follow.follower === currentUser.username && !contactsMap.has(follow.user)) {
                        const user = allUsers.find(u => u.username === follow.user);
                        if (user && (user.type === 'Worker' || user.type === 'Agent' || user.type === 'Talent')) {
                            contactsMap.set(follow.user, {
                                username: follow.user,
                                lastMessage: "You are following this user.",
                                timestamp: new Date(follow.createdAt)
                            });
                        }
                    }
                });

                const myLikesDoc = allLikes.find(l => l.username === currentUser.username);
                const myLikedUsers = new Set(myLikesDoc ? myLikesDoc.likedItems : []);
                allLikes.forEach(otherUserLikesDoc => {
                    if (otherUserLikesDoc.username === currentUser.username) return;
                    if (!contactsMap.has(otherUserLikesDoc.username)) {
                        const otherUserLikedItems = new Set(otherUserLikesDoc.likedItems);
                        if (otherUserLikedItems.has(currentUser.username) && myLikedUsers.has(otherUserLikesDoc.username)) {
                            contactsMap.set(otherUserLikesDoc.username, {
                                username: otherUserLikesDoc.username,
                                lastMessage: "You have a mutual like.",
                                timestamp: new Date(0) // low priority
                            });
                        }
                    }
                });

                const contactsData = Array.from(contactsMap.values());

                if (contactsData.length > 0) {
                    contactsData.sort((a, b) => b.timestamp - a.timestamp);

                    contactsData.forEach(c => {
                        const profile = allProfiles.find(p => p.username === c.username);
                        if(profile) {
                            const lastMsgSnippet = c.lastMessage.length > 25 ? c.lastMessage.substring(0, 25) + '...' : c.lastMessage;
                            listEl.innerHTML += `
                                <div class="chat-contact-item" data-username="${c.username}">
                                    <img src="${profile.avatarPath || DEFAULT_PERSON_AVATAR}" alt="${profile.fullName}">
                                    <div class="chat-contact-item-info">
                                        <div class="name-time">
                                            <span class="name">${profile.fullName}</span>
                                            <span class="time">${timeSince(c.timestamp)}</span>
                                        </div>
                                        <div class="message">${lastMsgSnippet}</div>
                                    </div>
                                </div>`;
                        }
                    });
                } else {
                    listEl.innerHTML = '<p style="padding: 1rem; font-size: 0.8rem; color: var(--jkit-text-muted);">Send a direct message to any person or agency on the people or agency page, follow workers or agents, or get a mutual like to start chatting!</p>';
                }
            }

            function updateChatHeaderStatus() {
                const statusEl = document.getElementById('chat-header-status');
                if (statusEl && activeChatRecipient && activeChatRecipient !== AI_ASSISTANT_ID) {
                    statusEl.textContent = onlineUsers.has(activeChatRecipient) ? 'Online' : 'Offline';
                    statusEl.style.color = onlineUsers.has(activeChatRecipient) ? '#28a745' : 'var(--jkit-text-muted)';
                }
            }
            
            function setupUserChatUI(username) {
                const chatHeaderInfo = document.getElementById('chat-header-info');
                const chatHeaderPic = document.getElementById('chat-header-pic');
                
                const recipientProfile = allProfiles.find(p => p.username === username);
                if (recipientProfile) {
                    displayImage(chatHeaderPic, recipientProfile.avatarPath, DEFAULT_PERSON_AVATAR);
                    chatHeaderInfo.querySelector('#chat-header-title').textContent = recipientProfile.fullName;
                }
                updateChatHeaderStatus();
            }
            
            function setupChatUI() {
                document.getElementById('ai-chat-toggle-guest').addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!currentUser) { showModal(loginModal); return; }
                    openChatWith(AI_ASSISTANT_ID);
                });
                document.getElementById('ai-chat-toggle-user')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!currentUser) { showModal(loginModal); return; }
                    openChatWith(AI_ASSISTANT_ID);
                });

                if (!currentUser) return;
                
                const chatPopup = document.getElementById('chat-popup');
                const chatContactsToggle = document.getElementById('chat-contacts-toggle');
                
                chatContactsToggle.addEventListener('click', () => {
                    chatPopup.classList.toggle('contacts-open');
                    const isOpen = chatPopup.classList.contains('contacts-open');
                    const toggleIcon = chatContactsToggle.querySelector('i');
                    toggleIcon.classList.toggle('fa-chevron-right', !isOpen);
                    toggleIcon.classList.toggle('fa-chevron-left', isOpen);
                });

                document.getElementById('chat-close-btn').addEventListener('click', () => {
                    // If this chat was opened via a pushed history state, go back to close it
                    if (history.state && history.state.modal === 'chat') {
                        history.back();
                    } else {
                        closeChat();
                    }
                });
                
                document.getElementById('chat-contacts-ai-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    const currentActive = document.querySelector('.chat-contact-item.active');
                    if (currentActive) currentActive.classList.remove('active');
                    openChatWith(AI_ASSISTANT_ID);
                    chatPopup.classList.remove('contacts-open');
                    const toggleIcon = chatContactsToggle.querySelector('i');
                    toggleIcon.classList.add('fa-chevron-right');
                    toggleIcon.classList.remove('fa-chevron-left');
                });

                document.getElementById('chat-contacts-list').addEventListener('click', e => {
                    const contactItem = e.target.closest('.chat-contact-item');
                    if (contactItem) {
                        const currentActive = document.querySelector('.chat-contact-item.active');
                        if (currentActive) currentActive.classList.remove('active');
                        contactItem.classList.add('active');
                        openChatWith(contactItem.dataset.username);
                        chatPopup.classList.remove('contacts-open');
                        const toggleIcon = chatContactsToggle.querySelector('i');
                        toggleIcon.classList.add('fa-chevron-right');
                        toggleIcon.classList.remove('fa-chevron-left');
                    }
                });
                document.getElementById('chat-form').addEventListener('submit', handleSendMessage);
            }

            function switchDashboardTab(panelId) {
                if (!currentUser) return;
                const dashboardNav = document.querySelector('.dashboard-nav');
                if (!dashboardNav) return;
                
                const button = dashboardNav.querySelector(`button[data-panel="${panelId}"]`);
                if (button) {
                    dashboardNav.querySelector('.active')?.classList.remove('active');
                    button.classList.add('active');
                    document.querySelectorAll('.dashboard-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(panelId)?.classList.add('active');
                    localStorage.setItem(`jkit_lastDashboardTab_${currentUser.username}`, panelId);
                }
            }
            
            function renderDashboardNotifications() {
                const list = document.getElementById('dashboard-notification-list');
                if (!list) return;
                if (allNotifications.length === 0) {
                    list.innerHTML = '<li><p>You have no notifications yet.</p></li>';
                } else {
                    list.innerHTML = allNotifications.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).map(n => `
                        <li id="dashboard-notification-${n._id}">
                            <span class="job-list-title" style="font-weight: ${n.isRead ? '400' : '600'};">${n.message}</span>
                            <span style="margin-left:auto; font-size: 0.8rem; color: var(--jkit-text-muted);">${timeSince(n.createdAt)}</span>
                        </li>
                    `).join('');
                }
            }

            // =========================================================================
            //  NEW/REFACTORED NOTIFICATION & GLOBAL EVENT LISTENERS
            // =========================================================================

            function renderNotifications() {
                const list = document.getElementById('notification-list');
                if (!list) return;

                if (allNotifications.length === 0) {
                    list.innerHTML = '<li class="no-notifications">You have no new notifications.</li>';
                } else {
                    list.innerHTML = allNotifications.map(n =>
                        `<li class="${n.isRead ? '' : 'unread'}" data-id="${n._id}" data-link="${n.link}">
                            ${n.message}
                        </li>`
                    ).join('');
                }
                updateUnreadNotificationBadge();
            }
            
            function renderChatNotifications() {
                const list = document.getElementById('chat-notification-list');
                if (!list) return;

                const sortedConversations = [...allConversations].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (sortedConversations.length === 0) {
                    list.innerHTML = '<li class="no-notifications" style="padding: 1rem;">No recent messages.</li>';
                    return;
                }

                list.innerHTML = sortedConversations.slice(0, 10).map(convo => {
                    const profile = allProfiles.find(p => p.username === convo.username);
                    if (!profile) return '';

                    const snippet = convo.lastMessage.length > 35 ? convo.lastMessage.substring(0, 35) + '...' : convo.lastMessage;
                    const isUnread = unreadMessages[convo.username] > 0;

                    return `
                        <li class="chat-notification-item" data-username="${convo.username}">
                            <img src="${profile.avatarPath || DEFAULT_PERSON_AVATAR}" alt="${profile.fullName}">
                            <div class="chat-notification-info">
                                <div class="chat-notification-header">
                                    <strong style="font-weight: ${isUnread ? '700' : '600'};">${profile.fullName}</strong>
                                    <span>${timeSince(convo.timestamp)}</span>
                                </div>
                                <p style="font-weight: ${isUnread ? '600' : '400'}; color: ${isUnread ? 'var(--jkit-text-dark)' : 'var(--jkit-text-muted)'};">
                                    ${snippet}
                                </p>
                            </div>
                        </li>
                    `;
                }).join('');
            }

            function updateUnreadNotificationBadge() {
                const badge = document.getElementById('nav-notification-badge');
                if (!badge) return;
                const unreadCount = allNotifications.filter(n => !n.isRead).length;
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.toggle('visible', unreadCount > 0);
            }

            async function markNotificationsAsRead() {
                const unreadIds = allNotifications.filter(n => !n.isRead).map(n => n._id);
                if (unreadIds.length === 0) return;

                allNotifications.forEach(n => { n.isRead = true; });
                renderNotifications();

                try {
                    await fetch('/api/notifications/mark-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notificationIds: unreadIds }),
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error('Failed to mark notifications as read on server:', error);
                }
            }
            
            function setupNotificationUI() {
                if (!currentUser) return;
                const btn = document.getElementById('nav-notification-btn');
                const dropdown = document.getElementById('notification-dropdown');

                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (allNotifications.length === 0) {
                        dropdown.classList.remove('visible');
                        showPage('dashboard-page', {});
                        switchDashboardTab('notifications-panel');
                        return;
                    }

                    const isCurrentlyVisible = dropdown.classList.contains('visible');
                    document.getElementById('chat-notification-dropdown').classList.remove('visible');
                    dropdown.classList.toggle('visible', !isCurrentlyVisible);

                    if (!isCurrentlyVisible) {
                        document.documentElement.classList.add('notification-open');
                        document.body.classList.add('notification-open');
                        markNotificationsAsRead();
                    } else {
                        document.documentElement.classList.remove('notification-open');
                        document.body.classList.remove('notification-open');
                    }
                });
                
                dropdown.addEventListener('click', (e) => {
                    const notificationItem = e.target.closest('li[data-id]');
                    const noNotificationsEl = e.target.closest('.no-notifications');

                    dropdown.classList.remove('visible');
                    document.documentElement.classList.remove('notification-open');
                    document.body.classList.remove('notification-open');

                    if (notificationItem) {
                        e.stopPropagation();
                        const notificationId = notificationItem.dataset.id;
                        
                        showPage('dashboard-page', {});
                        switchDashboardTab('notifications-panel');

                        setTimeout(() => {
                            const targetNotification = document.getElementById(`dashboard-notification-${notificationId}`);
                            if (targetNotification) {
                                targetNotification.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                
                                targetNotification.classList.add('highlight');
                                setTimeout(() => {
                                    targetNotification.classList.remove('highlight');
                                }, 2500);
                            }
                        }, 100);

                    } else if (noNotificationsEl) {
                        e.stopPropagation();
                        showPage('dashboard-page', {});
                        switchDashboardTab('notifications-panel');
                    }
                });

                renderNotifications();
            }

            function setupChatNotificationUI() {
                if (!currentUser) return;
                const btn = document.getElementById('nav-message-btn');
                const dropdown = document.getElementById('chat-notification-dropdown');

                btn.addEventListener('click', e => {
                    e.stopPropagation();
                    if (allConversations.length === 0) {
                        openChatWith();
                        return;
                    }

                    const isCurrentlyVisible = dropdown.classList.contains('visible');
                    document.getElementById('notification-dropdown').classList.remove('visible');
                    dropdown.classList.toggle('visible', !isCurrentlyVisible);

                    if (!isCurrentlyVisible) {
                        document.documentElement.classList.add('notification-open');
                        document.body.classList.add('notification-open');
                        unreadMessages = {};
                        updateUnreadBadge('message');
                        renderChatNotifications();
                    } else {
                        document.documentElement.classList.remove('notification-open');
                        document.body.classList.remove('notification-open');
                    }
                });

                dropdown.addEventListener('click', e => {
                    const item = e.target.closest('.chat-notification-item, .no-notifications');
                    if (item) {
                        e.stopPropagation();
                        dropdown.classList.remove('visible');
                        document.documentElement.classList.remove('notification-open');
                        document.body.classList.remove('notification-open');
                        openChatWith(item.dataset.username || null);
                    }
                });
            }
            
            // =========================================================================
            //  8. AI CHATBOT LOGIC (Integrated into main chat UI)
            // =========================================================================
            
            async function sendQueryToGraphQL(text) {
                const query = `
                    query ProcessQuery($text: String!) {
                        processUserQuery(text: $text) {
                            action
                            message
                            targetPage
                            targetSectionId
                            postNavigationMessage
                            details { what why how performance }
                        }
                    }
                `;
                try {
                    const response = await fetch('/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query, variables: { text } })
                    });
                    const result = await response.json();
                    if(result.errors) throw new Error(result.errors[0].message);
                    return result.data.processUserQuery;
                } catch (error) {
                    console.error("GraphQL request failed:", error);
                    return { action: 'MESSAGE', message: 'I seem to be having connection issues. Please try again.' };
                }
            }

            function handleAIResponse(response) {
                aiChatHistory.push({ type: 'ai-response', data: response });
                
                switch (response.action) {
                    case 'EXPLAIN':
                        if (response.targetPage && typeof window.showPage === 'function') {
                            window.showPage(response.targetPage, { sectionId: response.targetSectionId });
                            appendMessage({ content: response.postNavigationMessage }, false, true);
                        }
                        appendMessage({ content: response.details }, false, true, false, true); // Explanation message
                        break;
                    
                    case 'NAVIGATE':
                        if (typeof window.showPage === 'function') {
                            if (response.targetPage === 'dashboard-page' && !currentUser) {
                                appendMessage({ content: "You need to be logged in to see the dashboard. I can't navigate you there automatically." }, false, true);
                                showModal(loginModal);
                            } else {
                                window.showPage(response.targetPage, { sectionId: response.targetSectionId });
                                appendMessage({ content: response.postNavigationMessage }, false, true);
                            }
                        }
                        break;

                    case 'MESSAGE':
                        appendMessage({ content: response.message }, false, true);
                        break;
                    
                    default:
                        appendMessage({ content: "I'm not sure how to handle that, but I'm learning!" }, false, true);
                }
            }
            
            async function handleAISend(userInput) {
                appendMessage({ content: userInput }, true, false); // User's own message
                aiChatHistory.push({ type: 'user-message', content: userInput });
                const thinkingIndicator = appendMessage({ content: '...' }, false, true, true);
                const response = await sendQueryToGraphQL(userInput);
                thinkingIndicator.remove();
                handleAIResponse(response);
            }
            
            function setupAIChatUI() {
                const chatHeaderInfo = document.getElementById('chat-header-info');
                const chatHeaderPic = document.getElementById('chat-header-pic');
                const chatMessagesContainer = document.getElementById('chat-messages');

                chatHeaderPic.src = 'https://i.ibb.co/tZ0b6c6/admin-avatar.png';
                chatHeaderInfo.querySelector('#chat-header-title').textContent = "J-KIT AI Assistant";
                chatHeaderInfo.querySelector('#chat-header-status').textContent = "Ready to help";
                
                chatMessagesContainer.innerHTML = '';
                aiChatHistory.forEach(msg => {
                    if (msg.type === 'user-message') {
                        appendMessage({ content: msg.content }, true, false);
                    } else if (msg.type === 'ai-response') {
                        const response = msg.data;
                        switch (response.action) {
                            case 'EXPLAIN':
                                if(response.postNavigationMessage) appendMessage({ content: response.postNavigationMessage }, false, true);
                                appendMessage({ content: response.details }, false, true, false, true);
                                break;
                            case 'NAVIGATE':
                            case 'MESSAGE':
                                appendMessage({ content: response.postNavigationMessage || response.message }, false, true);
                                break;
                            default:
                                appendMessage({ content: "An error occurred." }, false, true);
                        }
                    } else { // Initial welcome message
                        appendMessage({ content: msg.content }, false, true);
                    }
                });
            }

            // =========================================================================
            //  9. APP INITIALIZATION & REAL-TIME RE-RENDERING
            // =========================================================================
            
            function renderAboutContentAdminPanel() {
                const panel = document.getElementById('about-content-panel');
                if (!panel) return;

                const createDeletableItem = (label, content) => `
                    <div class="deletable-item">
                        <div class="form-group" style="flex-grow:1;">
                            <label>${label}</label>
                            ${content}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                    </div>`;

                panel.innerHTML = `
                    <h3>Manage 'About Us' Page Content</h3>
                    <form id="about-content-form">
                        <h4>Top Section</h4>
                        <div class="form-group"><label for="about-tagline-editor">Tagline</label><input type="text" id="about-tagline-editor" value="${aboutContent.tagline || ''}"></div>
                        
                        <h4>Our Story Section</h4>
                        <div class="form-group"><label for="about-story-title-editor">Title</label><input type="text" id="about-story-title-editor" value="${aboutContent.ourStory.title || ''}"></div>
                        <div id="about-story-paragraphs-editor">
                            ${(aboutContent.ourStory.paragraphs || []).map((p, i) => createDeletableItem(`Paragraph ${i + 1}`, `<textarea class="about-story-paragraph">${p.replace(/<br\s*\/?>/ig, '\n').replace(/<\/?strong>/g, '')}</textarea>`)).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-story-paragraph">+ Add Paragraph</button>
                            <div id="about-story-images-editor" style="margin-top: 1rem;">
                            ${(aboutContent.ourStory.images || []).map((img, i) => createDeletableItem(`Image URL ${i + 1}`, `<input type="text" class="about-story-image-url" value="${img}" placeholder="https://example.com/image.jpg">`)).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-story-image">+ Add Image</button>

                        <h4>Vision & Mission</h4>
                        <div class="form-group"><label for="about-vision-title-editor">Vision Title</label><input type="text" id="about-vision-title-editor" value="${aboutContent.vision.title || ''}"></div>
                        <div class="form-group"><label for="about-vision-content-editor">Vision Content</label><textarea id="about-vision-content-editor">${aboutContent.vision.content || ''}</textarea></div>
                        <div class="form-group"><label for="about-mission-title-editor">Mission Title</label><input type="text" id="about-mission-title-editor" value="${aboutContent.mission.title || ''}"></div>
                        <div id="about-mission-items-editor">
                                ${(aboutContent.mission.items || []).map((item, i) => createDeletableItem(`Mission Item ${i + 1}`, `<textarea class="about-mission-item">${item}</textarea>`)).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-mission-item">+ Add Mission Item</button>

                        <h4>Our Values</h4>
                        <div class="form-group"><label for="about-values-title-editor">Values Section Title</label><input type="text" id="about-values-title-editor" value="${aboutContent.values.title || ''}"></div>
                        <div id="about-values-cards-editor">
                            ${(aboutContent.values.cards || []).map((card, i) => `
                                <div class="deletable-item about-value-card-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>Card ${i+1} Icon (FontAwesome class)</label><input type="text" class="about-value-card-icon" value="${card.icon}"></div>
                                        <div class="form-group"><label>Card ${i+1} Title</label><input type="text" class="about-value-card-title" value="${card.title}"></div>
                                        <div class="form-group"><label>Card ${i+1} Description</label><textarea class="about-value-card-description">${card.description}</textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-value-card">+ Add Value Card</button>

                        <h4>How It Works</h4>
                            <div class="form-group"><label for="about-howitworks-title-editor">Section Title</label><input type="text" id="about-howitworks-title-editor" value="${aboutContent.howItWorks.title || ''}"></div>
                        <div id="about-howitworks-items-editor">
                            ${(aboutContent.howItWorks.items || []).map((item, i) => `
                                <div class="deletable-item about-howitworks-item-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>Item ${i+1} Icon (FontAwesome class)</label><input type="text" class="about-howitworks-item-icon" value="${item.icon}"></div>
                                        <div class="form-group"><label>Item ${i+1} Title</label><input type="text" class="about-howitworks-item-title" value="${item.title}"></div>
                                        <div class="form-group"><label>Item ${i+1} Description</label><textarea class="about-howitworks-item-description">${item.description}</textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-howitworks-item">+ Add "How it Works" Item</button>
                        
                        <h4>Problem & Solution</h4>
                        <div class="form-group"><label for="about-problem-title-editor">Problem Title</label><input type="text" id="about-problem-title-editor" value="${aboutContent.problemSolution.problem.title || ''}"></div>
                        <div id="about-problem-items-editor">
                            ${(aboutContent.problemSolution.problem.items || []).map((item, i) => createDeletableItem(`Problem Item ${i + 1}`, `<textarea class="about-problem-item">${item.replace(/<\/?strong>/g, '')}</textarea>`)).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-problem-item">+ Add Problem Item</button>

                        <div class="form-group" style="margin-top:1.5rem;"><label for="about-solution-title-editor">Solution Title</label><input type="text" id="about-solution-title-editor" value="${aboutContent.problemSolution.solution.title || ''}"></div>
                        <div id="about-solution-items-editor">
                            ${(aboutContent.problemSolution.solution.items || []).map((item, i) => createDeletableItem(`Solution Item ${i + 1}`, `<textarea class="about-solution-item">${item.replace(/<\/?strong>/g, '')}</textarea>`)).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-solution-item">+ Add Solution Item</button>

                        <h4>Who We Serve</h4>
                        <div class="form-group"><label for="about-serve-title-editor">Section Title</label><input type="text" id="about-serve-title-editor" value="${aboutContent.whoWeServe.title || ''}"></div>
                        <div id="about-serve-audience-editor">
                            ${(aboutContent.whoWeServe.audiences || []).map((aud, i) => `
                                <div class="deletable-item about-audience-card-editor">
                                    <div style="flex-grow:1;">
                                        <div class="form-group"><label>Audience ${i+1} Icon (FontAwesome class)</label><input type="text" class="about-audience-card-icon" value="${aud.icon}"></div>
                                        <div class="form-group"><label>Audience ${i+1} Title</label><input type="text" class="about-audience-card-title" value="${aud.title}"></div>
                                        <div class="form-group"><label>Audience ${i+1} List Items (one per line)</label><textarea class="about-audience-card-items">${aud.items.join('\n')}</textarea></div>
                                    </div>
                                    <button type="button" class="jkit-btn jkit-btn-danger remove-item-btn">Remove</button>
                                </div>`).join('')}
                        </div>
                        <button type="button" class="jkit-btn jkit-btn-outline" id="add-audience-card">+ Add Audience</button>
                        
                        <h4>Call to Action (CTA)</h4>
                        <div class="form-group"><label for="about-cta-title-editor">CTA Title</label><input type="text" id="about-cta-title-editor" value="${aboutContent.cta.title || ''}"></div>
                        <div class="form-group"><label for="about-cta-paragraph-editor">CTA Paragraph</label><textarea id="about-cta-paragraph-editor">${aboutContent.cta.paragraph || ''}</textarea></div>
                        <div class="form-group"><label for="about-cta-button-editor">CTA Button Text</label><input type="text" id="about-cta-button-editor" value="${aboutContent.cta.buttonText || ''}"></div>

                        <button type="submit" class="jkit-btn" style="width: 100%; margin-top: 2rem;">Save All About Page Content</button>
                    </form>
                `;
            }

            function renderAboutPage() {
                // This function updates the live about page from the aboutContent object
                if (document.getElementById('about-page').classList.contains('active-page')) {
                    document.getElementById('about-page-tagline').textContent = aboutContent.tagline;
                    document.getElementById('about-our-story-title').textContent = aboutContent.ourStory.title;
                    const storyParaContainer = document.getElementById('about-our-story-paragraphs');
                    storyParaContainer.innerHTML = aboutContent.ourStory.paragraphs.map(p => `<p>${p}</p>`).join('');
                    const storyImageContainer = document.getElementById('about-our-story-images');
                    storyImageContainer.innerHTML = aboutContent.ourStory.images.map(img => `<div class="about-grid-image" style="background-image: url('${img}');"></div>`).join('');
                    
                    document.getElementById('about-vision-title').textContent = aboutContent.vision.title;
                    document.getElementById('about-vision-content').textContent = aboutContent.vision.content;
                    
                    document.getElementById('about-mission-title').textContent = aboutContent.mission.title;
                    const missionItemsContainer = document.getElementById('about-mission-items');
                    missionItemsContainer.innerHTML = aboutContent.mission.items.map(item => `<li>${item}</li>`).join('');
                    
                    document.getElementById('about-values-title').textContent = aboutContent.values.title;
                    const valuesCardsContainer = document.getElementById('about-values-cards');
                    valuesCardsContainer.innerHTML = aboutContent.values.cards.map(card => `<div class="value-card"><i class="${card.icon}"></i><h4>${card.title}</h4><p>${card.description}</p></div>`).join('');

                    document.getElementById('about-how-it-works-title').textContent = aboutContent.howItWorks.title;
                    const howItWorksContainer = document.getElementById('about-how-it-works-items');
                    howItWorksContainer.innerHTML = aboutContent.howItWorks.items.map(item => `<div class="feature-item"><i class="${item.icon}"></i><h3>${item.title}</h3><p>${item.description}</p></div>`).join('');

                    document.getElementById('about-problem-title').textContent = aboutContent.problemSolution.problem.title;
                    const problemItemsContainer = document.getElementById('about-problem-items');
                    problemItemsContainer.innerHTML = aboutContent.problemSolution.problem.items.map(item => `<li>${item}</li>`).join('');

                    document.getElementById('about-solution-title').textContent = aboutContent.problemSolution.solution.title;
                    const solutionItemsContainer = document.getElementById('about-solution-items');
                    solutionItemsContainer.innerHTML = aboutContent.problemSolution.solution.items.map(item => `<li>${item}</li>`).join('');

                    document.getElementById('about-who-we-serve-title').textContent = aboutContent.whoWeServe.title;
                    const audiencesContainer = document.getElementById('about-who-we-serve-audiences');
                    audiencesContainer.innerHTML = aboutContent.whoWeServe.audiences.map(aud => `
                        <div class="audience-card">
                            <i class="${aud.icon}"></i>
                            <h4>${aud.title}</h4>
                            <ul>
                                ${aud.items.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>`).join('');

                    document.getElementById('about-cta-title').textContent = aboutContent.cta.title;
                    document.getElementById('about-cta-paragraph').textContent = aboutContent.cta.paragraph;
                    document.getElementById('about-cta-button').textContent = aboutContent.cta.buttonText;
                }
            }
            
            function setupGlobalEventListeners() {
                const notifBtn = document.getElementById('nav-notification-btn');
                const notifDropdown = document.getElementById('notification-dropdown');
                const chatNotifBtn = document.getElementById('nav-message-btn');
                const chatNotifDropdown = document.getElementById('chat-notification-dropdown');

                document.addEventListener('click', (e) => {
                    const isClickOutside = !notifDropdown.contains(e.target) && !notifBtn.contains(e.target) &&
                                            !chatNotifDropdown.contains(e.target) && !chatNotifBtn.contains(e.target);

                    if (isClickOutside) {
                        if (notifDropdown.classList.contains('visible') || chatNotifDropdown.classList.contains('visible')) {
                            notifDropdown.classList.remove('visible');
                            chatNotifDropdown.classList.remove('visible');
                            document.documentElement.classList.remove('notification-open');
                            document.body.classList.remove('notification-open');
                        }
                    }
                });
            }

            function setupPasswordToggles() {
                document.querySelectorAll('[data-toggle-password]').forEach(icon => {
                    icon.addEventListener('click', () => {
                        const passwordInput = icon.previousElementSibling;
                        if (passwordInput.type === 'password') {
                            passwordInput.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            passwordInput.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    });
                });
            }

            function openCvModal(cvPath) {
                const modal = document.getElementById('cv-modal');
                const iframe = modal.querySelector('iframe');
                iframe.src = cvPath;
                showModal(modal);
            }

            function openTimelineEventModal(eventId = null) {
                const form = document.getElementById('timeline-event-form');
                form.reset();
                
                document.getElementById('timeline-event-modal-title').textContent = eventId ? 'Edit Timeline Event' : 'Create New Timeline Event';
                document.getElementById('timeline-event-id').value = eventId || '';
                document.getElementById('timeline-event-image-preview').src = GLOBAL_FALLBACK_IMAGE;
                document.getElementById('timeline-event-image-path-hidden').value = '';

                if (eventId) {
                    const event = allTimelineEvents.find(e => e.timelineEventId === eventId);
                    if (event) {
                        document.getElementById('timeline-event-title').value = event.title;
                        document.getElementById('timeline-event-description').value = event.description;
                        document.getElementById('timeline-event-date').value = new Date(event.date).toISOString().split('T')[0];
                        document.getElementById('timeline-event-image-path-hidden').value = event.imagePath;
                        document.getElementById('timeline-event-image-preview').src = event.imagePath || GLOBAL_FALLBACK_IMAGE;
                    }
                }
                showModal(timelineEventModal);
            }

            function openRatingModal(jobId, workerUsername) {
                const job = allJobs.find(j => j.jobId === jobId);
                const worker = allProfiles.find(p => p.username === workerUsername);

                if (!job || !worker) {
                    showToast('Error: Job or worker not found.', 'error');
                    return;
                }

                document.getElementById('rating-job-id').value = jobId;
                document.getElementById('rating-worker-username').value = workerUsername;
                document.getElementById('rating-modal-worker-name').textContent = worker.fullName;
                document.getElementById('rating-modal-job-title').textContent = job.title;

                // Reset stars
                const stars = document.querySelectorAll('#rating-modal .stars-input i');
                stars.forEach(star => {
                    star.classList.remove('fas', 'selected');
                    star.classList.add('far');
                });
                document.getElementById('rating-comment').value = '';

                showModal(ratingModal);
            }

            function rerenderCurrentPage() {
                const activePage = document.querySelector('.page-content.active-page');
                if (!activePage) return;

                // Always update stats and notifications regardless of page
                renderStatsSection();
                if (currentUser) {
                    renderNotifications();
                    renderChatNotifications();
                    updateUnreadNotificationBadge();
                    updateUnreadBadge('message');
                    updateUnreadBadge('request');
                }

                // Re-render the content of the currently active page
                switch (activePage.id) {
                    case 'home-page':
                        renderHomePage();
                        break;
                    case 'jobs-page':
                        renderJobsPage(
                            document.getElementById('search-jobs-input').value,
                            document.getElementById('job-type-filter').value,
                            document.getElementById('category-jobs-filter').value,
                            '' // Specific job filter is not stored globally, it's a one-off action
                        );
                        break;
                    case 'people-page':
                        renderPeoplePage(
                            document.getElementById('search-people-input').value,
                            document.querySelector('#people-type-filter-buttons .active')?.dataset.filter || 'all',
                            document.getElementById('worker-category-filter-input').value,
                            document.getElementById('talent-category-filter-input').value,
                             '' // Specific skill filter is not stored globally
                        );
                        break;
                    case 'employers-page':
                         renderEmployersPage(
                            document.getElementById('search-employers-input').value,
                            document.getElementById('employer-type-filter').value
                        );
                        break;
                    case 'zone-page':
                        renderAgenciesPage(
                            document.getElementById('search-agencies-input').value,
                            document.getElementById('type-agencies-filter').value
                        );
                        break;
                    case 'dashboard-page':
                        if (currentUser) {
                            renderDashboardPage();
                        }
                        break;
                    case 'agency-detail-page':
                        if (currentDetailView.type === 'agency' && currentDetailView.id) {
                            renderAgencyDetailPage(currentDetailView.id, true);
                        }
                        break;
                    case 'profile-detail-page':
                        if (currentDetailView.type === 'profile' && currentDetailView.id) {
                            openProfileDetailPage(currentDetailView.id, true);
                        }
                        break;
                    case 'about-page':
                        // The about page content is handled by a separate socket event
                        // but we can call its render function just in case
                        renderAboutPage();
                        break;
                }
            }
            
            function initializeApp() {
                updateNavUI();
                setupGlobalEventListeners();
                
                renderHomePage();
                renderJobsPage();
                renderPeoplePage();
                renderEmployersPage(); // Ensure employers render on startup
                renderAgenciesPage();
                renderDashboardPage();
                renderStatsSection();

                if (currentUser) {
                    initializeSocketIO();
                    setupNotificationUI();
                    setupChatNotificationUI();
                    populateChatContacts();
                    renderChatNotifications();
                }
                
                const dashboardNav = document.querySelector('.dashboard-nav');
                if (dashboardNav) {
                    dashboardNav.addEventListener('click', (e) => {
                        const button = e.target.closest('button[data-panel="requests-panel"]');
                        if (button) {
                            unreadRequestCount = 0;
                            updateUnreadBadge('request');
                        }
                    });
                }
            
                setupFilters();
                bindActionButtons();
                setupPasswordToggles();
                setupChatUI();
                initCarousels();

                // --- NEW: RATING MODAL STAR LOGIC ---
                const starsInputContainer = document.querySelector('#rating-modal .stars-input');
                if (starsInputContainer) {
                    starsInputContainer.addEventListener('mouseover', e => {
                        if (e.target.tagName === 'I') {
                            const hoverValue = e.target.dataset.value;
                            const stars = starsInputContainer.querySelectorAll('i');
                            stars.forEach(star => {
                                if (star.dataset.value <= hoverValue) {
                                    star.classList.add('fas');
                                    star.classList.remove('far');
                                } else {
                                    star.classList.add('far');
                                    star.classList.remove('fas');
                                }
                            });
                        }
                    });

                    starsInputContainer.addEventListener('mouseout', () => {
                        const selectedStar = starsInputContainer.querySelector('i.selected');
                        const selectedValue = selectedStar ? selectedStar.dataset.value : 0;
                        const stars = starsInputContainer.querySelectorAll('i');
                        stars.forEach(star => {
                             if (star.dataset.value <= selectedValue) {
                                star.classList.add('fas');
                                star.classList.remove('far');
                            } else {
                                star.classList.add('far');
                                star.classList.remove('fas');
                            }
                        });
                    });

                    starsInputContainer.addEventListener('click', e => {
                         if (e.target.tagName === 'I') {
                             const value = e.target.dataset.value;
                             const stars = starsInputContainer.querySelectorAll('i');
                             stars.forEach(star => star.classList.remove('selected'));
                             e.target.classList.add('selected');
                         }
                    });
                }
                
                const hash = window.location.hash.substring(1);
                let startPage = 'home-page';
                let startState = {};
                
                if (hash) {
                    const [pagePart, queryPart] = hash.split('?');
                    const params = new URLSearchParams(queryPart);
                    
                    if (pagePart === 'verify' && params.has('token')) {
                        const token = params.get('token');
                        // Don't hide preloader yet. verifyAccount will handle it.
                        isInitialLoad = false; // Prevent default page load
                        verifyAccount(token);
                        startPage = null; 
                    }
                    else if (pagePart === 'profile-detail-page' && params.has('username')) {
                        const username = params.get('username');
                        openProfileDetailPage(username, true); 
                        startPage = null;
                    } else if (pagePart === 'agency-detail-page' && params.has('id')) {
                        const agencyId = params.get('id');
                        renderAgencyDetailPage(agencyId, true);
                        startPage = null;
                    } else if (pagePart === 'job-details' && params.has('id')) {
                        const jobId = params.get('id');
                        startPage = 'jobs-page';
                        setTimeout(() => openApplyModal(jobId), 100);
                    }
                    else if (document.getElementById(pagePart)) {
                        startPage = pagePart;
                        startState = { stateParams: Object.fromEntries(params.entries()) };
                    }
                } else {
                    const lastStateStr = localStorage.getItem('jkit_lastActiveState');
                    const protectedPages = ['dashboard-page'];
                    try {
                        const lastState = lastStateStr ? JSON.parse(lastStateStr) : null;
                        if (currentUser) {
                            startPage = lastState ? lastState.page : 'dashboard-page';
                            startState = lastState ? { stateParams: lastState.params } : {};
                        } else {
                            if (lastState && !protectedPages.includes(lastState.page)) {
                                startPage = lastState.page;
                                startState = { stateParams: lastState.params };
                            } else {
                                startPage = 'home-page';
                            }
                        }
                    } catch(e) { 
                        startPage = 'home-page'; 
                    }
                }

                if (startPage) {
                    window.showPage(startPage, startState, true);
                }
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('verified') && urlParams.get('verified') === 'true') {
                    showToast('Verification successful! You can now log in.', 'success', 5000);
                    history.replaceState(null, '', window.location.pathname + window.location.hash);
                    showModal(loginModal);
                }

                // Hide preloader only if not in verification flow
                if (startPage) {
                    setTimeout(() => {
                        document.getElementById('preloader').classList.add('loaded');
                    }, 500);
                }
            }
            
            initializeApp();
        });
    </script>
</body>
</html>